üõí –°–ü–†–ò–ù–¢ 2: RECEIPT ITEMS
–ó–ê–î–ê–ß–ê 2.1: REPOSITORY (30 –º–∏–Ω—É—Ç)
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è receipt_items

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/repositories/receipt-items.repository.ts

–ö–û–î:
import { BaseRepository } from './base.repository';
import { db } from '../db';
import { receiptItems, type InsertReceiptItem, type ReceiptItem } from '@shared/schema';
import { eq, and } from 'drizzle-orm';

/**
 * Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ —á–µ–∫–æ–≤
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
 */
export class ReceiptItemsRepository extends BaseRepository
  typeof receiptItems,
  ReceiptItem,
  InsertReceiptItem,
  Partial<InsertReceiptItem>
> {
  protected getTable() {
    return receiptItems;
  }
  
  protected getRepositoryName() {
    return 'ReceiptItemsRepository';
  }
  
  /**
   * –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —Ä–∞–∑
   */
  async createBulk(items: InsertReceiptItem[]) {
    return await this.db
      .insert(receiptItems)
      .values(items)
      .returning();
  }
  
  /**
   * –ù–∞–π—Ç–∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   */
  async findByTransaction(transactionId: number) {
    return await this.findMany({
      where: eq(receiptItems.transactionId, transactionId)
    });
  }
  
  /**
   * –ù–∞–π—Ç–∏ –≤—Å–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ—Ö–æ–∂–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
   * (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –º–µ–∂–¥—É –º–∞–≥–∞–∑–∏–Ω–∞–º–∏)
   */
  async findSimilarItems(normalizedName: string, userId: number) {
    const items = await this.db
      .select()
      .from(receiptItems)
      .innerJoin(
        dailyTransactions,
        eq(receiptItems.transactionId, dailyTransactions.id)
      )
      .where(
        and(
          eq(receiptItems.normalizedName, normalizedName),
          eq(dailyTransactions.userId, userId)
        )
      );
    
    return items.map(item => item.receipt_items);
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç singleton
export const receiptItemsRepository = new ReceiptItemsRepository(db);

–†–ê–ó–ú–ï–†: ~90 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ server/repositories/receipt-items.repository.ts (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ Extends BaseRepository (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω)
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ–º –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã