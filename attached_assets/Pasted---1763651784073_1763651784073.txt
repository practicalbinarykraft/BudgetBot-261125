üé§ –ü–†–û–ë–õ–ï–ú–ê: –î–û–°–õ–û–í–ù–ê–Ø –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Øüîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´–ß–¢–û –°–ï–ô–ß–ê–°:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç: 
"–ö—É–ø–∏–ª –∫–æ—Ñ–µ –≤ –°—Ç–∞—Ä–±–∞–∫—Å–µ, 150 —Ç—ã—Å—è—á —Ä—É–ø–∏–π –∏–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∏—Ö"

Whisper —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –¥–æ—Å–ª–æ–≤–Ω–æ: ‚úÖ
"–ö—É–ø–∏–ª –∫–æ—Ñ–µ –≤ –°—Ç–∞—Ä–±–∞–∫—Å–µ, 150 —Ç—ã—Å—è—á —Ä—É–ø–∏–π –∏–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∏—Ö"

–ë–æ—Ç –ø–∞—Ä—Å–∏—Ç –∫–∞–∫ –µ—Å—Ç—å: ‚ùå
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ö—É–ø–∏–ª –∫–æ—Ñ–µ –≤ —Å—Ç–∞—Ä–±–∞–∫—Å–µ, —Ç—ã—Å—è—á —Ä—É–ø–∏–π –∏–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∏—Ö"
- –°—É–º–º–∞: $150.00 (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!)
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ü—Ä–æ–¥—É–∫—Ç—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

–ß–¢–û –î–û–õ–ñ–ù–û –ë–´–¢–¨:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç:
"–ö—É–ø–∏–ª –∫–æ—Ñ–µ –≤ –°—Ç–∞—Ä–±–∞–∫—Å–µ, 150 —Ç—ã—Å—è—á —Ä—É–ø–∏–π –∏–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∏—Ö"

AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–º–Ω–µ–µ: ‚úÖ
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ö–æ—Ñ–µ –≤ Starbucks"
- –°—É–º–º–∞: 150,000 IDR ($9.38 USD)
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã
- –ú–∞–≥–∞–∑–∏–Ω: Starbucksüí° –†–ï–®–ï–ù–ò–ï: AI POST-PROCESSING–ü–û–î–•–û–î: CLAUDE –ù–û–†–ú–ê–õ–ò–ó–£–ï–¢ –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ÆFLOW:
1. Whisper —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –≥–æ–ª–æ—Å ‚Üí —Ç–µ–∫—Å—Ç (–∫–∞–∫ –µ—Å—Ç—å)
2. Claude –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç
3. –°–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:
‚úÖ –ü–æ–Ω–∏–º–∞–µ—Ç "150 —Ç—ã—Å—è—á" = 150,000
‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –≤–∞–ª—é—Ç—É ("—Ä—É–ø–∏–π" = IDR)
‚úÖ –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–∞–≥–∞–∑–∏–Ω ("–°—Ç–∞—Ä–±–∞–∫—Å" = Starbucks)
‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–∫–æ—Ñ–µ = –ö–∞—Ñ–µ, –Ω–µ –ü—Ä–æ–¥—É–∫—Ç—ã)
‚úÖ –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞üìã –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø (2 –®–ê–ì–ê)–®–ê–ì 1: –°–û–ó–î–ê–¢–¨ AI NORMALIZER SERVICE (20 –º–∏–Ω—É—Ç)typescript‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–°–û–ó–î–ê–¢–¨ –§–ê–ô–õ: server/services/voice-transaction-normalizer.service.ts
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

import Anthropic from '@anthropic-ai/sdk';

interface NormalizedTransaction {
  amount: number;
  currency: 'USD' | 'RUB' | 'IDR';
  description: string;
  category?: string;
  merchantName?: string;
  type: 'income' | 'expense';
  confidence: 'high' | 'medium' | 'low';
}

export class VoiceTransactionNormalizer {
  
  // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  async normalize(params: {
    transcribedText: string;
    userRegion?: string; // 'russia', 'indonesia-bali', etc
    anthropicApiKey: string;
  }): Promise<NormalizedTransaction> {
    
    const { transcribedText, userRegion, anthropicApiKey } = params;
    
    const anthropic = new Anthropic({
      apiKey: anthropicApiKey
    });
    
    // –ü—Ä–æ–º–ø—Ç –¥–ª—è Claude
    const prompt = `–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–∏—Å–∞–ª –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–≤–æ–∏—Ö —Ç—Ä–∞—Ç–∞—Ö –∏–ª–∏ –¥–æ—Ö–æ–¥–∞—Ö.

–†–ï–ì–ò–û–ù –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${userRegion || 'unknown'}

–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø –ì–û–õ–û–°–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø:
"${transcribedText}"

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ò–∑–≤–ª–µ—á—å –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.

–ü–†–ê–í–ò–õ–ê:
1. –°–£–ú–ú–ê:
   - "150 —Ç—ã—Å—è—á" = 150000
   - "–ø–æ–ª—Ç–æ—Ä–∞ –º–∏–ª–ª–∏–æ–Ω–∞" = 1500000
   - "–ø—è—Ç—å—Å–æ—Ç" = 500
   - "—Ç—ã—â–∞" = 1000
   - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π —Å–ª–æ–≤–∞–º–∏ –≤ —á–∏—Å–ª–∞

2. –í–ê–õ–Æ–¢–ê:
   - "—Ä—É–±–ª–µ–π" / "—Ä—É–±–ª—è" / "—Ä—É–±" = RUB
   - "—Ä—É–ø–∏–π" / "—Ä—É–ø–∏–∏" / "–∏–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∏—Ö" = IDR
   - "–¥–æ–ª–ª–∞—Ä–æ–≤" / "–±–∞–∫—Å–æ–≤" / "usd" = USD
   - –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, —É–≥–∞–¥–∞–π –ø–æ —Ä–µ–≥–∏–æ–Ω—É:
     * russia ‚Üí RUB
     * indonesia ‚Üí IDR
     * default ‚Üí USD

3. –û–ü–ò–°–ê–ù–ò–ï:
   - –°–¥–µ–ª–∞–π –∫–æ—Ä–æ—Ç–∫–∏–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º
   - –£–±–µ—Ä–∏ –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "–∫—É–ø–∏–ª", "–ø–æ—Ç—Ä–∞—Ç–∏–ª", "–∑–∞–ø–ª–∞—Ç–∏–ª"
   - "–ö—É–ø–∏–ª –∫–æ—Ñ–µ –≤ –°—Ç–∞—Ä–±–∞–∫—Å–µ" ‚Üí "–ö–æ—Ñ–µ Starbucks"
   - "–ó–∞–ø—Ä–∞–≤–∏–ª—Å—è –Ω–∞ –±–µ–Ω–∑–∏–Ω" ‚Üí "–ë–µ–Ω–∑–∏–Ω"
   - –ò—Å–ø—Ä–∞–≤—å –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ

4. –ö–ê–¢–ï–ì–û–†–ò–Ø:
   - –û–ø—Ä–µ–¥–µ–ª–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - –í–∞—Ä–∏–∞–Ω—Ç—ã: –ü—Ä–æ–¥—É–∫—Ç—ã, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, –ó–¥–æ—Ä–æ–≤—å–µ, –û–¥–µ–∂–¥–∞, –î–æ–º, –ü—Ä–æ—á–µ–µ

5. –ú–ê–ì–ê–ó–ò–ù (–µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç):
   - "–°—Ç–∞—Ä–±–∞–∫—Å" ‚Üí "Starbucks"
   - "–ü—è—Ç—ë—Ä–æ—á–∫–∞" ‚Üí "–ü—è—Ç—ë—Ä–æ—á–∫–∞"
   - "–ò–Ω–¥–æ–º–∞—Ä–µ—Ç" ‚Üí "Indomaret"

6. –¢–ò–ü:
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é expense (—Ä–∞—Å—Ö–æ–¥)
   - –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã —Å–ª–æ–≤–∞ "–ø–æ–ª—É—á–∏–ª", "–∑–∞—Ä–ø–ª–∞—Ç–∞", "–¥–æ—Ö–æ–¥" ‚Üí income

–û–¢–í–ï–¢ –í–ï–†–ù–ò –°–¢–†–û–ì–û –í JSON:
{
  "amount": 150000,
  "currency": "IDR",
  "description": "–ö–æ—Ñ–µ Starbucks",
  "category": "–ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã",
  "merchantName": "Starbucks",
  "type": "expense",
  "confidence": "high"
}

CONFIDENCE:
- high: –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞
- medium: –ø—Ä–∏—à–ª–æ—Å—å —É–≥–∞–¥—ã–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é/–≤–∞–ª—é—Ç—É
- low: —Ç–µ–∫—Å—Ç –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ`;

    try {
      const message = await anthropic.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        messages: [{
          role: 'user',
          content: prompt
        }]
      });
      
      const responseText = message.content[0].type === 'text' 
        ? message.content[0].text 
        : '';
      
      // –ò–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('Claude did not return valid JSON');
      }
      
      const normalized: NormalizedTransaction = JSON.parse(jsonMatch[0]);
      
      console.log('‚úÖ Voice transaction normalized:', normalized);
      
      return normalized;
      
    } catch (error) {
      console.error('‚ùå Voice normalization failed:', error);
      
      // Fallback: –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥
      return this.fallbackParse(transcribedText);
    }
  }
  
  // Fallback –µ—Å–ª–∏ Claude –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
  private fallbackParse(text: string): NormalizedTransaction {
    // –ü—Ä–æ—Å—Ç–æ–π regex –ø–∞—Ä—Å–∏–Ω–≥ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
    const amountMatch = text.match(/(\d+[\s,]?\d*)/);
    const amount = amountMatch ? parseFloat(amountMatch[1].replace(/[\s,]/g, '')) : 0;
    
    const currency = text.includes('—Ä—É–ø–∏') ? 'IDR' 
                   : text.includes('—Ä—É–±–ª') ? 'RUB' 
                   : 'USD';
    
    return {
      amount,
      currency,
      description: text.slice(0, 100),
      type: 'expense',
      confidence: 'low'
    };
  }
}

export const voiceTransactionNormalizer = new VoiceTransactionNormalizer();

–°–¢–†–û–ö: ~180 ‚úÖ