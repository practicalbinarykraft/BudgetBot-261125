ğŸ“‹ Ğ¨ĞĞ“ 3: PRICE HISTORY REPOSITORY (15 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ—ĞĞ”ĞĞ§Ğ 3.1: Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ REPOSITORY Ğ”Ğ›Ğ¯ PRICE HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ Ğ¤ĞĞ™Ğ›: server/repositories/product-price-history.repository.ts

Ğ¡ĞĞ”Ğ•Ğ Ğ–Ğ˜ĞœĞĞ•:

import { eq, and, desc } from 'drizzle-orm';
import { db } from '../db';
import { 
  productPriceHistory, 
  type InsertProductPriceHistory, 
  type ProductPriceHistory 
} from '@shared/schema';

class ProductPriceHistoryRepository {
  // ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ²ÑĞµ Ñ†ĞµĞ½Ñ‹ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
  async findByProduct(productId: number): Promise<ProductPriceHistory[]> {
    return await db
      .select()
      .from(productPriceHistory)
      .where(eq(productPriceHistory.productId, productId))
      .orderBy(desc(productPriceHistory.purchaseDate));
  }

  // ĞĞ°Ğ¹Ñ‚Ğ¸ Ñ†ĞµĞ½Ñ‹ Ğ¿Ğ¾ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ñƒ
  async findByStore(productId: number, storeName: string): Promise<ProductPriceHistory[]> {
    return await db
      .select()
      .from(productPriceHistory)
      .where(
        and(
          eq(productPriceHistory.productId, productId),
          eq(productPriceHistory.storeName, storeName)
        )
      )
      .orderBy(desc(productPriceHistory.purchaseDate));
  }

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ
  async create(data: InsertProductPriceHistory): Promise<ProductPriceHistory> {
    const results = await db
      .insert(productPriceHistory)
      .values(data)
      .returning();
    
    return results[0];
  }

  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ»ÑƒÑ‡ÑˆÑƒÑ Ñ†ĞµĞ½Ñƒ (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ)
  async getBestPrice(productId: number): Promise<ProductPriceHistory | null> {
    const results = await db
      .select()
      .from(productPriceHistory)
      .where(eq(productPriceHistory.productId, productId))
      .orderBy(productPriceHistory.price) // ASC - Ğ¾Ñ‚ Ğ¼ĞµĞ½ÑŒÑˆĞµĞ³Ğ¾ Ğº Ğ±Ğ¾Ğ»ÑŒÑˆĞµĞ¼Ñƒ
      .limit(1);
    
    return results[0] || null;
  }

  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ€ĞµĞ´Ğ½ÑÑ Ñ†ĞµĞ½Ñƒ
  async getAveragePrice(productId: number): Promise<number> {
    const prices = await this.findByProduct(productId);
    
    if (prices.length === 0) return 0;
    
    const sum = prices.reduce((acc, p) => acc + parseFloat(p.price), 0);
    return sum / prices.length;
  }

  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ñ†ĞµĞ½Ñƒ
  async getLatestPrice(productId: number): Promise<ProductPriceHistory | null> {
    const results = await db
      .select()
      .from(productPriceHistory)
      .where(eq(productPriceHistory.productId, productId))
      .orderBy(desc(productPriceHistory.purchaseDate))
      .limit(1);
    
    return results[0] || null;
  }
}

export const productPriceHistoryRepository = new ProductPriceHistoryRepository();

ĞĞ–Ğ˜Ğ”ĞĞ•ĞœĞ«Ğ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢:
âœ… Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ Ñ†ĞµĞ½
âœ… Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ»ÑƒÑ‡ÑˆĞµĞ¹/ÑÑ€ĞµĞ´Ğ½ĞµĞ¹ Ñ†ĞµĞ½Ñ‹
âœ… Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°Ğ¼