üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô (–ü–û–õ–ù–´–ô)

üéØ –î–í–ï –ü–†–û–ë–õ–ï–ú–´
–ü–†–û–ë–õ–ï–ú–ê 1: AI –ü–†–û–ì–ù–û–ó –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô
‚îî‚îÄ –¢—Ä–∞—Ç—è—Ç—Å—è –¥–µ–Ω—å–≥–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º refresh
‚îî‚îÄ –ù–µ—Ç opt-in
‚îî‚îÄ –ù–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–†–û–ë–õ–ï–ú–ê 2: –†–ê–ó–û–ë–†–ê–¢–¨–°–Ø –í –ê–†–•–ò–¢–ï–ö–¢–£–†–ï
‚îî‚îÄ –ß—Ç–æ —Ç–∞–∫–æ–µ –ª–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑?
‚îî‚îÄ –ß—Ç–æ —Ç–∞–∫–æ–µ AI –ø—Ä–æ–≥–Ω–æ–∑?
‚îî‚îÄ –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞?
‚îî‚îÄ –ö–∞–∫ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ?

üìä –û–ë–™–Ø–°–ù–ï–ù–ò–ï: –õ–ò–ù–ï–ô–ù–´–ô VS AI –ü–†–û–ì–ù–û–ó
–õ–ò–ù–ï–ô–ù–´–ô –ü–†–û–ì–ù–û–ó (–°–ï–ô–ß–ê–°)
–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:

1. –ë–µ—Ä—ë–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞ 90 –¥–Ω–µ–π:
   ‚îú‚îÄ –î–æ—Ö–æ–¥—ã: $100 + $120 + $110 + ... (90 –¥–Ω–µ–π)
   ‚îú‚îÄ –†–∞—Å—Ö–æ–¥—ã: $50 + $60 + $55 + ... (90 –¥–Ω–µ–π)
   ‚îî‚îÄ –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ: avgIncome = $110/–¥–µ–Ω—å, avgExpense = $55/–¥–µ–Ω—å

2. –≠–∫—Å—Ç—Ä–∞–ø–æ–ª–∏—Ä—É–µ–º –≤ –±—É–¥—É—â–µ–µ:
   ‚îú‚îÄ –î–µ–Ω—å 1: –¥–æ—Ö–æ–¥ $110, —Ä–∞—Å—Ö–æ–¥ $55, –∫–∞–ø–∏—Ç–∞–ª +$55
   ‚îú‚îÄ –î–µ–Ω—å 2: –¥–æ—Ö–æ–¥ $110, —Ä–∞—Å—Ö–æ–¥ $55, –∫–∞–ø–∏—Ç–∞–ª +$55
   ‚îú‚îÄ –î–µ–Ω—å 3: –¥–æ—Ö–æ–¥ $110, —Ä–∞—Å—Ö–æ–¥ $55, –∫–∞–ø–∏—Ç–∞–ª +$55
   ‚îî‚îÄ ... —Ç–∞–∫ 365 –¥–Ω–µ–π

3. –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:
   ‚îú‚îÄ Recurring (–∑–∞—Ä–ø–ª–∞—Ç–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü 1-–≥–æ —á–∏—Å–ª–∞ ‚Üí +$2000)
   ‚îú‚îÄ Planned Income (–æ–ø–ª–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ 22 –Ω–æ—è–±—Ä—è ‚Üí +$1000)
   ‚îú‚îÄ Planned Expenses (MacBook 5 –¥–µ–∫–∞–±—Ä—è ‚Üí -$2500)
   ‚îî‚îÄ Budget Limits (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Üí -$60/–¥–µ–Ω—å)

–†–ï–ó–£–õ–¨–¢–ê–¢:
–ü—Ä—è–º–∞—è –ª–∏–Ω–∏—è —Å "–≤—Å–ø–ª–µ—Å–∫–∞–º–∏" –Ω–∞ –¥–∞—Ç—ã —Å–æ–±—ã—Ç–∏–π

–ü–õ–Æ–°–´:
‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ
‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ

–ú–ò–ù–£–°–´:
‚ùå –ù–µ –≤–∏–¥–∏—Ç —Ç—Ä–µ–Ω–¥—ã ("—Ä–∞—Å—Ö–æ–¥—ã —Ä–∞—Å—Ç—É—Ç –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü")
‚ùå –ù–µ –≤–∏–¥–∏—Ç —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å ("–∑–∏–º–æ–π –±–æ–ª—å—à–µ —Ç—Ä–∞—Ç–∏—Ç–µ")
‚ùå –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã ("–ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º –±–æ–ª—å—à–µ —Ç—Ä–∞—Ç–∏—Ç–µ")
‚ùå –¢—É–ø–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (—Å—Ä–µ–¥–Ω–µ–µ √ó –¥–Ω–∏)

–ü–†–ò–ú–ï–†:
–ò—Å—Ç–æ—Ä–∏—è:
‚îú‚îÄ –ú–µ—Å—è—Ü 1: –¥–æ—Ö–æ–¥ $3000, —Ä–∞—Å—Ö–æ–¥ $2000
‚îú‚îÄ –ú–µ—Å—è—Ü 2: –¥–æ—Ö–æ–¥ $3500, —Ä–∞—Å—Ö–æ–¥ $2300
‚îî‚îÄ –ú–µ—Å—è—Ü 3: –¥–æ—Ö–æ–¥ $4000, —Ä–∞—Å—Ö–æ–¥ $2800

–õ–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑:
‚îî‚îÄ –°—Ä–µ–¥–Ω–µ–µ: $3500 –¥–æ—Ö–æ–¥, $2366 —Ä–∞—Å—Ö–æ–¥
‚îî‚îÄ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü 4: $3500 –¥–æ—Ö–æ–¥, $2366 —Ä–∞—Å—Ö–æ–¥

–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:
‚îî‚îÄ –ú–µ—Å—è—Ü 4: –¥–æ—Ö–æ–¥ $4500, —Ä–∞—Å—Ö–æ–¥ $3200 (—Ç—Ä–µ–Ω–¥ —Ä–æ—Å—Ç–∞!)

AI –ü–†–û–ì–ù–û–ó (–°–ï–ô–ß–ê–°, –ù–û –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô)
–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:

1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Claude –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é:
   ‚îú‚îÄ 90 –¥–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–¥–∞—Ç–∞, —Å—É–º–º–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ)
   ‚îú‚îÄ Recurring —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   ‚îú‚îÄ Planned income/expenses
   ‚îî‚îÄ Budget limits

2. Prompt –¥–ª—è Claude:
   "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –ò—Å—Ç–æ—Ä–∏—è: [90 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö]
    
    –ù–∞–π–¥–∏:
    - –¢—Ä–µ–Ω–¥—ã (—Ä–∞—Å—Ç—É—Ç –ª–∏ —Ä–∞—Å—Ö–æ–¥—ã?)
    - –ü–∞—Ç—Ç–µ—Ä–Ω—ã (–±–æ–ª—å—à–µ —Ç—Ä–∞—Ç–∏—Ç –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º?)
    - –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å (–∑–∏–º–æ–π –±–æ–ª—å—à–µ?)
    - –ê–Ω–æ–º–∞–ª–∏–∏
    
    –ü—Ä–µ–¥—Å–∫–∞–∂–∏ –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ 365 –¥–Ω–µ–π."

3. Claude –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
   {
     "dailyIncome": [110, 112, 115, ...], // 365 –∑–Ω–∞—á–µ–Ω–∏–π
     "dailyExpense": [55, 58, 60, ...],   // —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–¥–æ–≤
     "insights": "–†–∞—Å—Ö–æ–¥—ã —Ä–∞—Å—Ç—É—Ç –Ω–∞ 3% –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü"
   }

4. –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –∏–∑ —ç—Ç–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π

–†–ï–ó–£–õ–¨–¢–ê–¢:
–ü–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

–ü–õ–Æ–°–´:
‚úÖ –£–º–Ω—ã–π (–≤–∏–¥–∏—Ç —Ç—Ä–µ–Ω–¥—ã)
‚úÖ –¢–æ—á–Ω—ã–π (—É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π (–ø–æ–Ω–∏–º–∞–µ—Ç —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å)

–ú–ò–ù–£–°–´:
‚ùå –ú–µ–¥–ª–µ–Ω–Ω–æ (10-30 —Å–µ–∫—É–Ω–¥)
‚ùå –î–æ—Ä–æ–≥–æ (~$0.20 –∑–∞ –∑–∞–ø—Ä–æ—Å)
‚ùå –¢—Ä–µ–±—É–µ—Ç API –∫–ª—é—á
‚ùå –ú–æ–∂–µ—Ç —Ç–∞–π–º–∞—É—Ç–∏—Ç—å

–ü–†–ò–ú–ï–†:
–ò—Å—Ç–æ—Ä–∏—è (—Ç–∞ –∂–µ):
‚îú‚îÄ –ú–µ—Å—è—Ü 1: –¥–æ—Ö–æ–¥ $3000, —Ä–∞—Å—Ö–æ–¥ $2000
‚îú‚îÄ –ú–µ—Å—è—Ü 2: –¥–æ—Ö–æ–¥ $3500, —Ä–∞—Å—Ö–æ–¥ $2300
‚îî‚îÄ –ú–µ—Å—è—Ü 3: –¥–æ—Ö–æ–¥ $4000, —Ä–∞—Å—Ö–æ–¥ $2800

AI –≤–∏–¥–∏—Ç —Ç—Ä–µ–Ω–¥ —Ä–æ—Å—Ç–∞:
‚îî‚îÄ –î–æ—Ö–æ–¥ —Ä–∞—Å—Ç—ë—Ç –Ω–∞ ~$500/–º–µ—Å—è—Ü (+16%)
‚îî‚îÄ –†–∞—Å—Ö–æ–¥ —Ä–∞—Å—Ç—ë—Ç –Ω–∞ ~$400/–º–µ—Å—è—Ü (+20%)

AI –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü 4:
‚îî‚îÄ –î–æ—Ö–æ–¥: $4500 (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞)
‚îî‚îÄ –†–∞—Å—Ö–æ–¥: $3200 (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞)

–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:
‚îî‚îÄ –ú–µ—Å—è—Ü 4: –¥–æ—Ö–æ–¥ $4500, —Ä–∞—Å—Ö–æ–¥ $3200
‚îî‚îÄ AI –£–ì–ê–î–ê–õ! ‚úÖ

üîÑ –ö–ê–ö –û–ù–ò –†–ê–ë–û–¢–ê–Æ–¢ –í–ú–ï–°–¢–ï (–°–ï–ô–ß–ê–°)
–¢–ï–ö–£–©–ò–ô FLOW:

1. User –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Dashboard
2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç CapitalGrowthChart –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
3. useQuery –≤—ã–∑—ã–≤–∞–µ—Ç GET /api/analytics/trend
4. Backend:
   ‚îú‚îÄ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –µ—Å—Ç—å –ª–∏ anthropicApiKey?
   ‚îú‚îÄ –ï—Å–ª–∏ –î–ê:
   ‚îÇ  ‚îú‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç Claude API (–ø–ª–∞—Ç–Ω–æ!)
   ‚îÇ  ‚îú‚îÄ –ñ–¥—ë—Ç –æ—Ç–≤–µ—Ç (10-30 —Å–µ–∫)
   ‚îÇ  ‚îú‚îÄ –ï—Å–ª–∏ timeout ‚Üí fallback –Ω–∞ –ª–∏–Ω–µ–π–Ω—ã–π (–Ω–æ –¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å!)
   ‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ —É—Å–ø–µ—Ö ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç AI –ø—Ä–æ–≥–Ω–æ–∑
   ‚îî‚îÄ –ï—Å–ª–∏ –ù–ï–¢:
      ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑

5. Frontend —Ä–∏—Å—É–µ—Ç –≥—Ä–∞—Ñ–∏–∫

–ü–†–û–ë–õ–ï–ú–ê:
‚ùå AI –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á
‚ùå –ö–∞–∂–¥—ã–π refresh = –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
‚ùå –ù–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
‚ùå –ù–µ—Ç opt-in
‚ùå User –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ –ø–ª–∞—Ç–∏—Ç

üéØ –†–ï–®–ï–ù–ò–ï: OPT-IN AI + –ö–ï–®–ò–†–û–í–ê–ù–ò–ï
–ù–û–í–´–ô FLOW:
1. User –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Dashboard
2. –ì—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –° –õ–ò–ù–ï–ô–ù–´–ú –ø—Ä–æ–≥–Ω–æ–∑–æ–º (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
3. User –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É: "ü§ñ –ü–æ–∫–∞–∑–∞—Ç—å AI –ø—Ä–æ–≥–Ω–æ–∑"
4. User –∫–ª–∏–∫–∞–µ—Ç ‚Üí Warning modal:
   "AI –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ç–æ–∏—Ç ~$0.20. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"
5. User –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí useQuery —Å useAI=true
6. Backend:
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–µ—à (–µ—Å—Ç—å –ª–∏ —Å–≤–µ–∂–∏–π AI –ø—Ä–æ–≥–Ω–æ–∑?)
   ‚îú‚îÄ –ï—Å–ª–∏ –î–ê: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑ –∫–µ—à–∞ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ!)
   ‚îî‚îÄ –ï—Å–ª–∏ –ù–ï–¢:
      ‚îú‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç Claude API (–ø–ª–∞—Ç–Ω–æ)
      ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫–µ—à –Ω–∞ 12 —á–∞—Å–æ–≤
      ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
7. Frontend –æ–±–Ω–æ–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫ —Å AI –ø—Ä–æ–≥–Ω–æ–∑–æ–º
8. User –≤–∏–¥–∏—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: "ü§ñ AI –ø—Ä–æ–≥–Ω–æ–∑ –∞–∫—Ç–∏–≤–µ–Ω (–∫–µ—à –¥–æ 18:00)"

–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:
‚úÖ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ
‚úÖ AI —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É
‚úÖ Warning –ø–µ—Ä–µ–¥ —Ç—Ä–∞—Ç–æ–π
‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã)
‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å—Ö–æ–¥–æ–≤

üìã –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô (–î–ï–¢–ê–õ–¨–ù–´–ô)
–≠–¢–ê–ü 1: BACKEND - OPT-IN AI (30 –º–∏–Ω—É—Ç)
typescript// server/services/trend-calculator.service.ts

import NodeCache from 'node-cache';

// –ö–µ—à –Ω–∞ 12 —á–∞—Å–æ–≤
const aiCache = new NodeCache({ stdTTL: 43200 });

export async function calculateTrend(params: {
  userId: number;
  historyDays: number;
  forecastDays: number;
  useAI?: boolean; // ‚Üê –ù–û–í–´–ô (default: false)
  anthropicApiKey?: string;
}) {
  // 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
  const transactions = await getTransactions(userId, historyDays);
  const recurring = await getRecurringTransactions(userId);
  const plannedIncome = await getPlannedIncome(userId);
  const plannedExpenses = await getPlannedExpenses(userId);
  const budgets = await getBudgets(userId);
  
  // 2. –õ–ò–ù–ï–ô–ù–´–ô –ø—Ä–æ–≥–Ω–æ–∑ (–≤—Å–µ–≥–¥–∞)
  let baseIncome = calculateAverage(
    transactions.filter(t => t.type === 'income')
  );
  let baseExpense = calculateAverage(
    transactions.filter(t => t.type === 'expense')
  );
  
  // 3. AI –ø—Ä–æ–≥–Ω–æ–∑ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ useAI=true)
  if (params.useAI && anthropicApiKey) {
    const cacheKey = `ai-${userId}-${historyDays}-${forecastDays}`;
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à
    let aiPrediction = aiCache.get(cacheKey);
    
    if (!aiPrediction) {
      console.log('AI prediction: calling Claude API (will cost ~$0.20)');
      
      try {
        aiPrediction = await predictWithAI({
          transactions,
          recurring,
          plannedIncome,
          plannedExpenses,
          anthropicApiKey
        });
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à
        aiCache.set(cacheKey, aiPrediction);
        console.log('AI prediction: cached for 12 hours');
      } catch (error) {
        console.error('AI prediction failed, using linear:', error);
        // Fallback –Ω–∞ –ª–∏–Ω–µ–π–Ω—ã–π (–Ω–µ –ø–∞–¥–∞–µ–º!)
      }
    } else {
      console.log('AI prediction: using cached result (free!)');
    }
    
    if (aiPrediction) {
      baseIncome = aiPrediction.income;
      baseExpense = aiPrediction.expense;
    }
  }
  
  // 4. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑
  const forecast = [];
  for (let day = 0; day < forecastDays; day++) {
    const date = addDays(new Date(), day);
    
    // –ë–∞–∑–æ–≤—ã–π —Ç—Ä–µ–Ω–¥
    let income = baseIncome;
    let expense = baseExpense;
    
    // –î–æ–±–∞–≤–∏—Ç—å recurring
    if (includeRecurring) {
      income += getRecurringIncome(recurring, date);
      expense += getRecurringExpense(recurring, date);
    }
    
    // –î–æ–±–∞–≤–∏—Ç—å planned
    if (includePlannedIncome) {
      income += getPlannedIncome(plannedIncome, date);
    }
    if (includePlannedExpenses) {
      expense += getPlannedExpense(plannedExpenses, date);
    }
    
    // –î–æ–±–∞–≤–∏—Ç—å budgets
    if (includeBudgetLimits) {
      expense += getDailyBudgetTotal(budgets, date);
    }
    
    // –ö–∞–ø–∏—Ç–∞–ª
    const capital = (prevCapital || currentCapital) + (income - expense);
    
    forecast.push({ date, income, expense, capital });
  }
  
  return {
    forecast,
    metadata: {
      usedAI: params.useAI && aiPrediction !== null,
      cached: params.useAI ? aiCache.has(cacheKey) : false,
      cacheExpiresAt: params.useAI ? new Date(Date.now() + 43200000) : null
    }
  };
}

–≠–¢–ê–ü 2: BACKEND - ENDPOINT (10 –º–∏–Ω—É—Ç)
typescript// server/routes/analytics.routes.ts

router.get("/trend", withAuth(async (req, res) => {
  const historyDays = parseInt(req.query.historyDays as string) || 30;
  const forecastDays = parseInt(req.query.forecastDays as string) || 365;
  const useAI = req.query.useAI === 'true'; // ‚Üê –ù–û–í–´–ô
  const includeRecurring = req.query.includeRecurring !== 'false';
  const includePlannedIncome = req.query.includePlannedIncome !== 'false';
  const includePlannedExpenses = req.query.includePlannedExpenses !== 'false';
  const includeBudgetLimits = req.query.includeBudgetLimits === 'true';
  
  const settings = await storage.getSettingsByUserId(req.user.id);
  
  const trendData = await calculateTrend({
    userId: req.user.id,
    historyDays,
    forecastDays,
    useAI, // ‚Üê –ü–µ—Ä–µ–¥–∞—ë–º
    includeRecurring,
    includePlannedIncome,
    includePlannedExpenses,
    includeBudgetLimits,
    anthropicApiKey: settings?.anthropicApiKey
  });
  
  res.json(trendData);
}));

–≠–¢–ê–ü 3: FRONTEND - TOGGLE + WARNING (1 —á–∞—Å)
typescript// client/src/components/capital-growth-chart.tsx

export function CapitalGrowthChart() {
  const [useAI, setUseAI] = useState(false); // ‚Üê –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –í–´–ö–õ
  const [showWarning, setShowWarning] = useState(false);
  
  const [filters, setFilters] = useState({
    includeRecurring: true,
    includePlannedIncome: true,
    includePlannedExpenses: true,
    includeBudgetLimits: false
  });
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
  const { data: trendData, isLoading } = useQuery({
    queryKey: ['/api/analytics/trend', {
      historyDays,
      forecastDays,
      useAI, // ‚Üê –í–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ
      ...filters
    }]
  });
  
  const handleToggleAI = () => {
    if (!useAI) {
      // –ü–æ–∫–∞–∑–∞—Ç—å warning
      setShowWarning(true);
    } else {
      // –í—ã–∫–ª—é—á–∏—Ç—å –±–µ–∑ warning
      setUseAI(false);
    }
  };
  
  const handleConfirmAI = () => {
    setShowWarning(false);
    setUseAI(true);
  };
  
  // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏
  const estimateCost = (days: number) => {
    const tokens = days * 50;
    const cost = (tokens / 1000000) * 3;
    if (cost < 0.10) return '$0.05-0.10';
    if (cost < 0.20) return '$0.10-0.20';
    if (cost < 0.50) return '$0.20-0.50';
    return `~$${cost.toFixed(2)}`;
  };
  
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">üìà –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–Ω–¥</h2>
          <p className="text-sm text-gray-600">
            {useAI 
              ? 'ü§ñ AI –ø—Ä–æ–≥–Ω–æ–∑ –∞–∫—Ç–∏–≤–µ–Ω' 
              : 'üìä –õ–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (—Å—Ä–µ–¥–Ω–µ–µ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏)'}
          </p>
          {useAI && trendData?.metadata?.cached && (
            <p className="text-xs text-green-600">
              ‚úÖ –ó–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–æ. –û–±–Ω–æ–≤–∏—Ç—Å—è: {
                new Date(trendData.metadata.cacheExpiresAt).toLocaleTimeString()
              }
            </p>
          )}
        </div>
        
        <button
          onClick={handleToggleAI}
          className={`px-4 py-2 rounded-lg transition ${
            useAI 
              ? 'bg-purple-500 text-white hover:bg-purple-600' 
              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
          }`}
        >
          {useAI ? 'ü§ñ AI –ø—Ä–æ–≥–Ω–æ–∑ –í–ö–õ' : 'ü§ñ –ü–æ–∫–∞–∑–∞—Ç—å AI –ø—Ä–æ–≥–Ω–æ–∑'}
        </button>
      </div>
      
      {/* –ì—Ä–∞—Ñ–∏–∫ */}
      <ResponsiveContainer width="100%" height={400}>
        <LineChart data={trendData?.forecast}>
          {/* ... –ª–∏–Ω–∏–∏ ... */}
        </LineChart>
      </ResponsiveContainer>
      
      {/* –§–∏–ª—å—Ç—Ä—ã */}
      <ForecastFilters
        {...filters}
        onToggle={(key, value) => setFilters({ ...filters, [key]: value })}
      />
      
      {/* Warning Modal */}
      {showWarning && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg max-w-md">
            <h3 className="text-lg font-bold mb-3">
              ‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ AI –ø—Ä–æ–≥–Ω–æ–∑–∞
            </h3>
            
            <p className="text-sm text-gray-700 mb-4">
              AI –ø—Ä–æ–≥–Ω–æ–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Claude –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏ 
              –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —É–º–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.
            </p>
            
            <div className="p-4 bg-yellow-50 rounded-lg mb-4">
              <div className="flex items-start gap-3">
                <span className="text-2xl">üí∞</span>
                <div>
                  <p className="text-sm font-semibold text-yellow-900">
                    –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
                  </p>
                  <p className="text-2xl font-bold text-yellow-900">
                    {estimateCost(forecastDays)}
                  </p>
                  <p className="text-xs text-yellow-700 mt-1">
                    –ó–∞ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ {forecastDays} –¥–Ω–µ–π
                  </p>
                </div>
              </div>
            </div>
            
            <div className="p-3 bg-green-50 rounded-lg mb-4">
              <p className="text-sm text-green-800">
                ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–µ—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 12 —á–∞—Å–æ–≤
              </p>
              <p className="text-xs text-green-700 mt-1">
                –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 12—á –±—É–¥—É—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏
              </p>
            </div>
            
            <div className="flex items-center gap-2 mb-4">
              <label className="text-sm text-gray-700">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–Ω–µ–π:</label>
              <input
                type="range"
                min={30}
                max={365}
                value={forecastDays}
                onChange={(e) => setForecastDays(parseInt(e.target.value))}
                className="flex-1"
              />
              <span className="text-sm font-medium">{forecastDays}</span>
            </div>
            <p className="text-xs text-gray-500 mb-4">
              üí° –ú–µ–Ω—å—à–µ –¥–Ω–µ–π = –¥–µ—à–µ–≤–ª–µ –∑–∞–ø—Ä–æ—Å
            </p>
            
            <div className="flex gap-2">
              <button
                onClick={() => setShowWarning(false)}
                className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
              <button
                onClick={handleConfirmAI}
                className="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600"
              >
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

–≠–¢–ê–ü 4: I18N (15 –º–∏–Ω—É—Ç)
typescript// shared/i18n/web-dashboard-charts.ts

export const webDashboardCharts = {
  en: {
    chart: {
      // ...existing keys...
      
      aiToggle: {
        enable: "Show AI forecast",
        disable: "Disable AI forecast",
        active: "AI forecast active",
        linear: "Linear forecast (average)",
        cached: "Cached. Updates at",
        
        warning: {
          title: "Confirm AI forecast",
          description: "AI forecast uses Claude to analyze your financial history and build smart predictions with trends and patterns.",
          costTitle: "Estimated cost",
          forDays: "For {days} days forecast",
          cached: "Results cached for 12 hours",
          cachedInfo: "Repeated requests within 12h will be free",
          daysLabel: "Forecast days:",
          daysHint: "Fewer days = cheaper request",
          cancel: "Cancel",
          confirm: "Continue"
        }
      }
    }
  },
  
  ru: {
    chart: {
      // ...existing keys...
      
      aiToggle: {
        enable: "–ü–æ–∫–∞–∑–∞—Ç—å AI –ø—Ä–æ–≥–Ω–æ–∑",
        disable: "–í—ã–∫–ª—é—á–∏—Ç—å AI –ø—Ä–æ–≥–Ω–æ–∑",
        active: "AI –ø—Ä–æ–≥–Ω–æ–∑ –∞–∫—Ç–∏–≤–µ–Ω",
        linear: "–õ–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (—Å—Ä–µ–¥–Ω–µ–µ)",
        cached: "–ó–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–æ. –û–±–Ω–æ–≤–∏—Ç—Å—è –≤",
        
        warning: {
          title: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ AI –ø—Ä–æ–≥–Ω–æ–∑–∞",
          description: "AI –ø—Ä–æ–≥–Ω–æ–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Claude –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —É–º–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.",
          costTitle: "–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å",
          forDays: "–ó–∞ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ {days} –¥–Ω–µ–π",
          cached: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–µ—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 12 —á–∞—Å–æ–≤",
          cachedInfo: "–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 12—á –±—É–¥—É—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏",
          daysLabel: "–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–Ω–µ–π:",
          daysHint: "–ú–µ–Ω—å—à–µ –¥–Ω–µ–π = –¥–µ—à–µ–≤–ª–µ –∑–∞–ø—Ä–æ—Å",
          cancel: "–û—Ç–º–µ–Ω–∞",
          confirm: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
        }
      }
    }
  }
};
```

---

## üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –¢–ó –î–õ–Ø REPLIT
```
–ó–ê–î–ê–ß–ê: –ò–°–ü–†–ê–í–ò–¢–¨ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô AI –ü–†–û–ì–ù–û–ó + –î–û–ë–ê–í–ò–¢–¨ OPT-IN

–ö–†–ò–¢–ò–ß–ù–û: AI –ø—Ä–æ–≥–Ω–æ–∑ —Ç—Ä–∞—Ç–∏—Ç –¥–µ–Ω—å–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞!

–ß–¢–û –î–ï–õ–ê–¢–¨:

–≠–¢–ê–ü 1: BACKEND - OPT-IN AI (30 –º–∏–Ω—É—Ç)
‚îú‚îÄ server/services/trend-calculator.service.ts:
‚îÇ  ‚îú‚îÄ –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä useAI?: boolean (default: false)
‚îÇ  ‚îú‚îÄ AI –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ useAI=true –ò –µ—Å—Ç—å anthropicApiKey
‚îÇ  ‚îú‚îÄ –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (NodeCache, TTL: 12 —á–∞—Å–æ–≤)
‚îÇ  ‚îî‚îÄ Fallback –Ω–∞ –ª–∏–Ω–µ–π–Ω—ã–π –µ—Å–ª–∏ AI failed
‚îÇ
‚îî‚îÄ server/routes/analytics.routes.ts:
   ‚îî‚îÄ –î–æ–±–∞–≤–∏—Ç—å query param useAI

–≠–¢–ê–ü 2: FRONTEND - TOGGLE + WARNING (1 —á–∞—Å)
‚îú‚îÄ client/src/components/capital-growth-chart.tsx:
‚îÇ  ‚îú‚îÄ State: useAI (default: false)
‚îÇ  ‚îú‚îÄ –ö–Ω–æ–ø–∫–∞ "ü§ñ –ü–æ–∫–∞–∑–∞—Ç—å AI –ø—Ä–æ–≥–Ω–æ–∑"
‚îÇ  ‚îú‚îÄ Warning modal —Å cost estimate
‚îÇ  ‚îú‚îÄ Slider –¥–ª—è forecastDays
‚îÇ  ‚îî‚îÄ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–µ—à–∞
‚îÇ
‚îî‚îÄ UI —ç–ª–µ–º–µ–Ω—Ç—ã:
   ‚îú‚îÄ Toggle button (—Å–µ—Ä—ã–π/—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π)
   ‚îú‚îÄ Modal —Å warning
   ‚îî‚îÄ Cost calculator (estimateCost —Ñ—É–Ω–∫—Ü–∏—è)

–≠–¢–ê–ü 3: I18N (15 –º–∏–Ω—É—Ç)
‚îî‚îÄ shared/i18n/web-dashboard-charts.ts:
   ‚îî‚îÄ –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –∫–ª—é—á–∏ (EN/RU)

–†–ï–ó–£–õ–¨–¢–ê–¢–´:
‚úÖ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ª–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
‚úÖ AI —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ (opt-in)
‚úÖ Warning –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º —Å cost estimate
‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 12—á (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã)
‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–Ω–µ–π –ø—Ä–æ–≥–Ω–æ–∑–∞ (–º–µ–Ω—å—à–µ = –¥–µ—à–µ–≤–ª–µ)
‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ (–∞–∫—Ç–∏–≤–µ–Ω/–∫–µ—à/–∏—Å—Ç–µ–∫–∞–µ—Ç)

–≠–ö–û–ù–û–ú–ò–Ø:
–ë—ã–ª–æ: $2-5/–¥–µ–Ω—å –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
–°—Ç–∞–Ω–µ—Ç: $0.20-0.40/–¥–µ–Ω—å (—Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω AI)

–ö–†–ò–¢–ò–ß–ù–û–°–¢–¨: üî¥ –í–´–°–û–ö–ê–Ø
–í–†–ï–ú–Ø: 2 —á–∞—Å–∞
–†–ò–°–ö–ò: –ù–∏–∑–∫–∏–µ (—Ç–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–∏—è)