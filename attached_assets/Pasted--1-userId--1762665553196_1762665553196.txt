üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
1. –£—Ç–µ—á–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: userId –≤ —Ñ–æ—Ä–º–µ –∫–ª–∏–µ–Ω—Ç–∞
–ì–¥–µ –ø—Ä–æ–±–ª–µ–º–∞:

// ‚ùå Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç userId
defaultValues: {
  userId: user.id,  // <-- –ú–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å!
  categoryId: 0,
  limitAmount: "",
  ...
}

–ü–æ—á–µ–º—É –æ–ø–∞—Å–Ω–æ:

–ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å userId –≤ DevTools ‚Üí —Å–æ–∑–¥–∞—Ç—å –±—é–¥–∂–µ—Ç –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–•–æ—Ç—è backend "–≤—Ä–æ–¥–µ –±—ã" –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç userId, –Ω–æ –µ—Å–ª–∏ insertBudgetSchema –µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç, –µ—Å—Ç—å —Ä–∏—Å–∫ hijacking
–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

// ‚úÖ Backend –¥–æ–ª–∂–µ–Ω –í–°–ï–ì–î–ê –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å userId –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞
router.post("/api/budgets", requireAuth, async (req, res) => {
  const { userId, ...body } = req.body; // –£–¥–∞–ª–∏—Ç—å userId —è–≤–Ω–æ!
  const validated = insertBudgetSchema.omit({ userId: true }).parse(body);
  const budgetData = { ...validated, userId: req.user.id }; // –¢–æ–ª—å–∫–æ –∏–∑ —Å–µ—Å—Å–∏–∏
  // ...
});
// ‚úÖ Frontend –≤–æ–æ–±—â–µ –Ω–µ –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å userId
const form = useForm({
  defaultValues: {
    // userId: user.id,  // <-- –£–î–ê–õ–ò–¢–¨
    categoryId: 0,
    limitAmount: "",
    ...
  }
});

Zod —Å—Ö–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:

// shared/schema.ts
export const insertBudgetSchema = createInsertSchema(budgets).omit({ 
  id: true,
  userId: true  // <-- –í–ê–ñ–ù–û! userId –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–∞
});

2. Timezone –±–∞–≥: –ø–µ—Ä–∏–æ–¥—ã —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –Ω–∞ 1 –¥–µ–Ω—å
–ì–¥–µ –ø—Ä–æ–±–ª–µ–º–∞:

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
const start = new Date(budget.startDate); // "2024-01-15" ‚Üí 15 —è–Ω–≤–∞—Ä—è –≤ UTC, –Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å 14
const periodStart = startOfWeek(start);

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

startDate —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ "2024-01-15"
new Date("2024-01-15") –ø–∞—Ä—Å–∏—Ç –∫–∞–∫ UTC midnight ‚Üí –ª–æ–∫–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—á–µ—Ä–∞!
startOfWeek() —Å—á–∏—Ç–∞–µ—Ç –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí –Ω–µ–¥–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç —Å—ä–µ–∑–∂–∞–µ—Ç –Ω–∞ –¥–µ–Ω—å
–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - parseISO + date-fns UTC
import { parseISO, startOfWeek, endOfWeek } from 'date-fns';
import { utcToZonedTime } from 'date-fns-tz';
function getBudgetPeriodDates(budget: Budget) {
  const start = parseISO(budget.startDate); // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
  
  switch (budget.period) {
    case "week":
      return {
        start: startOfWeek(start, { weekStartsOn: 1 }), // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        end: endOfWeek(start, { weekStartsOn: 1 })
      };
    // ...
  }
}

–ò–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥—ã –≤ –ë–î:

-- –í–º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ startDate, —Ö—Ä–∞–Ω–∏–º –æ–±–∞ –∫—Ä–∞—è
ALTER TABLE budgets ADD COLUMN period_start DATE;
ALTER TABLE budgets ADD COLUMN period_end DATE;

3. –ü—Ä–æ–≥—Ä–µ—Å—Å –±—é–¥–∂–µ—Ç–∞ —Å–ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
–ì–¥–µ –ø—Ä–æ–±–ª–µ–º–∞:

// ‚ùå –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ù–ê–ó–í–ê–ù–ò–Æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
const filtered = transactions.filter(t => 
  t.category === categoryName  // <-- –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞, –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω—É–ª–∏—Ç—Å—è!
);

–ß—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è:

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –±—é–¥–∂–µ—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ï–¥–∞" (id=5)
–î–µ–ª–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç "–ï–¥–∞" ‚Üí "–ü—Ä–æ–¥—É–∫—Ç—ã"
–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω—É–ª—è–µ—Ç—Å—è! –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å —Å –¥—Ä—É–≥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

// ‚úÖ –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ categoryId, –∞ –Ω–µ –Ω–∞–∑–≤–∞–Ω–∏—é
const filtered = transactions.filter(t => {
  const txCategory = categories.find(c => c.name === t.category);
  return t.type === "expense" && 
         txCategory?.id === budget.categoryId && // <-- –ü–æ ID!
         isWithinInterval(parseISO(t.date), { start, end });
});

–ï—â—ë –ª—É—á—à–µ: —Ö—Ä–∞–Ω–∏—Ç—å categoryId –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö:

// shared/schema.ts
export const dailyTransactions = pgTable("daily_transactions", {
  // ...
  categoryId: integer("category_id").references(() => categories.id),
  category: text("category"), // –û—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è legacy, –Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å categoryId
});

‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ë–ê–ì–ò (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)
4. –ß—Ç–æ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞?
–ü—Ä–æ–±–ª–µ–º–∞:

// –ï—Å–ª–∏ category —É–¥–∞–ª–µ–Ω–∞ (CASCADE), –±—é–¥–∂–µ—Ç –æ—Å—Ç–∞—ë—Ç—Å—è "–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–º"
const category = categories.find(c => c.id === budget.categoryId);
// category === undefined ‚Üí UI –∫—Ä–∞—à–∏—Ç—Å—è

–†–µ—à–µ–Ω–∏–µ:

// ‚úÖ Defensive coding
const category = categories.find(c => c.id === budget.categoryId);
if (!category) {
  return (
    <Card className="border-red-200">
      <CardContent>
        <p className="text-red-600">
          Category deleted. Please update or remove this budget.
        </p>
      </CardContent>
    </Card>
  );
}

–ò–ª–∏ CASCADE DELETE –≤ schema:

// shared/schema.ts
export const budgets = pgTable("budgets", {
  // ...
  categoryId: integer("category_id")
    .references(() => categories.id, { onDelete: "cascade" }) // <-- –£–¥–∞–ª–∏—Ç—å –±—é–¥–∂–µ—Ç –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞
    .notNull(),
});

5. N+1 Query –ø—Ä–æ–±–ª–µ–º–∞ (–µ—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –º–Ω–æ–≥–æ)
–ü—Ä–æ–±–ª–µ–º–∞:

// –î–ª—è –ö–ê–ñ–î–û–ì–û –±—é–¥–∂–µ—Ç–∞ –∏–¥—ë—Ç —Ä–∞—Å—á—ë—Ç –ø–æ –í–°–ï–ú —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
budgets.map(budget => {
  const progress = calculateBudgetProgress(budget, transactions, categoryName);
  // ...
});

–ß—Ç–æ –¥–µ–ª–∞—Ç—å:

–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π <1000 ‚Üí OK
–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π >10000 ‚Üí —Ç–æ—Ä–º–æ–∑–∞ –≤ UI
–†–µ—à–µ–Ω–∏–µ: Backend –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å pre-calculated spent/percentage
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

// Backend: GET /api/budgets –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç spent —Å—Ä–∞–∑—É
router.get("/api/budgets", requireAuth, async (req, res) => {
  const budgets = await storage.getBudgets(req.user.id);
  const budgetsWithProgress = await Promise.all(
    budgets.map(async (budget) => {
      const spent = await storage.getBudgetSpent(budget.id);
      return { ...budget, spent, percentage: (spent / budget.limitAmount) * 100 };
    })
  );
  res.json(budgetsWithProgress);
});

6. Validation: limitAmount –º–æ–∂–µ—Ç –±—ã—Ç—å 0 –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ Zod schema
export const insertBudgetSchema = createInsertSchema(budgets).extend({
  limitAmount: z.string().refine(
    (val) => parseFloat(val) > 0,
    { message: "Limit must be greater than 0" }
  ),
});

‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û –ü–†–ê–í–ò–õ–¨–ù–û
‚úÖ Authorization checks - storage.updateBudget() –∏ deleteBudget() –ø—Ä–æ–≤–µ—Ä—è—é—Ç userId
‚úÖ React Query cache invalidation - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π
‚úÖ Color-coded status - –∑–µ–ª—ë–Ω—ã–π/–∂—ë–ª—Ç—ã–π/–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è UX
‚úÖ Empty state - –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –±—é–¥–∂–µ—Ç–∞
‚úÖ Dashboard alerts - —É–¥–æ–±–Ω–æ –≤–∏–¥–µ—Ç—å –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è —Å—Ä–∞–∑—É
üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
üî¥ –°–†–û–ß–ù–û: –£–±—Ä–∞—Ç—å userId –∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Ñ–æ—Ä–º—ã (security!)
üî¥ –°–†–û–ß–ù–û: –ò—Å–ø—Ä–∞–≤–∏—Ç—å timezone –±–∞–≥ —Å –¥–∞—Ç–∞–º–∏
‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏–≤—è–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∫ categoryId, –Ω–µ –Ω–∞–∑–≤–∞–Ω–∏—é
‚ö†Ô∏è –í–ê–ñ–ù–û: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
üí° –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ backend
üìã CHECKLIST –î–õ–Ø –ê–ì–ï–ù–¢–ê
[ ] –£–¥–∞–ª–∏—Ç—å userId –∏–∑ frontend —Ñ–æ—Ä–º—ã
[ ] –î–æ–±–∞–≤–∏—Ç—å .omit({ userId: true }) –≤ insertBudgetSchema
[ ] –Ø–≤–Ω–æ —É–¥–∞–ª—è—Ç—å userId –∏–∑ req.body –≤ PATCH
[ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å parseISO –≤–º–µ—Å—Ç–æ new Date()
[ ] –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ categoryId, –Ω–µ –Ω–∞–∑–≤–∞–Ω–∏—é
[ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
[ ] –î–æ–±–∞–≤–∏—Ç—å validation limitAmount > 0
[ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å timezone edge cases
[ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç –ª–æ–≥–∏–∫–∏ partners (–°–û–õ–û —Ä–µ–∂–∏–º!)

–í–æ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞! –ì–ª–∞–≤–Ω–æ–µ - security —Å userId –∏ timezone –±–∞–≥.