# üéØ –ü–û–®–ê–ì–û–í–´–ô –ü–õ–ê–ù (–ú–ê–õ–ï–ù–¨–ö–ò–ï –ó–ê–î–ê–ß–ò)

-----

## üìã –°–¢–†–£–ö–¢–£–†–ê –°–ü–†–ò–ù–¢–ê

```
–°–ü–†–ò–ù–¢ 1: –ü–û–î–ì–û–¢–û–í–ö–ê (1 —á–∞—Å)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 1.1: Cleanup UI (15 –º–∏–Ω)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 1.2: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (30 –º–∏–Ω)
‚îî‚îÄ –ó–∞–¥–∞—á–∞ 1.3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (15 –º–∏–Ω)

–°–ü–†–ò–ù–¢ 2: RECEIPT ITEMS (3 —á–∞—Å–∞)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 2.1: Repository (30 –º–∏–Ω)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 2.2: OCR Parser (1 —á–∞—Å)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 2.3: API Endpoint (30 –º–∏–Ω)
‚îî‚îÄ –ó–∞–¥–∞—á–∞ 2.4: UI Integration (1 —á–∞—Å)

–°–ü–†–ò–ù–¢ 3: PRICE COMPARISON (2.5 —á–∞—Å–∞)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 3.1: Service (1 —á–∞—Å)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 3.2: UI Component (1 —á–∞—Å)
‚îî‚îÄ –ó–∞–¥–∞—á–∞ 3.3: Integration (30 –º–∏–Ω)

–°–ü–†–ò–ù–¢ 4: AI CHAT (4 —á–∞—Å–∞)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 4.1: Chat Service (1 —á–∞—Å)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 4.2: Context Builder (1 —á–∞—Å)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 4.3: UI Component (1.5 —á–∞—Å–∞)
‚îî‚îÄ –ó–∞–¥–∞—á–∞ 4.4: Integration (30 –º–∏–Ω)

–°–ü–†–ò–ù–¢ 5: POLISH (1.5 —á–∞—Å–∞)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 5.1: Error Handling (30 –º–∏–Ω)
‚îú‚îÄ –ó–∞–¥–∞—á–∞ 5.2: Loading States (30 –º–∏–Ω)
‚îî‚îÄ –ó–∞–¥–∞—á–∞ 5.3: E2E Testing (30 –º–∏–Ω)

–ò–¢–û–ì–û: 12 —á–∞—Å–æ–≤, 17 –∑–∞–¥–∞—á
```

-----

## üöÄ –°–ü–†–ò–ù–¢ 1: –ü–û–î–ì–û–¢–û–í–ö–ê

### **–ó–ê–î–ê–ß–ê 1.1: CLEANUP UI (15 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –£–±—Ä–∞—Ç—å –ª–∏—à–Ω—é—é –≤–∫–ª–∞–¥–∫—É, –æ—Å—Ç–∞–≤–∏—Ç—å –æ–¥–Ω—É AI Analysis

–ß–¢–û –î–ï–õ–ê–¢–¨:
1. –û—Ç–∫—Ä—ã—Ç—å client/src/components/layout/app-sidebar.tsx
2. –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫–∏ 80-88 (AI Training, AI Analysis)
3. –£–î–ê–õ–ò–¢–¨ –±–ª–æ–∫ —Å AI Training
4. –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ AI Analysis

–ö–û–î (–£–î–ê–õ–ò–¢–¨):
{
  title: "AI Training",
  icon: Brain,
  url: "/ai-training/history"
}

–ü–†–û–í–ï–†–ö–ê:
‚îî‚îÄ –í sidebar —Ç–æ–ª—å–∫–æ "AI Analysis" ‚úÖ
‚îî‚îÄ –ö–ª–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí /ai-analysis ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ app-sidebar.tsx (1 —Ñ–∞–π–ª, -5 —Å—Ç—Ä–æ–∫)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ–º –ª–æ–≥–∏–∫—É, —Ç–æ–ª—å–∫–æ UI
‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ /ai-training –æ—Å—Ç–∞—ë—Ç—Å—è (–º–æ–∂–Ω–æ –∑–∞–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ)
```

-----

### **–ó–ê–î–ê–ß–ê 1.2: –ë–ê–ó–ê –î–ê–ù–ù–´–• (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å 2 –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã

–ß–¢–û –î–ï–õ–ê–¢–¨:
1. –û—Ç–∫—Ä—ã—Ç—å shared/schema.ts
2. –í –ö–û–ù–¶–ï —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å:

// ========== RECEIPT ITEMS ==========
export const receiptItems = pgTable("receipt_items", {
  id: serial("id").primaryKey(),
  transactionId: integer("transaction_id")
    .references(() => dailyTransactions.id, { onDelete: "cascade" })
    .notNull(),
  
  // –¢–æ–≤–∞—Ä
  itemName: text("item_name").notNull(),
  normalizedName: text("normalized_name"), // "orange juice"
  quantity: decimal("quantity", { precision: 10, scale: 2 }),
  unit: text("unit"), // 'pcs', 'kg', 'L'
  
  // –¶–µ–Ω–∞
  pricePerUnit: decimal("price_per_unit", { precision: 10, scale: 2 }).notNull(),
  totalPrice: decimal("total_price", { precision: 10, scale: 2 }).notNull(),
  currency: text("currency").default("IDR"),
  
  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  merchantName: text("merchant_name"),
  category: text("category"),
  
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export const insertReceiptItemSchema = createInsertSchema(receiptItems);
export const selectReceiptItemSchema = createSelectSchema(receiptItems);

export type InsertReceiptItem = z.infer<typeof insertReceiptItemSchema>;
export type ReceiptItem = z.infer<typeof selectReceiptItemSchema>;

// ========== AI CHAT MESSAGES ==========
export const aiChatMessages = pgTable("ai_chat_messages", {
  id: serial("id").primaryKey(),
  userId: integer("user_id")
    .references(() => users.id, { onDelete: "cascade" })
    .notNull(),
  
  role: text("role").notNull(), // 'user' | 'assistant'
  content: text("content").notNull(),
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç
  contextType: text("context_type"),
  contextData: text("context_data"), // JSON string
  
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export const insertAiChatMessageSchema = createInsertSchema(aiChatMessages);
export const selectAiChatMessageSchema = createSelectSchema(aiChatMessages);

export type InsertAiChatMessage = z.infer<typeof insertAiChatMessageSchema>;
export type AiChatMessage = z.infer<typeof selectAiChatMessageSchema>;

3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª

–§–ê–ô–õ–´:
‚îî‚îÄ shared/schema.ts (+60 —Å—Ç—Ä–æ–∫ –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –≤ –ö–û–ù–ï–¶, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (pgTable, serial, etc)
```

-----

### **–ó–ê–î–ê–ß–ê 1.3: –ú–ò–ì–†–ê–¶–ò–Ø –ë–î (15 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–ß–¢–û –î–ï–õ–ê–¢–¨:
1. –¢–µ—Ä–º–∏–Ω–∞–ª: npm run db:push
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ –æ—à–∏–±–æ–∫
3. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å–∏—Ç –ø—Ä–æ data loss ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (–Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç)

–ü–†–û–í–ï–†–ö–ê:
‚îî‚îÄ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ ‚úÖ
‚îî‚îÄ –í –ª–æ–≥–∞—Ö: "‚úì Schema pushed to database" ‚úÖ

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç —Å—Ç–∞—Ä—ã–µ
‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å (–ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã)
```

-----

## üõí –°–ü–†–ò–ù–¢ 2: RECEIPT ITEMS

### **–ó–ê–î–ê–ß–ê 2.1: REPOSITORY (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è receipt_items

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/repositories/receipt-items.repository.ts

–ö–û–î:
import { BaseRepository } from './base.repository';
import { db } from '../db';
import { receiptItems, type InsertReceiptItem, type ReceiptItem } from '@shared/schema';
import { eq, and } from 'drizzle-orm';

/**
 * Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ —á–µ–∫–æ–≤
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
 */
export class ReceiptItemsRepository extends BaseRepository<
  typeof receiptItems,
  ReceiptItem,
  InsertReceiptItem,
  Partial<InsertReceiptItem>
> {
  protected getTable() {
    return receiptItems;
  }
  
  protected getRepositoryName() {
    return 'ReceiptItemsRepository';
  }
  
  /**
   * –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —Ä–∞–∑
   */
  async createBulk(items: InsertReceiptItem[]) {
    return await this.db
      .insert(receiptItems)
      .values(items)
      .returning();
  }
  
  /**
   * –ù–∞–π—Ç–∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   */
  async findByTransaction(transactionId: number) {
    return await this.findMany({
      where: eq(receiptItems.transactionId, transactionId)
    });
  }
  
  /**
   * –ù–∞–π—Ç–∏ –≤—Å–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ—Ö–æ–∂–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
   * (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –º–µ–∂–¥—É –º–∞–≥–∞–∑–∏–Ω–∞–º–∏)
   */
  async findSimilarItems(normalizedName: string, userId: number) {
    const items = await this.db
      .select()
      .from(receiptItems)
      .innerJoin(
        dailyTransactions,
        eq(receiptItems.transactionId, dailyTransactions.id)
      )
      .where(
        and(
          eq(receiptItems.normalizedName, normalizedName),
          eq(dailyTransactions.userId, userId)
        )
      );
    
    return items.map(item => item.receipt_items);
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç singleton
export const receiptItemsRepository = new ReceiptItemsRepository(db);

–†–ê–ó–ú–ï–†: ~90 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ server/repositories/receipt-items.repository.ts (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ Extends BaseRepository (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω)
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ–º –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã
```

-----

### **–ó–ê–î–ê–ß–ê 2.2: OCR PARSER (1 —á–∞—Å)**

```
–¶–ï–õ–¨: –ü–∞—Ä—Å–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ —á–µ–∫–∞ —á–µ—Ä–µ–∑ Claude API

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/services/ocr/receipt-parser.service.ts

–ö–û–î:
import Anthropic from '@anthropic-ai/sdk';

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–µ–∫–æ–≤ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: OCR + –ø–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
 */

interface ParsedReceiptItem {
  name: string;
  normalizedName: string;
  quantity: number;
  pricePerUnit: number;
  totalPrice: number;
}

interface ParsedReceipt {
  total: number;
  merchant: string;
  date: string;
  items: ParsedReceiptItem[];
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
 */
function normalizeItemName(name: string): string {
  return name
    .toLowerCase()
    .replace(/[0-9]+\s*(ml|l|kg|g|pcs|—à—Ç)/gi, '') // —É–±—Ä–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã
    .replace(/[^a-z–∞-—è—ë\s]/g, '') // —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã
    .trim();
}

/**
 * –ü–∞—Ä—Å–∏—Ç—å —á–µ–∫ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–æ–≤
 */
export async function parseReceiptWithItems(
  imageBase64: string,
  apiKey: string
): Promise<ParsedReceipt> {
  
  const anthropic = new Anthropic({ apiKey });
  
  const prompt = `
    Parse this receipt image and extract:
    1. Total amount (number)
    2. Merchant/store name (string)
    3. Date (YYYY-MM-DD format)
    4. List of purchased items with:
       - Item name (string)
       - Quantity (number, default 1 if not specified)
       - Price per unit (number)
       - Total price for this item (number)
    
    Return ONLY valid JSON in this exact format:
    {
      "total": 180000,
      "merchant": "Moris Grocier",
      "date": "2025-11-17",
      "items": [
        {
          "name": "Orange Juice 1L",
          "quantity": 2,
          "pricePerUnit": 32000,
          "totalPrice": 64000
        }
      ]
    }
    
    Rules:
    - All prices in original currency (IDR, USD, RUB, etc)
    - If quantity not specified, use 1
    - pricePerUnit = totalPrice / quantity
    - Return ONLY JSON, no explanations
  `;
  
  const response = await anthropic.messages.create({
    model: "claude-3-5-sonnet-20241022",
    max_tokens: 2000,
    messages: [{
      role: "user",
      content: [
        {
          type: "image",
          source: {
            type: "base64",
            media_type: "image/jpeg",
            data: imageBase64
          }
        },
        {
          type: "text",
          text: prompt
        }
      ]
    }]
  });
  
  // –ü–∞—Ä—Å–∏—Ç—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
  const text = response.content[0].type === 'text' 
    ? response.content[0].text 
    : '';
  
  const parsed: ParsedReceipt = JSON.parse(text);
  
  // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
  parsed.items = parsed.items.map(item => ({
    ...item,
    normalizedName: normalizeItemName(item.name)
  }));
  
  return parsed;
}

–†–ê–ó–ú–ï–†: ~120 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ server/services/ocr/receipt-parser.service.ts (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
‚úÖ Try-catch –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ endpoint
```

-----

### **–ó–ê–î–ê–ß–ê 2.3: API ENDPOINT (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–∞ —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º —Ç–æ–≤–∞—Ä–æ–≤

–ß–¢–û –î–ï–õ–ê–¢–¨:
–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª: server/routes/ai.routes.ts

–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–ù–ï–¶ (–ø–µ—Ä–µ–¥ export default router):

// ========== RECEIPT WITH ITEMS ==========

/**
 * POST /api/ai/receipt-with-items
 * –ü–∞—Ä—Å–∏—Ç—å —á–µ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä—ã
 */
router.post('/receipt-with-items', requireAuth, async (req, res) => {
  try {
    const { imageBase64, transactionId } = req.body;
    const userId = req.user!.id;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!imageBase64) {
      return res.status(400).json({ 
        error: 'imageBase64 is required' 
      });
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á —é–∑–µ—Ä–∞
    const apiKey = await getUserApiKey(userId, 'anthropic');
    if (!apiKey) {
      return res.status(400).json({
        error: 'Anthropic API key not configured. Please add it in Settings.'
      });
    }
    
    // –ü–∞—Ä—Å–∏—Ç—å —á–µ–∫
    const parsed = await parseReceiptWithItems(imageBase64, apiKey);
    
    // –ï—Å–ª–∏ transactionId —É–∫–∞–∑–∞–Ω - –ø—Ä–∏–≤—è–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    if (transactionId) {
      const items = parsed.items.map(item => ({
        transactionId,
        itemName: item.name,
        normalizedName: item.normalizedName,
        quantity: item.quantity.toString(),
        pricePerUnit: item.pricePerUnit.toString(),
        totalPrice: item.totalPrice.toString(),
        merchantName: parsed.merchant
      }));
      
      await receiptItemsRepository.createBulk(items);
    }
    
    res.json({
      success: true,
      receipt: parsed,
      itemsCount: parsed.items.length
    });
    
  } catch (error) {
    console.error('Receipt parsing error:', error);
    res.status(500).json({
      error: 'Failed to parse receipt',
      details: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

–†–ê–ó–ú–ï–†: +60 —Å—Ç—Ä–æ–∫

–§–ê–ô–õ–´:
‚îî‚îÄ server/routes/ai.routes.ts (–æ–±–Ω–æ–≤–∏—Ç—å)

–ò–ú–ü–û–†–¢–´ (–¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞):
import { parseReceiptWithItems } from '../services/ocr/receipt-parser.service';
import { receiptItemsRepository } from '../repositories/receipt-items.repository';

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –í –ö–û–ù–ï–¶ —Ñ–∞–π–ª–∞
‚úÖ Try-catch –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

-----

### **–ó–ê–î–ê–ß–ê 2.4: UI INTEGRATION (1 —á–∞—Å)**

```
–¶–ï–õ–¨: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "Scan Receipt" –≤ AI Analysis

–ß–¢–û –î–ï–õ–ê–¢–¨:
–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª: client/src/pages/ai-analysis-page.tsx

–ù–ê–ô–¢–ò –±–ª–æ–∫ "Receipt OCR Scanner" (~—Å—Ç—Ä–æ–∫–∞ 150):
<Card>
  <CardHeader>
    <CardTitle>Receipt OCR Scanner</CardTitle>
  </CardHeader>
  <CardContent>
    <Button disabled>
      Scan Receipt (Coming Soon)
    </Button>
  </CardContent>
</Card>

–ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê:
<Card>
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Camera className="h-5 w-5" />
      Receipt OCR Scanner
    </CardTitle>
    <CardDescription>
      Upload a receipt to automatically extract items and prices
    </CardDescription>
  </CardHeader>
  <CardContent>
    <div className="space-y-4">
      <Input
        type="file"
        accept="image/*"
        onChange={handleReceiptUpload}
        ref={fileInputRef}
        className="hidden"
      />
      
      <Button 
        onClick={() => fileInputRef.current?.click()}
        disabled={uploadMutation.isPending}
      >
        {uploadMutation.isPending ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            Scanning...
          </>
        ) : (
          <>
            <Camera className="mr-2 h-4 w-4" />
            Upload Receipt
          </>
        )}
      </Button>
      
      {uploadResult && (
        <div className="mt-4 p-4 bg-green-50 rounded-lg">
          <p className="text-sm font-medium text-green-900">
            ‚úì Receipt scanned successfully!
          </p>
          <p className="text-xs text-green-700 mt-1">
            Found {uploadResult.itemsCount} items from {uploadResult.receipt.merchant}
          </p>
        </div>
      )}
    </div>
  </CardContent>
</Card>

–î–û–ë–ê–í–ò–¢–¨ –í –ù–ê–ß–ê–õ–û –ö–û–ú–ü–û–ù–ï–ù–¢–ê:
const fileInputRef = useRef<HTMLInputElement>(null);
const [uploadResult, setUploadResult] = useState<any>(null);

const uploadMutation = useMutation({
  mutationFn: async (file: File) => {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ base64
    const base64 = await fileToBase64(file);
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const response = await fetch('/api/ai/receipt-with-items', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imageBase64: base64 })
    });
    
    if (!response.ok) throw new Error('Failed to parse receipt');
    return response.json();
  },
  onSuccess: (data) => {
    setUploadResult(data);
    toast.success(`Scanned ${data.itemsCount} items!`);
  },
  onError: (error) => {
    toast.error('Failed to scan receipt');
  }
});

const handleReceiptUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) uploadMutation.mutate(file);
};

// Helper
function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result as string;
      resolve(base64.split(',')[1]); // —É–±—Ä–∞—Ç—å "data:image/jpeg;base64,"
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

–ò–ú–ü–û–†–¢–´ (–¥–æ–±–∞–≤–∏—Ç—å):
import { Camera, Loader2 } from 'lucide-react';
import { useRef, useState } from 'react';

–§–ê–ô–õ–´:
‚îî‚îÄ client/src/pages/ai-analysis-page.tsx (–æ–±–Ω–æ–≤–∏—Ç—å)

–†–ê–ó–ú–ï–†: +80 —Å—Ç—Ä–æ–∫

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –±–ª–æ–∫
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ–º –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
```

-----

## üí∞ –°–ü–†–ò–ù–¢ 3: PRICE COMPARISON

### **–ó–ê–î–ê–ß–ê 3.1: SERVICE (1 —á–∞—Å)**

```
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/services/ai/price-comparison.service.ts

–ö–û–î:
import { db } from '../../db';
import { receiptItems, dailyTransactions } from '@shared/schema';
import { eq, and, gte } from 'drizzle-orm';

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –º–µ–∂–¥—É –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
 */

interface PriceRecommendation {
  itemName: string;
  normalizedName: string;
  cheapestMerchant: string;
  cheapestPrice: number;
  expensiveMerchant: string;
  expensivePrice: number;
  savingsAmount: number;
  savingsPercent: number;
  purchaseCount: number;
  recommendation: string;
}

/**
 * –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Å–∏–≤ –ø–æ –∫–ª—é—á—É
 */
function groupBy<T>(array: T[], keyFn: (item: T) => string): Record<string, T[]> {
  return array.reduce((result, item) => {
    const key = keyFn(item);
    if (!result[key]) result[key] = [];
    result[key].push(item);
    return result;
  }, {} as Record<string, T[]>);
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–∞–º
 */
export async function generatePriceRecommendations(
  userId: number,
  minSavingsPercent: number = 20
): Promise<PriceRecommendation[]> {
  
  // 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
  
  const items = await db
    .select({
      itemName: receiptItems.itemName,
      normalizedName: receiptItems.normalizedName,
      pricePerUnit: receiptItems.pricePerUnit,
      merchantName: receiptItems.merchantName
    })
    .from(receiptItems)
    .innerJoin(
      dailyTransactions,
      eq(receiptItems.transactionId, dailyTransactions.id)
    )
    .where(
      and(
        eq(dailyTransactions.userId, userId),
        gte(dailyTransactions.date, threeMonthsAgo.toISOString().split('T')[0])
      )
    );
  
  if (items.length === 0) {
    return [];
  }
  
  // 2. –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ normalizedName
  const grouped = groupBy(items, item => item.normalizedName || '');
  
  // 3. –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã —Å —Ä–∞–∑–Ω–∏—Ü–µ–π —Ü–µ–Ω
  const recommendations: PriceRecommendation[] = [];
  
  for (const [normalizedName, purchases] of Object.entries(grouped)) {
    if (!normalizedName || purchases.length < 2) continue;
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ü–µ–Ω–µ
    const sorted = purchases.sort((a, b) => 
      parseFloat(a.pricePerUnit) - parseFloat(b.pricePerUnit)
    );
    
    const cheapest = sorted[0];
    const mostExpensive = sorted[sorted.length - 1];
    
    const cheapPrice = parseFloat(cheapest.pricePerUnit);
    const expPrice = parseFloat(mostExpensive.pricePerUnit);
    
    const savingsAmount = expPrice - cheapPrice;
    const savingsPercent = (savingsAmount / expPrice) * 100;
    
    if (savingsPercent >= minSavingsPercent) {
      recommendations.push({
        itemName: cheapest.itemName,
        normalizedName,
        cheapestMerchant: cheapest.merchantName || 'Unknown',
        cheapestPrice: cheapPrice,
        expensiveMerchant: mostExpensive.merchantName || 'Unknown',
        expensivePrice: expPrice,
        savingsAmount,
        savingsPercent,
        purchaseCount: purchases.length,
        recommendation: `Buy "${cheapest.itemName}" at ${cheapest.merchantName} (${cheapPrice.toFixed(0)}) instead of ${mostExpensive.merchantName} (${expPrice.toFixed(0)}). Save ${savingsAmount.toFixed(0)} (${savingsPercent.toFixed(0)}%)!`
      });
    }
  }
  
  // 4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏
  return recommendations.sort((a, b) => b.savingsAmount - a.savingsAmount);
}

–†–ê–ó–ú–ï–†: ~150 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ server/services/ai/price-comparison.service.ts (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ—Ç –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã
‚úÖ –ü—Ä–æ—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –Ω–µ—Ç AI API
```

-----

### **–ó–ê–î–ê–ß–ê 3.2: UI COMPONENT (1 —á–∞—Å)**

```
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: client/src/components/ai/price-recommendations.tsx

–ö–û–î:
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { TrendingDown, Store } from 'lucide-react';
import { useQuery } from '@tanstack/react-query';

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Ü–µ–Ω–∞–º
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–¥–µ –ø–æ–∫—É–ø–∞—Ç—å –¥–µ—à–µ–≤–ª–µ
 */

interface PriceRecommendation {
  itemName: string;
  cheapestMerchant: string;
  cheapestPrice: number;
  expensiveMerchant: string;
  expensivePrice: number;
  savingsAmount: number;
  savingsPercent: number;
  recommendation: string;
}

export function PriceRecommendations() {
  const { data: recommendations, isLoading } = useQuery<PriceRecommendation[]>({
    queryKey: ['/api/ai/price-recommendations'],
  });
  
  if (isLoading) {
    return (
      <Card>
        <CardContent className="p-6">
          <p className="text-sm text-gray-500">Loading recommendations...</p>
        </CardContent>
      </Card>
    );
  }
  
  if (!recommendations || recommendations.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <TrendingDown className="h-5 w-5" />
            Price Recommendations
          </CardTitle>
          <CardDescription>
            Upload receipts to get personalized money-saving recommendations
          </CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-gray-500">
            No recommendations yet. Upload 2+ receipts with the same items from different stores.
          </p>
        </CardContent>
      </Card>
    );
  }
  
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <TrendingDown className="h-5 w-5 text-green-600" />
          Price Recommendations
        </CardTitle>
        <CardDescription>
          Save money by shopping at the right stores
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {recommendations.map((rec, index) => (
            <div 
              key={index}
              className="p-4 border rounded-lg hover:bg-gray-50 transition"
            >
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <p className="font-medium text-sm">
                    {rec.itemName}
                  </p>
                  
                  <div className="mt-2 flex items-center gap-4 text-xs text-gray-600">
                    <div className="flex items-center gap-1">
                      <Store className="h-3 w-3 text-green-600" />
                      <span className="font-medium text-green-700">
                        {rec.cheapestMerchant}
                      </span>
                      <span>${rec.cheapestPrice.toFixed(2)}</span>
                    </div>
                    
                    <span className="text-gray-400">vs</span>
                    
                    <div className="flex items-center gap-1">
                      <Store className="h-3 w-3 text-red-600" />
                      <span className="font-medium text-red-700">
                        {rec.expensiveMerchant}
                      </span>
                      <span>${rec.expensivePrice.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <p className="mt-2 text-xs text-gray-700">
                    {rec.recommendation}
                  </p>
                </div>
                
                <Badge variant="secondary" className="ml-4">
                  Save ${rec.savingsAmount.toFixed(2)}
                </Badge>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}

–†–ê–ó–ú–ï–†: ~140 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ client/src/components/ai/price-recommendations.tsx (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
```

-----

### **–ó–ê–î–ê–ß–ê 3.3: INTEGRATION (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –î–æ–±–∞–≤–∏—Ç—å endpoint + –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ AI Analysis

–ß–¢–û –î–ï–õ–ê–¢–¨:

1. BACKEND:
–û–±–Ω–æ–≤–∏—Ç—å server/routes/ai.routes.ts

–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–ù–ï–¶:

// ========== PRICE RECOMMENDATIONS ==========

/**
 * GET /api/ai/price-recommendations
 * –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–∞–º
 */
router.get('/price-recommendations', requireAuth, async (req, res) => {
  try {
    const userId = req.user!.id;
    
    const recommendations = await generatePriceRecommendations(userId);
    
    res.json(recommendations);
    
  } catch (error) {
    console.error('Price recommendations error:', error);
    res.status(500).json({ error: 'Failed to generate recommendations' });
  }
});

–ò–ú–ü–û–†–¢ (–¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ):
import { generatePriceRecommendations } from '../services/ai/price-comparison.service';

2. FRONTEND:
–û–±–Ω–æ–≤–∏—Ç—å client/src/pages/ai-analysis-page.tsx

–î–û–ë–ê–í–ò–¢–¨ –ø–µ—Ä–µ–¥ "Receipt OCR Scanner":

<PriceRecommendations />

–ò–ú–ü–û–†–¢ (–¥–æ–±–∞–≤–∏—Ç—å):
import { PriceRecommendations } from '@/components/ai/price-recommendations';

–§–ê–ô–õ–´:
‚îú‚îÄ server/routes/ai.routes.ts (+20 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ client/src/pages/ai-analysis-page.tsx (+2 —Å—Ç—Ä–æ–∫–∏)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü/–Ω–∞—á–∞–ª–æ
```

-----

## üí¨ –°–ü–†–ò–ù–¢ 4: AI CHAT

### **–ó–ê–î–ê–ß–ê 4.1: CHAT SERVICE (1 —á–∞—Å)**

```
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å backend –¥–ª—è —á–∞—Ç–∞ —Å AI

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/services/ai/chat.service.ts

–ö–û–î:
import Anthropic from '@anthropic-ai/sdk';
import { db } from '../../db';
import { aiChatMessages } from '@shared/schema';
import { eq, desc } from 'drizzle-orm';

/**
 * AI —á–∞—Ç-—Å–µ—Ä–≤–∏—Å
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –û–±—â–µ–Ω–∏–µ —Å Claude, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
 */

interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
}

interface ChatResponse {
  message: string;
  contextUsed: string[];
}

/**
 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ AI —á–∞—Ç
 */
export async function chatWithAI(
  userId: number,
  userMessage: string,
  apiKey: string
): Promise<ChatResponse> {
  
  const anthropic = new Anthropic({ apiKey });
  
  // 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
  const history = await db
    .select()
    .from(aiChatMessages)
    .where(eq(aiChatMessages.userId, userId))
    .orderBy(desc(aiChatMessages.createdAt))
    .limit(10);
  
  const messages: ChatMessage[] = history
    .reverse()
    .map(msg => ({
      role: msg.role as 'user' | 'assistant',
      content: msg.content
    }));
  
  // 2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–∫–æ–Ω—Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥. –∑–∞–¥–∞—á–µ)
  const systemPrompt = `
    You are a personal finance advisor for Budget Buddy app.
    
    Answer user questions about their finances.
    Give concrete, actionable advice.
    Be friendly and helpful.
    Keep responses concise (2-3 paragraphs max).
  `;
  
  // 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Claude
  const response = await anthropic.messages.create({
    model: "claude-3-5-sonnet-20241022",
    max_tokens: 1000,
    system: systemPrompt,
    messages: [
      ...messages,
      {
        role: "user",
        content: userMessage
      }
    ]
  });
  
  const assistantMessage = response.content[0].type === 'text'
    ? response.content[0].text
    : '';
  
  // 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
  await db.insert(aiChatMessages).values([
    {
      userId,
      role: 'user',
      content: userMessage
    },
    {
      userId,
      role: 'assistant',
      content: assistantMessage
    }
  ]);
  
  return {
    message: assistantMessage,
    contextUsed: []
  };
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
 */
export async function getChatHistory(
  userId: number,
  limit: number = 50
) {
  return await db
    .select()
    .from(aiChatMessages)
    .where(eq(aiChatMessages.userId, userId))
    .orderBy(desc(aiChatMessages.createdAt))
    .limit(limit);
}

/**
 * –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
 */
export async function clearChatHistory(userId: number) {
  await db
    .delete(aiChatMessages)
    .where(eq(aiChatMessages.userId, userId));
}

–†–ê–ó–ú–ï–†: ~130 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ server/services/ai/chat.service.ts (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚úÖ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –≤ –ë–î
‚úÖ –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç (–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ–±–∞–≤–∏–º –≤ —Å–ª–µ–¥. –∑–∞–¥–∞—á–µ)
```

-----

### **–ó–ê–î–ê–ß–ê 4.2: CONTEXT BUILDER (1 —á–∞—Å)**

```
–¶–ï–õ–¨: –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —á–∞—Ç

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/services/ai/chat-context.service.ts

–ö–û–î:
import { db } from '../../db';
import { dailyTransactions, wallets, budgetLimits } from '@shared/schema';
import { eq, gte, sql } from 'drizzle-orm';
import { generatePriceRecommendations } from './price-comparison.service';

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è AI
 */

interface FinancialContext {
  monthlyIncome: number;
  monthlyExpenses: number;
  freeCapital: number;
  currentBalance: number;
  priceRecommendations: string[];
  budgetStatus: string[];
  recentTransactions: string[];
}

/**
 * –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export async function buildFinancialContext(
  userId: number
): Promise<FinancialContext> {
  
  // 1. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ä–µ–¥–Ω–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞)
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
  
  const stats = await db
    .select({
      totalIncome: sql<number>`SUM(CASE WHEN type = 'income' THEN amount_usd ELSE 0 END)`,
      totalExpense: sql<number>`SUM(CASE WHEN type = 'expense' THEN amount_usd ELSE 0 END)`,
      transactionCount: sql<number>`COUNT(*)`
    })
    .from(dailyTransactions)
    .where(
      eq(dailyTransactions.userId, userId),
      gte(dailyTransactions.date, threeMonthsAgo.toISOString().split('T')[0])
    );
  
  const monthlyIncome = (stats[0]?.totalIncome || 0) / 3;
  const monthlyExpenses = (stats[0]?.totalExpense || 0) / 3;
  
  // 2. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (—Å—É–º–º–∞ –≤—Å–µ—Ö –∫–æ—à–µ–ª—å–∫–æ–≤)
  const walletsData = await db
    .select()
    .from(wallets)
    .where(eq(wallets.userId, userId));
  
  const currentBalance = walletsData.reduce((sum, w) => 
    sum + parseFloat(w.balanceUsd || '0'), 0
  );
  
  // 3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–∞–º
  const priceRecs = await generatePriceRecommendations(userId);
  const priceRecommendations = priceRecs.slice(0, 3).map(r => r.recommendation);
  
  // 4. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  const recentTxs = await db
    .select()
    .from(dailyTransactions)
    .where(eq(dailyTransactions.userId, userId))
    .orderBy(desc(dailyTransactions.date))
    .limit(5);
  
  const recentTransactions = recentTxs.map(tx =>
    `${tx.description}: $${tx.amountUsd} (${tx.type})`
  );
  
  return {
    monthlyIncome,
    monthlyExpenses,
    freeCapital: monthlyIncome - monthlyExpenses,
    currentBalance,
    priceRecommendations,
    budgetStatus: [], // TODO: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    recentTransactions
  };
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
 */
export function formatContextForPrompt(context: FinancialContext): string {
  return `
User's Financial Context:
- Monthly income: $${context.monthlyIncome.toFixed(2)}
- Monthly expenses: $${context.monthlyExpenses.toFixed(2)}
- Free capital: $${context.freeCapital.toFixed(2)}
- Current balance: $${context.currentBalance.toFixed(2)}

Recent transactions:
${context.recentTransactions.map(tx => `- ${tx}`).join('\n')}

${context.priceRecommendations.length > 0 ? `
Money-saving opportunities:
${context.priceRecommendations.map(rec => `- ${rec}`).join('\n')}
` : ''}
  `.trim();
}

–†–ê–ó–ú–ï–†: ~120 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ server/services/ai/chat-context.service.ts (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ—Ç –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã
‚úÖ –ü—Ä–æ—Å—Ç—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
```

-----

**–û–ë–ù–û–í–ò–¢–¨ chat.service.ts:**

```typescript
// –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç:
import { buildFinancialContext, formatContextForPrompt } from './chat-context.service';

// –í —Ñ—É–Ω–∫—Ü–∏–∏ chatWithAI(), –ø–µ—Ä–µ–¥ "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç":

// 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
const context = await buildFinancialContext(userId);
const contextText = formatContextForPrompt(context);

// 2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–û–ë–ù–û–í–ò–¢–¨):
const systemPrompt = `
  You are a personal finance advisor for Budget Buddy app.
  
  ${contextText}
  
  Answer user questions about their finances.
  Give concrete, actionable advice based on the data above.
  Be friendly and helpful.
  Keep responses concise (2-3 paragraphs max).
`;

–†–ê–ó–ú–ï–†: +10 —Å—Ç—Ä–æ–∫

–§–ê–ô–õ–´:
‚îî‚îÄ server/services/ai/chat.service.ts (–æ–±–Ω–æ–≤–∏—Ç—å)
```

-----

### **–ó–ê–î–ê–ß–ê 4.3: UI COMPONENT (1.5 —á–∞—Å–∞)**

```
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å chat UI

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: client/src/components/ai/ai-chat.tsx

–ö–û–î:
import { useState, useRef, useEffect } from 'react';
import { useMutation, useQuery } from '@tanstack/react-query';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { MessageCircle, Send, Loader2, Trash2 } from 'lucide-react';
import { cn } from '@/lib/utils';
import { useToast } from '@/hooks/use-toast';

/**
 * AI Chat –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
 * –†–∞–∑–≥–æ–≤–æ—Ä —Å AI —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º —Å–æ–≤–µ—Ç–Ω–∏–∫–æ–º
 */

interface Message {
  role: 'user' | 'assistant';
  content: string;
}

export function AIChat() {
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState<Message[]>([]);
  const scrollRef = useRef<HTMLDivElement>(null);
  const { toast } = useToast();
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
  const { data: history } = useQuery<Message[]>({
    queryKey: ['/api/ai/chat/history'],
    onSuccess: (data) => {
      setMessages(data.reverse());
    }
  });
  
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  const sendMutation = useMutation({
    mutationFn: async (message: string) => {
      const response = await fetch('/api/ai/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to send message');
      }
      
      return response.json();
    },
    onMutate: (message) => {
      // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      setMessages(prev => [...prev, { role: 'user', content: message }]);
      setInput('');
    },
    onSuccess: (data) => {
      setMessages(prev => [...prev, { 
        role: 'assistant', 
        content: data.message 
      }]);
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive"
      });
      // –£–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      setMessages(prev => prev.slice(0, -1));
    }
  });
  
  // –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
  const clearMutation = useMutation({
    mutationFn: async () => {
      await fetch('/api/ai/chat/history', { method: 'DELETE' });
    },
    onSuccess: () => {
      setMessages([]);
      toast({ title: "Chat cleared" });
    }
  });
  
  // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);
  
  const handleSend = () => {
    if (!input.trim() || sendMutation.isPending) return;
    sendMutation.mutate(input);
  };
  
  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle className="flex items-center gap-2">
              <MessageCircle className="h-5 w-5" />
              AI Financial Advisor
            </CardTitle>
            <CardDescription>
              Ask questions about your finances and get personalized advice
            </CardDescription>
          </div>
          
          {messages.length > 0 && (
            <Button 
              variant="ghost" 
              size="sm"
              onClick={() => clearMutation.mutate()}
              disabled={clearMutation.isPending}
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          )}
        </div>
      </CardHeader>
      
      <CardContent>
        <div className="space-y-4">
          {/* –°–æ–æ–±—â–µ–Ω–∏—è */}
          <ScrollArea className="h-[400px] pr-4" ref={scrollRef}>
            <div className="space-y-4">
              {messages.length === 0 ? (
                <div className="text-center text-sm text-gray-500 py-8">
                  <p className="mb-4">Start a conversation with your AI advisor!</p>
                  <div className="flex flex-wrap gap-2 justify-center">
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => setInput("Where can I save money?")}
                    >
                      üí∞ Where can I save?
                    </Button>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => setInput("What are the cheapest stores?")}
                    >
                      üõí Cheapest stores?
                    </Button>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => setInput("Analyze my spending")}
                    >
                      üìä Analyze spending
                    </Button>
                  </div>
                </div>
              ) : (
                messages.map((msg, i) => (
                  <div 
                    key={i}
                    className={cn(
                      "p-3 rounded-lg max-w-[85%]",
                      msg.role === 'user' 
                        ? "bg-blue-100 ml-auto" 
                        : "bg-gray-100 mr-auto"
                    )}
                  >
                    <p className="text-sm whitespace-pre-wrap">
                      {msg.content}
                    </p>
                  </div>
                ))
              )}
              
              {sendMutation.isPending && (
                <div className="bg-gray-100 p-3 rounded-lg max-w-[85%] mr-auto animate-pulse">
                  <p className="text-sm text-gray-500">
                    AI is thinking...
                  </p>
                </div>
              )}
            </div>
          </ScrollArea>
          
          {/* –ò–Ω–ø—É—Ç */}
          <div className="flex gap-2">
            <Input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Ask me anything about your finances..."
              onKeyPress={(e) => {
                if (e.key === 'Enter' && !sendMutation.isPending) {
                  handleSend();
                }
              }}
              disabled={sendMutation.isPending}
            />
            <Button 
              onClick={handleSend}
              disabled={sendMutation.isPending || !input.trim()}
              size="icon"
            >
              {sendMutation.isPending ? (
                <Loader2 className="h-4 w-4 animate-spin" />
              ) : (
                <Send className="h-4 w-4" />
              )}
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

–†–ê–ó–ú–ï–†: ~200 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ client/src/components/ai/ai-chat.tsx (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚úÖ –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
‚úÖ Error handling
```

-----

### **–ó–ê–î–ê–ß–ê 4.4: INTEGRATION (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –î–æ–±–∞–≤–∏—Ç—å endpoints + –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É

–ß–¢–û –î–ï–õ–ê–¢–¨:

1. BACKEND:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/routes/ai-chat.routes.ts

–ö–û–î:
import { Router } from 'express';
import { requireAuth } from '../middleware/auth';
import { chatWithAI, getChatHistory, clearChatHistory } from '../services/ai/chat.service';
import { getUserApiKey } from '../services/user-api-keys.service';

const router = Router();

/**
 * POST /api/ai/chat
 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
 */
router.post('/', requireAuth, async (req, res) => {
  try {
    const { message } = req.body;
    const userId = req.user!.id;
    
    if (!message) {
      return res.status(400).json({ error: 'message is required' });
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á
    const apiKey = await getUserApiKey(userId, 'anthropic');
    if (!apiKey) {
      return res.status(400).json({
        error: 'Anthropic API key not configured. Please add it in Settings.'
      });
    }
    
    const response = await chatWithAI(userId, message, apiKey);
    
    res.json(response);
    
  } catch (error) {
    console.error('Chat error:', error);
    res.status(500).json({ 
      error: 'Failed to send message',
      details: error instanceof Error ? error.message : 'Unknown error'
    });
  }
});

/**
 * GET /api/ai/chat/history
 * –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
 */
router.get('/history', requireAuth, async (req, res) => {
  try {
    const userId = req.user!.id;
    const history = await getChatHistory(userId);
    res.json(history);
  } catch (error) {
    console.error('Chat history error:', error);
    res.status(500).json({ error: 'Failed to load history' });
  }
});

/**
 * DELETE /api/ai/chat/history
 * –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
 */
router.delete('/history', requireAuth, async (req, res) => {
  try {
    const userId = req.user!.id;
    await clearChatHistory(userId);
    res.json({ success: true });
  } catch (error) {
    console.error('Clear history error:', error);
    res.status(500).json({ error: 'Failed to clear history' });
  }
});

export default router;

2. –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ROUTER:
–û–±–Ω–æ–≤–∏—Ç—å server/index.ts

–ù–ê–ô–¢–ò:
app.use("/api/ai", aiRoutes);

–î–û–ë–ê–í–ò–¢–¨ –ü–û–°–õ–ï:
import aiChatRoutes from './routes/ai-chat.routes';
app.use("/api/ai/chat", aiChatRoutes);

3. FRONTEND:
–û–±–Ω–æ–≤–∏—Ç—å client/src/pages/ai-analysis-page.tsx

–î–û–ë–ê–í–ò–¢–¨ –í –ù–ê–ß–ê–õ–û (—Å–∞–º—ã–π –≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã):

<AIChat />

–ò–ú–ü–û–†–¢:
import { AIChat } from '@/components/ai/ai-chat';

–§–ê–ô–õ–´:
‚îú‚îÄ server/routes/ai-chat.routes.ts (–Ω–æ–≤—ã–π, ~90 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ server/index.ts (+2 —Å—Ç—Ä–æ–∫–∏)
‚îî‚îÄ client/src/pages/ai-analysis-page.tsx (+2 —Å—Ç—Ä–æ–∫–∏)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ routes
```

-----

## üé® –°–ü–†–ò–ù–¢ 5: POLISH

### **–ó–ê–î–ê–ß–ê 5.1: ERROR HANDLING (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

–ß–¢–û –î–ï–õ–ê–¢–¨:

1. –û–ë–©–ò–ô ERROR HANDLER (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç):
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≤ server/index.ts:

app.use((err, req, res, next) => {
  console.error('Global error:', err);
  res.status(500).json({
    error: 'Internal server error',
    message: process.env.NODE_ENV === 'development' ? err.message : undefined
  });
});

2. API KEY MISSING HANDLER:
–°–æ–∑–¥–∞—Ç—å: server/middleware/require-api-key.ts

export async function requireApiKey(provider: string) {
  return async (req, res, next) => {
    const userId = req.user!.id;
    const apiKey = await getUserApiKey(userId, provider);
    
    if (!apiKey) {
      return res.status(400).json({
        error: `${provider} API key not configured`,
        action: 'Please add your API key in Settings'
      });
    }
    
    req.apiKey = apiKey;
    next();
  };
}

–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –≤ routes:
router.post('/chat', requireAuth, requireApiKey('anthropic'), async (req, res) => {
  const apiKey = req.apiKey; // —É–∂–µ –µ—Å—Ç—å!
  ...
});

–§–ê–ô–õ–´:
‚îú‚îÄ server/middleware/require-api-key.ts (–Ω–æ–≤—ã–π, ~30 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ –æ–±–Ω–æ–≤–∏—Ç—å routes (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

-----

### **–ó–ê–î–ê–ß–ê 5.2: LOADING STATES (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –î–æ–±–∞–≤–∏—Ç—å —Å–∫–µ–ª–µ—Ç–æ–Ω—ã –∏ –∑–∞–≥—Ä—É–∑–∫–∏

–ß–¢–û –î–ï–õ–ê–¢–¨:

–û–±–Ω–æ–≤–∏—Ç—å client/src/components/ai/price-recommendations.tsx

–ù–ê–ô–¢–ò:
if (isLoading) {
  return <p>Loading recommendations...</p>
}

–ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê:
if (isLoading) {
  return (
    <Card>
      <CardHeader>
        <Skeleton className="h-6 w-48" />
        <Skeleton className="h-4 w-64 mt-2" />
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {[1, 2, 3].map(i => (
            <Skeleton key={i} className="h-24 w-full" />
          ))}
        </div>
      </CardContent>
    </Card>
  );
}

–ò–ú–ü–û–†–¢:
import { Skeleton } from '@/components/ui/skeleton';

–§–ê–ô–õ–´:
‚îî‚îÄ client/src/components/ai/price-recommendations.tsx (+10 —Å—Ç—Ä–æ–∫)
```

-----

### **–ó–ê–î–ê–ß–ê 5.3: E2E TESTING (30 –º–∏–Ω—É—Ç)**

```
–¶–ï–õ–¨: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ß–¢–û –¢–ï–°–¢–ò–†–û–í–ê–¢–¨:

1. Receipt Upload:
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —á–µ–∫–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤
   - –£–±–µ–¥–∏—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ –ë–î

2. Price Recommendations:
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å 2+ —á–µ–∫–∞ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—è–≤–∏–ª–∏—Å—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - –£–±–µ–¥–∏—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ—Ç —ç–∫–æ–Ω–æ–º–∏—é

3. AI Chat:
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç AI
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å –∏—Å—Ç–æ—Ä–∏—è

4. UI Cleanup:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ 1 –≤–∫–ª–∞–¥–∫–∞ AI Analysis
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Training History —Å–ø—Ä—è—Ç–∞–Ω–∞

CHECKLIST:
‚ñ° Receipt upload —Ä–∞–±–æ—Ç–∞–µ—Ç
‚ñ° –¢–æ–≤–∞—Ä—ã –ø–∞—Ä—Å—è—Ç—Å—è
‚ñ° Recommendations –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
‚ñ° Chat –æ—Ç–≤–µ—á–∞–µ—Ç
‚ñ° –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
‚ñ° UI —á–∏—Å—Ç—ã–π
‚ñ° –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

–í–†–ï–ú–Ø: 30 –º–∏–Ω—É—Ç
```

-----

## üìä –§–ò–ù–ê–õ–¨–ù–´–ô –ß–ï–ö–õ–ò–°–¢

```
–°–ü–†–ò–ù–¢ 1: –ü–û–î–ì–û–¢–û–í–ö–ê ‚úÖ
‚îú‚îÄ 1.1: Cleanup UI (15 –º–∏–Ω)
‚îú‚îÄ 1.2: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (30 –º–∏–Ω)
‚îî‚îÄ 1.3: –ú–∏–≥—Ä–∞—Ü–∏—è (15 –º–∏–Ω)

–°–ü–†–ò–ù–¢ 2: RECEIPT ITEMS ‚úÖ
‚îú‚îÄ 2.1: Repository (30 –º–∏–Ω)
‚îú‚îÄ 2.2: OCR Parser (1 —á–∞—Å)
‚îú‚îÄ 2.3: API Endpoint (30 –º–∏–Ω)
‚îî‚îÄ 2.4: UI Integration (1 —á–∞—Å)

–°–ü–†–ò–ù–¢ 3: PRICE COMPARISON ‚úÖ
‚îú‚îÄ 3.1: Service (1 —á–∞—Å)
‚îú‚îÄ 3.2: UI Component (1 —á–∞—Å)
‚îî‚îÄ 3.3: Integration (30 –º–∏–Ω)

–°–ü–†–ò–ù–¢ 4: AI CHAT ‚úÖ
‚îú‚îÄ 4.1: Chat Service (1 —á–∞—Å)
‚îú‚îÄ 4.2: Context Builder (1 —á–∞—Å)
‚îú‚îÄ 4.3: UI Component (1.5 —á–∞—Å–∞)
‚îî‚îÄ 4.4: Integration (30 –º–∏–Ω)

–°–ü–†–ò–ù–¢ 5: POLISH ‚úÖ
‚îú‚îÄ 5.1: Error Handling (30 –º–∏–Ω)
‚îú‚îÄ 5.2: Loading States (30 –º–∏–Ω)
‚îî‚îÄ 5.3: E2E Testing (30 –º–∏–Ω)

–ò–¢–û–ì–û: 12 —á–∞—Å–æ–≤, 17 –∑–∞–¥–∞—á
```

-----

## üéØ –ö–ê–ö –î–ê–í–ê–¢–¨ –ó–ê–î–ê–ß–ò REPLIT

```
–§–û–†–ú–ê–¢:

"–ó–ê–î–ê–ß–ê X.Y: [–ù–ê–ó–í–ê–ù–ò–ï]

–¶–ï–õ–¨: [—á—Ç–æ –¥–µ–ª–∞–µ–º]

–ß–¢–û –î–ï–õ–ê–¢–¨:
[–ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è]

–ö–û–î:
[–≤–µ—Å—å –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é]

–§–ê–ô–õ–´:
[—Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤]

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
[—á—Ç–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º]"

–ü–†–ò–ú–ï–†:
"–ó–ê–î–ê–ß–ê 1.1: CLEANUP UI

–¶–ï–õ–¨: –£–±—Ä–∞—Ç—å AI Training –∏–∑ sidebar

–ß–¢–û –î–ï–õ–ê–¢–¨:
1. –û—Ç–∫—Ä—ã—Ç—å app-sidebar.tsx
2. –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫ AI Training
3. –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ AI Analysis

–ö–û–î:
[–∫–æ–¥ –∑–¥–µ—Å—å]

–§–ê–ô–õ–´:
‚îî‚îÄ app-sidebar.tsx (-5 —Å—Ç—Ä–æ–∫)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –¢–æ–ª—å–∫–æ UI, –ª–æ–≥–∏–∫–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç—Å—è"
```

-----

## üí™ –ì–û–¢–û–í –ù–ê–ß–ò–ù–ê–¢–¨?

**–° –ö–ê–ö–û–ì–û –°–ü–†–ò–ù–¢–ê –°–¢–ê–†–¢–£–ï–ú?**

**A.** –°–ø—Ä–∏–Ω—Ç 1 (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞) - 1 —á–∞—Å  
**B.** –°—Ä–∞–∑—É –≤—Å–µ –ø–æ –ø–æ—Ä—è–¥–∫—É  
**C.** –¢–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

**–ì–û–í–û–†–ò –ù–û–ú–ï–† –ò –ù–ê–ß–ò–ù–ê–ï–ú!** üöÄ‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã