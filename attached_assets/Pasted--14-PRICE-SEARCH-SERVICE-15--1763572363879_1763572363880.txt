ğŸ“Š Ğ¨ĞĞ“ 14: PRICE SEARCH SERVICE - Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ (15 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ—ĞĞ”ĞĞ§Ğ 14.1: Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ£ Ğ”Ğ›Ğ¯ AI ĞŸĞĞ˜Ğ¡ĞšĞ Ğ¦Ğ•Ğ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ Ğ¤ĞĞ™Ğ›: server/services/price-search.service.ts

import { priceSearchReportsRepository } from '../repositories/price-search-reports.repository';
import { productCatalogRepository } from '../repositories/product-catalog.repository';

interface SearchResult {
  store: string;
  price: number;
  url: string;
  availability: string;
}

// AI Ğ¿Ğ¾Ğ¸ÑĞº Ñ†ĞµĞ½ (Ğ¿Ğ¾ĞºĞ° Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°)
export async function searchBestPrice(params: {
  productId: number;
  userApiKey?: string;
}): Promise<number> {
  const { productId, userApiKey } = params;
  
  const product = await productCatalogRepository.findById(productId);
  
  if (!product) {
    throw new Error('Product not found');
  }
  
  // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ pending
  const report = await priceSearchReportsRepository.create({
    productId,
    userId: product.userId,
    status: 'pending',
    searchQuery: product.name,
    searchMethod: 'ai',
    currentPrice: product.bestPrice || '0'
  });
  
  // TODO: Ğ’ ÑˆĞ°Ğ³Ğµ 15 Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ AI Ğ¿Ğ¾Ğ¸ÑĞº
  // ĞŸĞ¾ĞºĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ mock Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
  const mockResults: SearchResult[] = [
    {
      store: 'ĞĞ·Ğ¾Ğ½',
      price: parseFloat(product.bestPrice || '100') * 0.9,
      url: 'https://ozon.ru',
      availability: 'Ğ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸'
    },
    {
      store: 'Wildberries',
      price: parseFloat(product.bestPrice || '100') * 0.95,
      url: 'https://wildberries.ru',
      availability: 'Ğ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸'
    }
  ];
  
  // ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ»ÑƒÑ‡ÑˆÑƒÑ Ñ†ĞµĞ½Ñƒ
  const best = mockResults.reduce((min, r) => 
    r.price < min.price ? r : min
  );
  
  // ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
  await priceSearchReportsRepository.update(report.id, {
    status: 'completed',
    results: mockResults,
    bestPrice: best.price.toString(),
    bestStore: best.store,
    bestUrl: best.url,
    savings: (parseFloat(product.bestPrice || '0') - best.price).toString(),
    savingsPercent: (
      ((parseFloat(product.bestPrice || '0') - best.price) / 
       parseFloat(product.bestPrice || '1')) * 100
    ).toString()
  });
  
  return report.id;
}

Ğ¡Ğ¢Ğ ĞĞš: ~80 âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞĞ–Ğ˜Ğ”ĞĞ•ĞœĞ«Ğ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢:
âœ… Mock Ğ¿Ğ¾Ğ¸ÑĞº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ğ·Ğ°Ğ¼ĞµĞ½Ğµ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ AI