üåç –ü–û–õ–ù–´–ô –ü–õ–ê–ù: –ú–£–õ–¨–¢–ò–í–ê–õ–Æ–¢–ù–ê–Ø –°–ò–°–¢–ï–ú–ê

markdown# üí± –ú–£–õ–¨–¢–ò–í–ê–õ–Æ–¢–ù–ê–Ø –°–ò–°–¢–ï–ú–ê: –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

## üéØ –ö–û–ù–¶–ï–ü–¶–ò–Ø

**–ü—Ä–∏–Ω—Ü–∏–ø:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –≤ –°–í–û–ï–ô –≤–∞–ª—é—Ç–µ (IDR, RUB, USD)
- –°–∏—Å—Ç–µ–º–∞ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ USD
- –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º—ã –≤ USD
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≤–∞–ª—é—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º)

**–ó–∞—á–µ–º —Ç–∞–∫:**
- ‚úÖ –ï–¥–∏–Ω–∞—è –±–∞–∑–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤ (USD)
- ‚úÖ –¢–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

---

## üóÑÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ë–ê–ó–ï –î–ê–ù–ù–´–•

### 1. –¢–∞–±–ª–∏—Ü–∞ transactions
```sql
-- –û–ë–ù–û–í–ò —Å—Ö–µ–º—É:
CREATE TABLE transactions (
  id SERIAL PRIMARY KEY,
  userId INTEGER REFERENCES users(id) ON DELETE CASCADE,
  
  date DATE NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
  
  -- –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø —Å—É–º–º–∞ (–∫–∞–∫ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
  amount DECIMAL(10,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',  -- 'USD', 'RUB', 'IDR'
  
  -- –ö–û–ù–í–ï–†–¢–ò–†–û–í–ê–ù–ù–ê–Ø —Å—É–º–º–∞ (–¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤):
  amountUsd DECIMAL(10,2) NOT NULL,
  exchangeRate DECIMAL(10,6) NOT NULL,   -- –ö—É—Ä—Å –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è
  
  description TEXT NOT NULL,
  category TEXT,
  source TEXT DEFAULT 'manual',
  
  createdAt TIMESTAMP DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
CREATE INDEX idx_transactions_userId ON transactions(userId);
CREATE INDEX idx_transactions_date ON transactions(date);
CREATE INDEX idx_transactions_currency ON transactions(currency);
```

### 2. –¢–∞–±–ª–∏—Ü–∞ wallets
```sql
-- –û–ë–ù–û–í–ò —Å—Ö–µ–º—É:
CREATE TABLE wallets (
  id SERIAL PRIMARY KEY,
  userId INTEGER REFERENCES users(id) ON DELETE CASCADE,
  
  name TEXT NOT NULL,
  type TEXT NOT NULL,
  
  -- –ë–∞–ª–∞–Ω—Å –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–∞–ª—é—Ç–µ:
  balance DECIMAL(10,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',
  
  -- –ë–∞–ª–∞–Ω—Å –≤ USD (–¥–ª—è –æ–±—â–µ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞):
  balanceUsd DECIMAL(10,2) NOT NULL,
  lastExchangeRate DECIMAL(10,6),
  rateUpdatedAt TIMESTAMP,
  
  isActive BOOLEAN DEFAULT true,
  createdAt TIMESTAMP DEFAULT NOW()
);
```

### 3. –¢–∞–±–ª–∏—Ü–∞ recurring
```sql
CREATE TABLE recurring (
  id SERIAL PRIMARY KEY,
  userId INTEGER REFERENCES users(id) ON DELETE CASCADE,
  
  type TEXT NOT NULL,
  
  -- –°—É–º–º–∞ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–∞–ª—é—Ç–µ:
  amount DECIMAL(10,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',
  
  description TEXT NOT NULL,
  category TEXT,
  frequency TEXT NOT NULL,
  nextDate DATE NOT NULL,
  
  isActive BOOLEAN DEFAULT true,
  createdAt TIMESTAMP DEFAULT NOW()
);
```

### 4. –¢–∞–±–ª–∏—Ü–∞ wishlist
```sql
CREATE TABLE wishlist (
  id SERIAL PRIMARY KEY,
  userId INTEGER REFERENCES users(id) ON DELETE CASCADE,
  
  name TEXT NOT NULL,
  
  -- –¶–µ–ª—å –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–∞–ª—é—Ç–µ:
  amount DECIMAL(10,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',
  
  targetDate DATE,
  priority TEXT DEFAULT 'medium',
  isPurchased BOOLEAN DEFAULT false,
  
  createdAt TIMESTAMP DEFAULT NOW()
);
```

### 5. –¢–∞–±–ª–∏—Ü–∞ exchange_rates (–ö–≠–®–ò–†–û–í–ê–ù–ò–ï)
```sql
-- –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫—É—Ä—Å–æ–≤:
CREATE TABLE exchange_rates (
  id SERIAL PRIMARY KEY,
  
  baseCurrency TEXT NOT NULL DEFAULT 'USD',
  targetCurrency TEXT NOT NULL,
  rate DECIMAL(10,6) NOT NULL,
  
  fetchedAt TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(baseCurrency, targetCurrency)
);

-- –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ):
INSERT INTO exchange_rates (targetCurrency, rate) VALUES
  ('USD', 1.000000),
  ('RUB', 90.500000),
  ('IDR', 15600.000000);
```

### 6. –¢–∞–±–ª–∏—Ü–∞ settings (–î–û–ë–ê–í–¨ –≤–∞–ª—é—Ç—É)
```sql
-- –û–ë–ù–û–í–ò:
ALTER TABLE settings ADD COLUMN defaultCurrency TEXT DEFAULT 'USD';
```

---

## üîß BACKEND: Currency Service

### –°–æ–∑–¥–∞–π: server/services/currency/
```typescript
// server/services/currency/exchange-rate.service.ts

import { db } from '../../db/client';
import { exchangeRates } from '../../db/schema';
import { eq, and } from 'drizzle-orm';

const EXCHANGE_RATE_API = 'https://api.exchangerate-api.com/v4/latest/USD';
const CACHE_DURATION_MS = 60 * 60 * 1000; // 1 —á–∞—Å

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤–∞–ª—é—Ç—ã
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–∞–∑ –≤ —á–∞—Å
 */
export async function getExchangeRate(
  fromCurrency: string,
  toCurrency: string = 'USD'
): Promise {
  // –ï—Å–ª–∏ –æ–±–µ –≤–∞–ª—é—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ:
  if (fromCurrency === toCurrency) {
    return 1.0;
  }
  
  // –ï—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –í –¥–æ–ª–ª–∞—Ä—ã (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π —Å–ª—É—á–∞–π):
  if (toCurrency === 'USD') {
    return await getRateToUsd(fromCurrency);
  }
  
  // –ï—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ò–ó –¥–æ–ª–ª–∞—Ä–æ–≤:
  if (fromCurrency === 'USD') {
    const rate = await getRateToUsd(toCurrency);
    return 1 / rate; // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
  }
  
  // –ï—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–µ–∂–¥—É –¥–≤—É–º—è –Ω–µ-USD –≤–∞–ª—é—Ç–∞–º–∏:
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ USD: RUB ‚Üí USD ‚Üí IDR
  const fromToUsd = await getRateToUsd(fromCurrency);
  const toToUsd = await getRateToUsd(toCurrency);
  return toToUsd / fromToUsd;
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å –≤–∞–ª—é—Ç—ã –∫ USD
 * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
 */
async function getRateToUsd(currency: string): Promise {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à:
  const cached = await db
    .select()
    .from(exchangeRates)
    .where(
      and(
        eq(exchangeRates.baseCurrency, 'USD'),
        eq(exchangeRates.targetCurrency, currency)
      )
    )
    .limit(1);
  
  // –ï—Å–ª–∏ –∫—ç—à —Å–≤–µ–∂–∏–π (< 1 —á–∞—Å–∞):
  if (cached.length > 0) {
    const age = Date.now() - cached[0].fetchedAt.getTime();
    if (age < CACHE_DURATION_MS) {
      return Number(cached[0].rate);
    }
  }
  
  // –ò–Ω–∞—á–µ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å API:
  try {
    const response = await fetch(EXCHANGE_RATE_API);
    const data = await response.json();
    
    if (!data.rates || !data.rates[currency]) {
      throw new Error(`Currency ${currency} not found`);
    }
    
    const rate = data.rates[currency];
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à:
    await db
      .insert(exchangeRates)
      .values({
        baseCurrency: 'USD',
        targetCurrency: currency,
        rate,
        fetchedAt: new Date()
      })
      .onConflictDoUpdate({
        target: [exchangeRates.baseCurrency, exchangeRates.targetCurrency],
        set: {
          rate,
          fetchedAt: new Date()
        }
      });
    
    return rate;
  } catch (error) {
    console.error('Failed to fetch exchange rate:', error);
    
    // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à:
    if (cached.length > 0) {
      console.warn(`Using stale exchange rate for ${currency}`);
      return Number(cached[0].rate);
    }
    
    // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ–ª–±—ç–∫:
    const fallback = {
      'USD': 1.0,
      'RUB': 90.0,
      'IDR': 15600.0
    };
    
    return fallback[currency] || 1.0;
  }
}

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É–º–º—É –∏–∑ –æ–¥–Ω–æ–π –≤–∞–ª—é—Ç—ã –≤ –¥—Ä—É–≥—É—é
 */
export async function convertCurrency(
  amount: number,
  fromCurrency: string,
  toCurrency: string = 'USD'
): Promise {
  const rate = await getExchangeRate(fromCurrency, toCurrency);
  const convertedAmount = amount / rate;
  
  return {
    amount: convertedAmount,
    rate
  };
}
```
```typescript
// server/services/currency/index.ts
export * from './exchange-rate.service';
```

---

## üìù –û–ë–ù–û–í–ò ROUTES

### server/routes/transactions/create.ts
```typescript
import { Request, Response } from 'express';
import { db } from '../../db/client';
import { transactions } from '../../db/schema';
import { convertCurrency } from '../../services/currency';

/**
 * –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
 * POST /api/transactions
 */
export async function createTransaction(req: Request, res: Response) {
  try {
    const userId = req.user.id;
    const { type, amount, currency, description, category, date } = req.body;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è:
    if (!type || !amount || !description) {
      return res.status(400).json({ error: 'Missing required fields' });
    }
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ USD:
    const { amount: amountUsd, rate: exchangeRate } = await convertCurrency(
      amount,
      currency || 'USD',
      'USD'
    );
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
    const [transaction] = await db
      .insert(transactions)
      .values({
        userId,
        type,
        amount,
        currency: currency || 'USD',
        amountUsd,
        exchangeRate,
        description,
        category,
        date: date || new Date().toISOString().split('T')[0]
      })
      .returning();
    
    res.status(201).json(transaction);
  } catch (error) {
    console.error('Failed to create transaction:', error);
    res.status(500).json({ error: 'Failed to create transaction' });
  }
}
```

### server/routes/wallets/create.ts
```typescript
import { Request, Response } from 'express';
import { db } from '../../db/client';
import { wallets } from '../../db/schema';
import { convertCurrency } from '../../services/currency';

/**
 * –°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª—ë–∫
 * POST /api/wallets
 */
export async function createWallet(req: Request, res: Response) {
  try {
    const userId = req.user.id;
    const { name, type, balance, currency } = req.body;
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ USD:
    const { amount: balanceUsd, rate: lastExchangeRate } = await convertCurrency(
      balance || 0,
      currency || 'USD',
      'USD'
    );
    
    const [wallet] = await db
      .insert(wallets)
      .values({
        userId,
        name,
        type,
        balance: balance || 0,
        currency: currency || 'USD',
        balanceUsd,
        lastExchangeRate,
        rateUpdatedAt: new Date()
      })
      .returning();
    
    res.status(201).json(wallet);
  } catch (error) {
    res.status(500).json({ error: 'Failed to create wallet' });
  }
}
```

### server/routes/wallets/update-balances.ts (–ù–û–í–´–ô!)
```typescript
import { Request, Response } from 'express';
import { db } from '../../db/client';
import { wallets } from '../../db/schema';
import { convertCurrency } from '../../services/currency';
import { eq } from 'drizzle-orm';

/**
 * –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã –∫–æ—à–µ–ª—å–∫–æ–≤ (–ø–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É –∫—É—Ä—Å—É)
 * POST /api/wallets/refresh-rates
 */
export async function refreshWalletRates(req: Request, res: Response) {
  try {
    const userId = req.user.id;
    
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–æ—à–µ–ª—å–∫–∏:
    const userWallets = await db
      .select()
      .from(wallets)
      .where(eq(wallets.userId, userId));
    
    // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–∂–¥—ã–π:
    for (const wallet of userWallets) {
      if (wallet.currency === 'USD') continue; // –ù–µ –Ω—É–∂–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
      
      const { amount: balanceUsd, rate: lastExchangeRate } = await convertCurrency(
        Number(wallet.balance),
        wallet.currency,
        'USD'
      );
      
      await db
        .update(wallets)
        .set({
          balanceUsd,
          lastExchangeRate,
          rateUpdatedAt: new Date()
        })
        .where(eq(wallets.id, wallet.id));
    }
    
    res.json({ message: 'Rates updated successfully' });
  } catch (error) {
    res.status(500).json({ error: 'Failed to refresh rates' });
  }
}
```

---

## üé® FRONTEND: –û–±–Ω–æ–≤–∏ UI

### 1. –§–æ—Ä–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```tsx
// components/transactions/TransactionForm.tsx

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from '@/components/ui/select';

const CURRENCIES = [
  { value: 'USD', label: '$ USD', symbol: '$' },
  { value: 'RUB', label: '‚ÇΩ RUB', symbol: '‚ÇΩ' },
  { value: 'IDR', label: 'Rp IDR', symbol: 'Rp' }
];

export function TransactionForm({ onSuccess }: { onSuccess?: () => void }) {
  const queryClient = useQueryClient();
  const { register, handleSubmit, watch, setValue } = useForm({
    defaultValues: {
      type: 'expense',
      amount: '',
      currency: 'USD',
      description: '',
      category: '',
      date: new Date().toISOString().split('T')[0]
    }
  });
  
  // –ü–æ–ª—É—á–∏—Ç—å –≤–∞–ª—é—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫:
  const { data: settings } = useQuery({
    queryKey: ['/api/settings']
  });
  
  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∞–ª—é—Ç—É –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:
  useState(() => {
    if (settings?.defaultCurrency) {
      setValue('currency', settings.defaultCurrency);
    }
  }, [settings]);
  
  const selectedCurrency = watch('currency');
  const currencySymbol = CURRENCIES.find(c => c.value === selectedCurrency)?.symbol || '$';
  
  const createMutation = useMutation({
    mutationFn: async (data) => {
      const res = await fetch('/api/transactions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      
      if (!res.ok) throw new Error('Failed to create transaction');
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/transactions'] });
      queryClient.invalidateQueries({ queryKey: ['/api/wallets'] });
      onSuccess?.();
    }
  });
  
  const onSubmit = (data) => {
    createMutation.mutate({
      ...data,
      amount: parseFloat(data.amount)
    });
  };
  
  return (
    
      {/* Type */}
      
        Type
        <Select
          value={watch('type')}
          onValueChange={(value) => setValue('type', value)}
        >
          
            
          
          
            Income
            Expense
          
        
      
      
      {/* Amount + Currency */}
      
        Amount
        
          
            
              {currencySymbol}
            
            
          
          
          <Select
            value={selectedCurrency}
            onValueChange={(value) => setValue('currency', value)}
          >
            
              
            
            
              {CURRENCIES.map(curr => (
                
                  {curr.label}
                
              ))}
            
          
        
      
      
      {/* Description */}
      
        Description
        
      
      
      {/* Category */}
      
        Category (Optional)
        
      
      
      {/* Date */}
      
        Date
        
      
      
      {/* Buttons */}
      
        
          Cancel
        
        
          Add Transaction
        
      
    
  );
}
```

### 2. –£—Ç–∏–ª–∏—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```typescript
// utils/formatters/formatCurrency.ts

const CURRENCY_FORMATS = {
  USD: { symbol: '$', locale: 'en-US' },
  RUB: { symbol: '‚ÇΩ', locale: 'ru-RU' },
  IDR: { symbol: 'Rp', locale: 'id-ID' }
};

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—É–º–º—É –≤ –≤–∞–ª—é—Ç–µ
 * @param amount - –°—É–º–º–∞
 * @param currency - –í–∞–ª—é—Ç–∞ (USD/RUB/IDR)
 * @returns –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
 */
export function formatCurrency(amount: number, currency: string = 'USD'): string {
  const format = CURRENCY_FORMATS[currency] || CURRENCY_FORMATS['USD'];
  
  const formatted = new Intl.NumberFormat(format.locale, {
    style: 'currency',
    currency: currency,
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(amount);
  
  return formatted;
}
```

### 3. Dashboard - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ USD
```tsx
// pages/Dashboard.tsx

import { useQuery } from '@tanstack/react-query';
import { formatCurrency } from '@/utils/formatters';
import { calculateIncome, calculateExpense } from '@/utils/calculations';

export function Dashboard() {
  const { data: transactions = [] } = useQuery({
    queryKey: ['/api/transactions']
  });
  
  // –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –≤ USD (–∏–∑ –ø–æ–ª—è amountUsd):
  const totalIncome = transactions
    .filter(t => t.type === 'income')
    .reduce((sum, t) => sum + Number(t.amountUsd), 0);
  
  const totalExpense = transactions
    .filter(t => t.type === 'expense')
    .reduce((sum, t) => sum + Number(t.amountUsd), 0);
  
  const balance = totalIncome - totalExpense;
  
  return (
    
      
        Total Income
        
          {formatCurrency(totalIncome, 'USD')}
        
      
      
      
        Total Expense
        
          {formatCurrency(totalExpense, 'USD')}
        
      
      
      
        Balance
        
          {formatCurrency(balance, 'USD')}
        
      
    
  );
}
```

### 4. Settings - –≤—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```tsx
// pages/Settings.tsx

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Select } from '@/components/ui/select';

export function Settings() {
  const queryClient = useQueryClient();
  
  const { data: settings } = useQuery({
    queryKey: ['/api/settings']
  });
  
  const updateMutation = useMutation({
    mutationFn: async (data) => {
      const res = await fetch('/api/settings', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/settings'] });
    }
  });
  
  return (
    
      Settings
      
      
        Default Currency
        <Select
          value={settings?.defaultCurrency || 'USD'}
          onValueChange={(value) => {
            updateMutation.mutate({ defaultCurrency: value });
          }}
        >
          
            
          
          
            $ USD
            ‚ÇΩ RUB
            Rp IDR
          
        
        
          This will be used as default when creating transactions
        
      
    
  );
}
```

---

## üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–£–†–°–û–í

### Cron job –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```typescript
// server/jobs/update-exchange-rates.ts

import { CronJob } from 'cron';
import { db } from '../db/client';
import { wallets } from '../db/schema';
import { convertCurrency } from '../services/currency';

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—Å–µ—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ –∫–∞–∂–¥—ã–π —á–∞—Å
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
 */
export function startExchangeRateJob() {
  const job = new CronJob(
    '0 * * * *', // –ö–∞–∂–¥—ã–π —á–∞—Å
    async () => {
      console.log('Updating wallet exchange rates...');
      
      try {
        const allWallets = await db
          .select()
          .from(wallets)
          .where(ne(wallets.currency, 'USD'));
        
        for (const wallet of allWallets) {
          const { amount: balanceUsd, rate: lastExchangeRate } = 
            await convertCurrency(
              Number(wallet.balance),
              wallet.currency,
              'USD'
            );
          
          await db
            .update(wallets)
            .set({
              balanceUsd,
              lastExchangeRate,
              rateUpdatedAt: new Date()
            })
            .where(eq(wallets.id, wallet.id));
        }
        
        console.log(`Updated ${allWallets.length} wallets`);
      } catch (error) {
        console.error('Failed to update exchange rates:', error);
      }
    },
    null,
    true,
    'UTC'
  );
  
  job.start();
}
```
```typescript
// server/index.ts

import { startExchangeRateJob } from './jobs/update-exchange-rates';

// ... –¥—Ä—É–≥–æ–π –∫–æ–¥ ...

// –ó–∞–ø—É—Å–∫–∞–µ–º cron job:
startExchangeRateJob();
console.log('Exchange rate job started');
```

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

### Backend:
- [ ] –¢–∞–±–ª–∏—Ü–∞ exchange_rates —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ü–æ–ª—è amountUsd, currency –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ transactions
- [ ] –ü–æ–ª—è balanceUsd, currency –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ wallets
- [ ] Currency service —Å–æ–∑–¥–∞–Ω (exchange-rate.service.ts)
- [ ] Routes –æ–±–Ω–æ–≤–ª–µ–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç convertCurrency)
- [ ] Cron job –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –∑–∞–ø—É—â–µ–Ω
- [ ] API endpoint /api/wallets/refresh-rates —Å–æ–∑–¥–∞–Ω

### Frontend:
- [ ] Select –≤–∞–ª—é—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ–æ—Ä–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- [ ] –°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã ($, ‚ÇΩ, Rp) –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] formatCurrency() —É—Ç–∏–ª–∏—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Intl
- [ ] Settings –∏–º–µ–µ—Ç –≤—ã–±–æ—Ä defaultCurrency
- [ ] Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Å—É–º–º—ã –≤ USD
- [ ] Wallets –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –±–∞–ª–∞–Ω—Å—ã —Å –≤–∞–ª—é—Ç–∞–º–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ RUB ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å amountUsd
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ IDR ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å amountUsd
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª—ë–∫ –≤ RUB ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å balanceUsd
- [ ] Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π total
- [ ] –ü—Ä–æ–≥–Ω–æ–∑—ã —É—á–∏—Ç—ã–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ USD —Å—É–º–º—ã
- [ ] –ö—É—Ä—Å—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î)
- [ ] –ö—É—Ä—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ä–∞–∑ –≤ —á–∞—Å

---

## üéØ –ö–†–ò–¢–ï–†–ò–ô –£–°–ü–ï–•–ê

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
1. –í—ã–±–∏—Ä–∞–µ—Ç –≤–∞–ª—é—Ç—É RUB
2. –í–≤–æ–¥–∏—Ç 1000 ‚ÇΩ
3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–æ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ ~$11 USD
4. Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç $11 –≤ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
5. –ö—É—Ä—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π —á–∞—Å
6. –ö–æ—à–µ–ª—å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –±–∞–ª–∞–Ω—Å –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–∞–ª—é—Ç–µ + USD

**–í–°–Å –†–ê–ë–û–¢–ê–ï–¢!** ‚úÖ

---

–î–ï–ô–°–¢–í–£–ô! –†–ï–ê–õ–ò–ó–£–ô –ü–û –®–ê–ì–ê–ú! üí™