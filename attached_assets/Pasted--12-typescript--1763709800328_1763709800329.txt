–®–ê–ì 12: –°–û–ó–î–ê–¢–¨ –ü–û–î–†–û–ë–ù–£–Æ –°–¢–†–ê–ù–ò–¶–£ –ê–ö–¢–ò–í–ê
typescript‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ó–ê–î–ê–ß–ê: –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞
–§–ê–ô–õ: client/src/pages/asset-detail.tsx
–°–¢–†–û–ö: ~195
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–û–ó–î–ê–ô –§–ê–ô–õ: client/src/pages/asset-detail.tsx

–°–û–î–ï–†–ñ–ò–ú–û–ï:

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useRoute, Link } from 'wouter';
import { ArrowLeft, TrendingUp, TrendingDown, DollarSign, Edit, Trash2 } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';
import type { Asset, AssetValuation } from '@/lib/types/assets';

export default function AssetDetailPage() {
  const [, params] = useRoute('/assets/:id');
  const assetId = params?.id ? parseInt(params.id) : null;
  const queryClient = useQueryClient();
  const [showCalibration, setShowCalibration] = useState(false);
  
  // –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤
  const { data, isLoading } = useQuery({
    queryKey: ['/api/assets', assetId],
    queryFn: async () => {
      const res = await fetch(`/api/assets/${assetId}`);
      if (!res.ok) throw new Error('Failed to fetch asset');
      const json = await res.json();
      return json.data;
    },
    enabled: !!assetId
  });
  
  const asset: Asset | undefined = data?.asset;
  const valuations: AssetValuation[] = data?.valuations || [];
  const change = data?.change;
  
  // –£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤
  const deleteMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch(`/api/assets/${assetId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Failed to delete');
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/assets'] });
      window.location.href = '/assets';
    }
  });
  
  if (isLoading) {
    return (
      <div className="max-w-4xl mx-auto px-4 py-8">
        <p className="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      </div>
    );
  }
  
  if (!asset) {
    return (
      <div className="max-w-4xl mx-auto px-4 py-8">
        <p className="text-center text-gray-500">–ê–∫—Ç–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
        <div className="text-center mt-4">
          <Link href="/assets" className="text-blue-600 hover:underline">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∞–∫—Ç–∏–≤–∞–º
          </Link>
        </div>
      </div>
    );
  }
  
  const currentValue = parseFloat(asset.currentValue);
  const isPositive = (change?.changePercent || 0) >= 0;
  const monthlyCashflow = parseFloat(asset.monthlyIncome || '0') - parseFloat(asset.monthlyExpense || '0');
  
  // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
  const chartData = valuations.map(v => ({
    date: v.valuationDate,
    value: parseFloat(v.value)
  })).reverse();
  
  const handleDelete = () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–∫—Ç–∏–≤?')) {
      deleteMutation.mutate();
    }
  };
  
  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
      <Link href="/assets" className="flex items-center gap-2 text-blue-600 hover:underline mb-6">
        <ArrowLeft size={20} />
        –ù–∞–∑–∞–¥ –∫ –∞–∫—Ç–∏–≤–∞–º
      </Link>
      
      {/* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */}
      {asset.imageUrl && (
        <div className="mb-6 rounded-lg overflow-hidden">
          <img src={asset.imageUrl} alt={asset.name} className="w-full h-64 object-cover" />
        </div>
      )}
      
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
      <div className="flex items-start justify-between mb-6">
        <div>
          <div className="flex items-center gap-2 mb-2">
            <span className={`px-2 py-1 rounded text-sm font-medium ${
              asset.type === 'asset' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`}>
              {asset.type === 'asset' ? 'üìà –ê–∫—Ç–∏–≤' : 'üìâ –ü–∞—Å—Å–∏–≤'}
            </span>
          </div>
          <h1 className="text-3xl font-bold mb-1">{asset.name}</h1>
          {asset.location && (
            <p className="text-gray-600">{asset.location}</p>
          )}
        </div>
        
        <div className="flex gap-2">
          <button className="p-2 hover:bg-gray-100 rounded">
            <Edit size={20} />
          </button>
          <button 
            onClick={handleDelete}
            className="p-2 hover:bg-red-50 text-red-600 rounded"
          >
            <Trash2 size={20} />
          </button>
        </div>
      </div>
      
      {/* –¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <p className="text-sm text-gray-600 mb-2">–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</p>
        <p className="text-4xl font-bold mb-4">
          ${currentValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}
        </p>
        
        {change && change.changePercent !== 0 && (
          <div className={`flex items-center gap-2 ${
            isPositive ? 'text-green-600' : 'text-red-600'
          }`}>
            {isPositive ? <TrendingUp size={20} /> : <TrendingDown size={20} />}
            <span className="font-semibold">
              {isPositive ? '+' : ''}{change.changePercent.toFixed(1)}% 
              ({isPositive ? '+' : ''}${change.changeAmount.toFixed(0)})
            </span>
            {change.ownershipYears > 0 && (
              <span className="text-gray-500">
                –∑–∞ {change.ownershipYears} {change.ownershipYears === 1 ? '–≥–æ–¥' : '–ª–µ—Ç'}
              </span>
            )}
          </div>
        )}
        
        <div className="mt-4 flex gap-2">
          <button
            onClick={() => setShowCalibration(true)}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            üîß –ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É
          </button>
          <button
            className="px-4 py-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200"
            title="–°–∫–æ—Ä–æ"
          >
            ü§ñ –ù–∞–π—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
          </button>
        </div>
      </div>
      
      {/* –ì—Ä–∞—Ñ–∏–∫ */}
      {chartData.length > 1 && (
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <h2 className="text-xl font-semibold mb-4">–ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã</h2>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={chartData}>
              <XAxis dataKey="date" />
              <YAxis />
              <Tooltip 
                formatter={(value: number) => `$${value.toLocaleString()}`}
              />
              <Line 
                type="monotone" 
                dataKey="value" 
                stroke={isPositive ? '#10b981' : '#ef4444'} 
                strokeWidth={2}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}
      
      {/* Cashflow */}
      {(parseFloat(asset.monthlyIncome || '0') > 0 || parseFloat(asset.monthlyExpense || '0') > 0) && (
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <h2 className="text-xl font-semibold mb-4">–î–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫</h2>
          
          <div className="space-y-3">
            {parseFloat(asset.monthlyIncome || '0') > 0 && (
              <div className="flex justify-between">
                <span className="text-gray-600">–î–æ—Ö–æ–¥ –≤ –º–µ—Å—è—Ü:</span>
                <span className="font-semibold text-green-600">
                  +${parseFloat(asset.monthlyIncome).toFixed(0)}
                </span>
              </div>
            )}
            
            {parseFloat(asset.monthlyExpense || '0') > 0 && (
              <div className="flex justify-between">
                <span className="text-gray-600">–†–∞—Å—Ö–æ–¥ –≤ –º–µ—Å—è—Ü:</span>
                <span className="font-semibold text-red-600">
                  -${parseFloat(asset.monthlyExpense).toFixed(0)}
                </span>
              </div>
            )}
            
            <div className="flex justify-between pt-3 border-t">
              <span className="font-semibold">–ß–∏—Å—Ç—ã–π cashflow:</span>
              <span className={`font-bold text-lg ${
                monthlyCashflow >= 0 ? 'text-green-600' : 'text-red-600'
              }`}>
                {monthlyCashflow >= 0 ? '+' : ''}${monthlyCashflow.toFixed(0)}/–º–µ—Å
              </span>
            </div>
            
            {change && change.ownershipYears > 0 && (
              <div className="flex justify-between text-sm text-gray-600 pt-2 border-t">
                <span>–í—Å–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–æ –∑–∞ –≤–ª–∞–¥–µ–Ω–∏–µ:</span>
                <span>
                  ${(monthlyCashflow * 12 * change.ownershipYears).toFixed(0)}
                </span>
              </div>
            )}
          </div>
        </div>
      )}
      
      {/* –ó–∞–º–µ—Ç–∫–∏ */}
      {asset.notes && (
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-semibold mb-4">–ó–∞–º–µ—Ç–∫–∏</h2>
          <p className="text-gray-700 whitespace-pre-wrap">{asset.notes}</p>
        </div>
      )}
      
      {/* –ú–æ–¥–∞–ª–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ */}
      {showCalibration && (
        <CalibrationModal
          asset={asset}
          onClose={() => setShowCalibration(false)}
          onSuccess={() => {
            queryClient.invalidateQueries({ queryKey: ['/api/assets', assetId] });
            setShowCalibration(false);
          }}
        />
      )}
    </div>
  );
}

// –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–∞–ª–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ (–ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–µ–ª–∞–µ–º –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ)
function CalibrationModal({ asset, onClose, onSuccess }: any) {
  const [newValue, setNewValue] = useState(asset.currentValue);
  const [notes, setNotes] = useState('');
  const [loading, setLoading] = useState(false);
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      const res = await fetch(`/api/assets/${asset.id}/calibrate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newValue, notes, source: 'manual' })
      });
      
      if (!res.ok) throw new Error('Failed to calibrate');
      onSuccess();
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-md w-full p-6">
        <h2 className="text-xl font-bold mb-4">–ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É</h2>
        
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-sm font-medium mb-2">–ù–æ–≤–∞—è —Ü–µ–Ω–∞ (USD)</label>
            <input
              type="number"
              step="0.01"
              required
              value={newValue}
              onChange={(e) => setNewValue(e.target.value)}
              className="w-full px-3 py-2 border rounded"
            />
          </div>
          
          <div className="mb-4">
            <label className="block text-sm font-medium mb-2">–ò—Å—Ç–æ—á–Ω–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input
              type="text"
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="–ê–≤–∏—Ç–æ, –¶–ò–ê–ù, –æ—Ü–µ–Ω—â–∏–∫..."
              className="w-full px-3 py-2 border rounded"
            />
          </div>
          
          <div className="flex gap-3">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 border rounded hover:bg-gray-50"
            >
              –û—Ç–º–µ–Ω–∞
            </button>
            <button
              type="submit"
              disabled={loading}
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
            >
              {loading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–û—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

–ü–†–û–í–ï–†–ö–ê:
‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω
‚úÖ –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –î–µ—Ç–∞–ª–∏ –∞–∫—Ç–∏–≤–∞ –≤–∏–¥–Ω—ã