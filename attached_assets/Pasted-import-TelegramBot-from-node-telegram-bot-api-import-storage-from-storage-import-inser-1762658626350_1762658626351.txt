import TelegramBot from 'node-telegram-bot-api';
import { storage } from './storage';
import { insertDailyTransactionSchema, budgetLimits } from '@shared/schema';
import { convertRubToUsd, convertUsdToRub, getExchangeRateInfo } from './currency-service';
import { logger } from './logger';
import { parseExpenseMessage, detectCategory, ParsedExpense } from './telegram-parser';
import { Currency, ExpenseCategory } from './telegram-config';
import { OcrService } from './ocr-service';
import { AnalyticsService } from './analytics-service';
import { aiService } from './ai-service';
import { gamificationService } from './gamification-service';
import fs from 'fs/promises';
import OpenAI from 'openai';
import { db } from './db';
import { eq } from 'drizzle-orm';

const token = process.env.TELEGRAM_BOT_TOKEN;

if (!token) {
  logger.error('TELEGRAM_BOT_TOKEN not found in environment variables');
  process.exit(1);
}

// –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
export const bot = new TelegramBot(token, { 
  polling: {
    interval: 1000, // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    autoStart: false, // –ó–∞–ø—É—Å—Ç–∏–º –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫
    params: {
      timeout: 30 // –¢–∞–π–º–∞—É—Ç –¥–ª—è long polling –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    }
  }
});

// –ö–∞—Ä—Ç–∞ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ –Ω–∞—à–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
const telegramUserMap = new Map<number, number>();

// –ö–∞—Ä—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥
const userStates = new Map<number, { action: string; data?: any }>();

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è retry –ª–æ–≥–∏–∫–æ–π
let isPollingStarted = false;
let restartAttempts = 0;
let restartTimeoutId: NodeJS.Timeout | null = null;
const MAX_RESTART_ATTEMPTS = 3;
const RESTART_DELAY = 5000; // 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ polling
async function startPolling() {
  if (isPollingStarted) {
    logger.info('Polling already started, skipping');
    return;
  }
  
  try {
    // Ensure any previous polling is stopped
    try {
      await bot.stopPolling();
    } catch (e) {
      // Ignore stopPolling errors if already stopped
    }
    
    // Clear pending updates manually via deleteWebHook
    try {
      await bot.deleteWebHook();
    } catch (e) {
      // Ignore webhook errors
    }
    
    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for cleanup
    
    await bot.startPolling();
    isPollingStarted = true;
    restartAttempts = 0;
    logger.info('Telegram bot polling started');
  } catch (error) {
    logger.error('Failed to start polling', error instanceof Error ? error : new Error(String(error)));
    if (restartAttempts < MAX_RESTART_ATTEMPTS) {
      scheduleRestart();
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ polling
async function stopPolling() {
  if (!isPollingStarted) return;
  
  try {
    await bot.stopPolling();
    isPollingStarted = false;
    logger.info('Telegram bot polling stopped');
  } catch (error) {
    logger.error('Error stopping polling', error instanceof Error ? error : new Error(String(error)));
    isPollingStarted = false; // Mark as stopped anyway
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
function scheduleRestart() {
  // Clear any existing restart timeout
  if (restartTimeoutId) {
    clearTimeout(restartTimeoutId);
    restartTimeoutId = null;
  }
  
  if (restartAttempts >= MAX_RESTART_ATTEMPTS) {
    logger.error(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (${MAX_RESTART_ATTEMPTS}) –ø—Ä–µ–≤—ã—à–µ–Ω–æ. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞.`);
    return;
  }
  
  restartAttempts++;
  logger.info(`–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ ${RESTART_DELAY}ms (–ø–æ–ø—ã—Ç–∫–∞ ${restartAttempts}/${MAX_RESTART_ATTEMPTS})`);
  
  restartTimeoutId = setTimeout(async () => {
    logger.info(`–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${restartAttempts}/${MAX_RESTART_ATTEMPTS})`);
    await stopPolling();
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∏ –∑–∞–ø—É—Å–∫–æ–º
    await new Promise(resolve => setTimeout(resolve, 1000));
    await startPolling();
  }, RESTART_DELAY);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—é–¥–∂–µ—Ç–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
async function checkBudgetLimitsAndNotify(
  chatId: number,
  userId: number,
  category: string | null,
  transactionAmount: number
) {
  if (!category) return; // –ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ - –Ω–µ—á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å
  
  try {
    const budgets = await storage.getBudgetLimits(userId);
    const budget = budgets.find(b => b.category.name === category);
    
    if (!budget || !budget.isActive || !budget.enableTelegramNotifications) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ spent
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
    
    const transactions = await storage.getDailyTransactions(userId, monthStart, monthEnd);
    const categoryTransactions = transactions.filter(t => 
      t.type === 'expense' && t.category === category
    );
    
    const totalSpent = categoryTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const limit = parseFloat(budget.monthlyLimit);
    const percentage = (totalSpent / limit) * 100;
    
    // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º currentSpent –∏ percentageUsed
    const now_ts = new Date();
    const updateData: any = {
      currentSpent: totalSpent.toString(),
      percentageUsed: percentage.toFixed(2)
    };
    
    const lastWarning = budget.lastWarningAt ? new Date(budget.lastWarningAt) : null;
    const lastAlert = budget.lastAlertAt ? new Date(budget.lastAlertAt) : null;
    
    const alertThreshold = budget.alertThreshold || 100;
    const warningThreshold = budget.warningThreshold || 80;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º 100% –ø–æ—Ä–æ–≥
    if (percentage >= alertThreshold) {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
      const shouldNotify = !lastAlert || 
        lastAlert.getMonth() !== now_ts.getMonth() ||
        lastAlert.getFullYear() !== now_ts.getFullYear();
        
      if (shouldNotify) {
        const message = `üî¥ *–ü–†–ï–í–´–®–ï–ù –ë–Æ–î–ñ–ï–¢!*\n\n` +
          `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: *${category}*\n` +
          `–õ–∏–º–∏—Ç: $${limit.toFixed(2)}\n` +
          `–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: $${totalSpent.toFixed(2)} (${percentage.toFixed(0)}%)\n` +
          `–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ: $${(totalSpent - limit).toFixed(2)}\n\n` +
          `‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!`;
        
        await bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
        updateData.lastAlertAt = now_ts;
      }
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º 80% –ø–æ—Ä–æ–≥
    else if (percentage >= warningThreshold) {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
      const shouldNotify = !lastWarning || 
        lastWarning.getMonth() !== now_ts.getMonth() ||
        lastWarning.getFullYear() !== now_ts.getFullYear();
        
      if (shouldNotify) {
        const remaining = limit - totalSpent;
        const message = `‚ö†Ô∏è *–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±—é–¥–∂–µ—Ç–µ*\n\n` +
          `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: *${category}*\n` +
          `–õ–∏–º–∏—Ç: $${limit.toFixed(2)}\n` +
          `–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: $${totalSpent.toFixed(2)} (${percentage.toFixed(0)}%)\n` +
          `–û—Å—Ç–∞–ª–æ—Å—å: $${remaining.toFixed(2)}\n\n` +
          `üí° –í—ã –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç–µ—Å—å –∫ –ª–∏–º–∏—Ç—É!`;
        
        await bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
        updateData.lastWarningAt = now_ts;
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    await db.update(budgetLimits)
      .set(updateData)
      .where(eq(budgetLimits.id, budget.id));
    
  } catch (error) {
    logger.error('Error checking budget limits', error instanceof Error ? error : new Error(String(error)));
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
export function initializeTelegramBot() {
  logger.info('Telegram bot initialized');
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OCR —Å–µ—Ä–≤–∏—Å
  const ocrService = new OcrService();
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Analytics —Å–µ—Ä–≤–∏—Å
  const analyticsService = new AnalyticsService(storage);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenAI –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞
  const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
  });
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Telegram
  loadExistingTelegramUsers();

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
  bot.onText(/\/start/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const existingUserId = telegramUserMap.get(telegramUserId);
    let isAuthenticated = false;
    
    if (existingUserId) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ
      const user = await storage.getUser(existingUserId);
      if (user) {
        isAuthenticated = true;
      } else {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã, —É–¥–∞–ª—è–µ–º –∏–∑ –∫–∞—Ä—Ç—ã
        telegramUserMap.delete(telegramUserId);
      }
    }
    
    const welcomeMessage = isAuthenticated 
      ? `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ! üëã 

üìù –í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∏ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥—ã:
‚Ä¢ "–∫–æ—Ñ–µ 200‚ÇΩ" ‚Üí 200‚ÇΩ –∑–∞ –∫–æ—Ñ–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ "coffee $5 –≤—á–µ—Ä–∞" ‚Üí $5 –∑–∞ –∫–æ—Ñ–µ –Ω–∞ –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
‚Ä¢ "–æ–±–µ–¥ 1500‚ÇΩ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" ‚Üí 1500‚ÇΩ –∑–∞ –æ–±–µ–¥ –≤ –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
‚Ä¢ "—Ç–∞–∫—Å–∏ 50$ 25 —Å–µ–Ω—Ç—è–±—Ä—è" ‚Üí $50 –∑–∞ —Ç–∞–∫—Å–∏ –Ω–∞ 25.09
‚Ä¢ "–ø—Ä–æ–¥—É–∫—Ç—ã 800‚ÇΩ 25.09" ‚Üí 800‚ÇΩ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ 25.09

üìÖ **–ù–û–í–û–ï!** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∞—Ç:
‚Ä¢ –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ: "–≤—á–µ—Ä–∞", "–ø–æ–∑–∞–≤—á–µ—Ä–∞", "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫"
‚Ä¢ –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ: "25.09", "1 –æ–∫—Ç—è–±—Ä—è", "25 —Å–µ–Ω—Ç—è–±—Ä—è 2025"

üí± –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ä—É–±–ª–∏ (‚ÇΩ) –∏ –¥–æ–ª–ª–∞—Ä—ã ($) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π!
üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è!
üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è!

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞! ‚¨áÔ∏è`
      : `–ü—Ä–∏–≤–µ—Ç! üëã –Ø TogetherBudget –±–æ—Ç –¥–ª—è —É—á–µ—Ç–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤.

üîê –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å:
1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç TogetherBudget
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /auth <—Ç–æ–∫–µ–Ω>

üìù –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –¥–∞—Ç—ã:
‚Ä¢ "–∫–æ—Ñ–µ 200‚ÇΩ" ‚Üí 200‚ÇΩ –∑–∞ –∫–æ—Ñ–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ "–æ–±–µ–¥ $15 –≤—á–µ—Ä–∞" ‚Üí $15 –∑–∞ –æ–±–µ–¥ –Ω–∞ –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
‚Ä¢ "—Ç–∞–∫—Å–∏ 300‚ÇΩ –≤ —Å—Ä–µ–¥—É" ‚Üí 300‚ÇΩ –∑–∞ —Ç–∞–∫—Å–∏ –≤ –±–ª–∏–∂–∞–π—à—É—é —Å—Ä–µ–¥—É
‚Ä¢ "–ø—Ä–æ–¥—É–∫—Ç—ã 50$ 25.09" ‚Üí $50 –∑–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ 25 —Å–µ–Ω—Ç—è–±—Ä—è

üìÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∞—Ç: "–≤—á–µ—Ä–∞", "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "25.09", "1 –æ–∫—Ç—è–±—Ä—è"
üí± –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ä—É–±–ª–∏ (‚ÇΩ) –∏ –¥–æ–ª–ª–∞—Ä—ã ($) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π!
üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è!
üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è!`;
    
    // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const keyboard = isAuthenticated ? {
      keyboard: [
        [{ text: 'üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥' }, { text: 'üí∞ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥' }],
        [{ text: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' }, { text: '‚ùì –ü–æ–º–æ—â—å' }]
      ],
      resize_keyboard: true,
      persistent: true
    } : { remove_keyboard: true };
    
    bot.sendMessage(chatId, welcomeMessage, {
      reply_markup: keyboard
    });
  });

  // –ö–æ–º–∞–Ω–¥–∞ /menu –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  bot.onText(/\/menu/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    const menuKeyboard = {
      keyboard: [
        [{ text: 'üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥' }, { text: 'üí∞ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥' }],
        [{ text: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' }, { text: '‚ùì –ü–æ–º–æ—â—å' }]
      ],
      resize_keyboard: true,
      persistent: true
    };
    
    bot.sendMessage(chatId, 'üì± –ú–µ–Ω—é –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º.', {
      reply_markup: menuKeyboard
    });
  });

  // –ö–æ–º–∞–Ω–¥–∞ /auth –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω
  bot.onText(/\/auth (.+)/, async (msg, match) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    const authToken = match?.[1]?.trim();
    
    if (!telegramUserId) return;
    
    if (!authToken) {
      bot.sendMessage(chatId, "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.\n–ü—Ä–∏–º–µ—Ä: /auth abc123");
      return;
    }
    
    try {
      // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É
      const users = await storage.getUsers();
      const user = users.find(u => u.authToken === authToken);
      
      if (!user) {
        bot.sendMessage(chatId, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.");
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –ª–∏ —É–∂–µ –¥—Ä—É–≥–æ–π Telegram –∞–∫–∫–∞—É–Ω—Ç
      if (user.telegramId && user.telegramId !== telegramUserId.toString()) {
        bot.sendMessage(chatId, "‚ùå –≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.");
        return;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º telegramId –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      await storage.updateUser(user.id, { telegramId: telegramUserId.toString() });
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–∞—Ä—Ç–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
      telegramUserMap.set(telegramUserId, user.id);
      
      // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const authKeyboard = {
        keyboard: [
          [{ text: 'üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥' }, { text: 'üí∞ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥' }],
          [{ text: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' }, { text: '‚ùì –ü–æ–º–æ—â—å' }]
        ],
        resize_keyboard: true,
        persistent: true
      };

      bot.sendMessage(chatId, `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.name}
üìß Email: ${user.email}

üìù –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥—ã:
‚Ä¢ "–∫–æ—Ñ–µ 200" 
‚Ä¢ "–ø—Ä–æ–¥—É–∫—Ç—ã 1500‚ÇΩ"
‚Ä¢ üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ üì∏ –§–æ—Ç–æ —á–µ–∫–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞! ‚¨áÔ∏è`, {
        reply_markup: authKeyboard
      });
      
    } catch (error) {
      logger.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
  bot.onText(/\/help/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const isAuthenticated = telegramUserMap.has(telegramUserId);
    
    const helpMessage = isAuthenticated 
      ? `üìö *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º TogetherBudget*

üìù *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤:*
‚Ä¢ "–∫–æ—Ñ–µ 200‚ÇΩ" ‚Üí –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ "–æ–±–µ–¥ $15 –≤—á–µ—Ä–∞" ‚Üí –Ω–∞ –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É  
‚Ä¢ "—Ç–∞–∫—Å–∏ 300‚ÇΩ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" ‚Üí –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
‚Ä¢ "–ø—Ä–æ–¥—É–∫—Ç—ã 50$ 25.09" ‚Üí –Ω–∞ 25 —Å–µ–Ω—Ç—è–±—Ä—è
‚Ä¢ üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ üì∏ –§–æ—Ç–æ —á–µ–∫–æ–≤

üìä *–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:*
/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
/week - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
/month - –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü
/year - –≥–æ–¥–æ–≤–æ–π –æ–±–∑–æ—Ä
/compare - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∏ –ø—Ä–æ—à–ª–æ–≥–æ –º–µ—Å—è—Ü–∞
/trends - –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤
/categories - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

ü§ñ *AI –ê–Ω–∞–ª–∏–∑:*
/analyze - —É–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤
/predict - –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∏ —Å–æ–≤–µ—Ç—ã –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º

üí∞ *–ë—é–¥–∂–µ—Ç—ã:*
/budget <–∫–∞—Ç–µ–≥–æ—Ä–∏—è> <–ª–∏–º–∏—Ç> - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç
/budgets - –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –±—é–¥–∂–µ—Ç–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤

üèÜ *–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è:*
/achievements - –≤–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
/challenges - –∞–∫—Ç–∏–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏
/streaks - —Å—Ç—Ä–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

‚öôÔ∏è *–û–±—â–µ–µ:*
/status - —Å—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞
/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

üí± *–í–∞–ª—é—Ç—ã:* ‚ÇΩ (—Ä—É–±–ª–∏) –∏ $ (–¥–æ–ª–ª–∞—Ä—ã)
üîÑ *–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:* –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è`
      : `üìö *–°–ø—Ä–∞–≤–∫–∞ –ø–æ TogetherBudget*

üîê *–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã:*
1. –í–æ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç TogetherBudget
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏  
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /auth <—Ç–æ–∫–µ–Ω>

üìù *–ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:*
‚Ä¢ –î–æ–±–∞–≤–ª—è–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã: "–∫–æ—Ñ–µ 200‚ÇΩ"
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∞—Ç—ã: "–æ–±–µ–¥ $15 –≤—á–µ—Ä–∞"
‚Ä¢ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ –§–æ—Ç–æ —á–µ–∫–æ–≤
‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: /stats

üìÖ *–§–æ—Ä–º–∞—Ç—ã –¥–∞—Ç:* "–≤—á–µ—Ä–∞", "–≤ —Å—Ä–µ–¥—É", "25.09", "1 –æ–∫—Ç—è–±—Ä—è"

‚ùì *–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?* –ù–∞–ø–∏—à–∏—Ç–µ /help –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏`;

    bot.sendMessage(chatId, helpMessage, { parse_mode: 'Markdown' });
  });

  // –ö–æ–º–∞–Ω–¥–∞ /status –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
  bot.onText(/\/status/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, `‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
      
üîê –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /auth <—Ç–æ–∫–µ–Ω>`);
      return;
    }
    
    try {
      const user = await storage.getUser(appUserId);
      
      if (!user) {
        telegramUserMap.delete(telegramUserId);
        bot.sendMessage(chatId, '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.');
        return;
      }
      
      const statusMessage = `‚úÖ –°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞:

üë§ –ò–º—è: ${user.name}
üìß Email: ${user.email}
üîó Telegram: –ø–æ–¥–∫–ª—é—á–µ–Ω

üìù –ì–æ—Ç–æ–≤ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤!`;

      bot.sendMessage(chatId, statusMessage);
      
    } catch (error) {
      logger.error('Error checking status', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /reset_password –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
  bot.onText(/\/reset_password/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    bot.sendMessage(chatId, `üîê *–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è*

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à email –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.

üìß –ü—Ä–∏–º–µ—Ä: kraftinvesting@gmail.com`, { parse_mode: 'Markdown' });
    
    // Set user state to waiting for email
    userStates.set(telegramUserId, { action: 'reset_password_waiting_email' });
  });

  // –ö–æ–º–∞–Ω–¥–∞ /stats –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
  bot.onText(/\/stats/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const today = new Date().toISOString().split('T')[0];
      const transactions = await storage.getDailyTransactions(appUserId, today, today);
      
      const expenses = transactions.filter(t => t.type === 'expense');
      const incomes = transactions.filter(t => t.type === 'income');
      
      const totalExpenses = expenses.reduce((sum, t) => sum + Number(t.amount), 0);
      const totalIncomes = incomes.reduce((sum, t) => sum + Number(t.amount), 0);
      
      const statsMessage = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è (${today}):

üí∏ **–†–∞—Å—Ö–æ–¥—ã:** $${totalExpenses.toFixed(2)} (${expenses.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
üí∞ **–î–æ—Ö–æ–¥—ã:** $${totalIncomes.toFixed(2)} (${incomes.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
üìà **–ë–∞–ª–∞–Ω—Å:** $${(totalIncomes - totalExpenses).toFixed(2)}

${expenses.length > 0 ? '\nüìù **–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã:**' : ''}${expenses.slice(-3).map(t => `\n‚Ä¢ $${Number(t.amount).toFixed(2)} - ${t.description}`).join('')}`;

      bot.sendMessage(chatId, statsMessage);
      
    } catch (error) {
      logger.error('Error getting stats', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /week –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é
  bot.onText(/\/week/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(today.getDate() - 7);
      
      const startDate = weekAgo.toISOString().split('T')[0];
      const endDate = today.toISOString().split('T')[0];
      
      const transactions = await storage.getDailyTransactions(appUserId, startDate, endDate);
      
      const expenses = transactions.filter(t => t.type === 'expense');
      const incomes = transactions.filter(t => t.type === 'income');
      
      const totalExpenses = expenses.reduce((sum, t) => sum + Number(t.amount), 0);
      const totalIncomes = incomes.reduce((sum, t) => sum + Number(t.amount), 0);
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      const expensesByCategory = expenses.reduce((acc, t) => {
        const category = t.category || '–†–∞–∑–Ω–æ–µ';
        acc[category] = (acc[category] || 0) + Number(t.amount);
        return acc;
      }, {} as Record<string, number>);
      
      const topCategories = Object.entries(expensesByCategory)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3);
      
      const statsMessage = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é (${startDate} - ${endDate}):

üí∏ **–†–∞—Å—Ö–æ–¥—ã:** $${totalExpenses.toFixed(2)} (${expenses.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
üí∞ **–î–æ—Ö–æ–¥—ã:** $${totalIncomes.toFixed(2)} (${incomes.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
üìà **–ë–∞–ª–∞–Ω—Å:** $${(totalIncomes - totalExpenses).toFixed(2)}

üìä **–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:**${topCategories.map(([cat, amount]) => `\n‚Ä¢ ${cat}: $${amount.toFixed(2)}`).join('')}

üìÖ **–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å:** $${(totalExpenses / 7).toFixed(2)}`;

      bot.sendMessage(chatId, statsMessage);
      
    } catch (error) {
      logger.error('Error getting week stats', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /month –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
  bot.onText(/\/month/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const now = new Date();
      const monthStats = await analyticsService.getMonthStats(appUserId, now.getFullYear(), now.getMonth() + 1);
      
      if (!monthStats) {
        bot.sendMessage(chatId, '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü');
        return;
      }
      
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                          '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
      
      const topCategories = monthStats.topCategories.slice(0, 5);
      
      let message = `üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ ${monthNames[now.getMonth()]} ${now.getFullYear()}*\n\n`;
      
      message += `üí∞ *–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ–±–∑–æ—Ä:*\n`;
      message += `‚Ä¢ –†–∞—Å—Ö–æ–¥—ã: $${monthStats.totalExpenses.toFixed(2)}\n`;
      message += `‚Ä¢ –î–æ—Ö–æ–¥—ã: $${monthStats.totalIncome.toFixed(2)}\n`;
      message += `‚Ä¢ –ë–∞–ª–∞–Ω—Å: $${monthStats.balance.toFixed(2)}\n`;
      message += `‚Ä¢ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è: $${(monthStats.totalIncome - monthStats.totalExpenses).toFixed(2)}\n\n`;
      
      message += `üìä *–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:*\n`;
      message += `‚Ä¢ –í—Å–µ–≥–æ: ${monthStats.transactionCount}\n`;
      message += `‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: $${monthStats.avgDailyExpense.toFixed(2)}\n\n`;
      
      if (topCategories.length > 0) {
        message += `üèÜ *–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:*\n`;
        topCategories.forEach((cat: { category: string; amount: number; percentage: number }, idx: number) => {
          message += `${idx + 1}. ${cat.category}: $${cat.amount.toFixed(2)} (${cat.percentage.toFixed(1)}%)\n`;
        });
        message += '\n';
      }
      
      if (monthStats.dayByDayExpenses.length > 0) {
        const maxDay = monthStats.dayByDayExpenses.reduce((max, day) => day.amount > max.amount ? day : max);
        const minDay = monthStats.dayByDayExpenses.filter(d => d.amount > 0).reduce((min, day) => day.amount < min.amount ? day : min, monthStats.dayByDayExpenses[0]);
        
        message += `üìà *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º:*\n`;
        message += `‚Ä¢ –ú–∞–∫—Å. —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: $${maxDay.amount.toFixed(2)} (${maxDay.date})\n`;
        if (minDay && minDay.amount > 0) {
          message += `‚Ä¢ –ú–∏–Ω. —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: $${minDay.amount.toFixed(2)} (${minDay.date})\n`;
        }
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting month stats', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –º–µ—Å—è—Ü');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /year –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –≥–æ–¥
  bot.onText(/\/year/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const now = new Date();
      const yearStats = await analyticsService.getYearStats(appUserId, now.getFullYear());
      
      if (!yearStats) {
        bot.sendMessage(chatId, '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –≥–æ–¥');
        return;
      }
      
      const topCategories = yearStats.topCategories.slice(0, 5);
      
      let message = `üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ ${now.getFullYear()} –≥–æ–¥*\n\n`;
      
      message += `üí∞ *–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ–±–∑–æ—Ä:*\n`;
      message += `‚Ä¢ –†–∞—Å—Ö–æ–¥—ã: $${yearStats.totalExpenses.toFixed(2)}\n`;
      message += `‚Ä¢ –î–æ—Ö–æ–¥—ã: $${yearStats.totalIncome.toFixed(2)}\n`;
      message += `‚Ä¢ –ë–∞–ª–∞–Ω—Å: $${yearStats.balance.toFixed(2)}\n`;
      message += `‚Ä¢ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è: $${(yearStats.totalIncome - yearStats.totalExpenses).toFixed(2)}\n\n`;
      
      message += `üìä *–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:*\n`;
      message += `‚Ä¢ –í—Å–µ–≥–æ: ${yearStats.transactionCount}\n`;
      message += `‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: $${yearStats.avgDailyExpense.toFixed(2)}\n`;
      message += `‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –º–µ—Å—è—Ü: $${(yearStats.totalExpenses / 12).toFixed(2)}\n\n`;
      
      if (topCategories.length > 0) {
        message += `üèÜ *–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≥–æ–¥:*\n`;
        topCategories.forEach((cat: { category: string; amount: number; percentage: number }, idx: number) => {
          message += `${idx + 1}. ${cat.category}: $${cat.amount.toFixed(2)} (${cat.percentage.toFixed(1)}%)\n`;
        });
        message += '\n';
      }
      
      if (yearStats.dayByDayExpenses.length > 0) {
        const maxDay = yearStats.dayByDayExpenses.reduce((max, day) => day.amount > max.amount ? day : max);
        const minDay = yearStats.dayByDayExpenses.filter(d => d.amount > 0).reduce((min, day) => day.amount < min.amount ? day : min, yearStats.dayByDayExpenses[0]);
        
        message += `üìà *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º:*\n`;
        message += `‚Ä¢ –ú–∞–∫—Å. —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: $${maxDay.amount.toFixed(2)} (${maxDay.date})\n`;
        if (minDay && minDay.amount > 0) {
          message += `‚Ä¢ –ú–∏–Ω. —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: $${minDay.amount.toFixed(2)} (${minDay.date})\n`;
        }
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting year stats', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –≥–æ–¥');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /compare –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ —Å –ø—Ä–æ—à–ª—ã–º
  bot.onText(/\/compare/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const now = new Date();
      const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
      const currentMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
      
      const previousMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
      const previousMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
      
      const comparison = await analyticsService.comparePeriods(appUserId, currentMonthStart, currentMonthEnd, previousMonthStart, previousMonthEnd);
      
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                          '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
      
      const currentMonth = monthNames[now.getMonth()];
      const previousMonth = monthNames[(now.getMonth() - 1 + 12) % 12];
      
      let message = `üìä *–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${currentMonth} vs ${previousMonth}*\n\n`;
      
      message += `üí∏ *–†–∞—Å—Ö–æ–¥—ã:*\n`;
      message += `‚Ä¢ –¢–µ–∫—É—â–∏–π: $${comparison.current.totalExpenses.toFixed(2)}\n`;
      message += `‚Ä¢ –ü—Ä–æ—à–ª—ã–π: $${comparison.previous.totalExpenses.toFixed(2)}\n`;
      message += `‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${comparison.changes.expensesChange > 0 ? '+' : ''}$${comparison.changes.expensesChange.toFixed(2)} (${comparison.changes.expensesChangePercent > 0 ? '+' : ''}${comparison.changes.expensesChangePercent.toFixed(1)}%)\n\n`;
      
      message += `üí∞ *–î–æ—Ö–æ–¥—ã:*\n`;
      message += `‚Ä¢ –¢–µ–∫—É—â–∏–π: $${comparison.current.totalIncome.toFixed(2)}\n`;
      message += `‚Ä¢ –ü—Ä–æ—à–ª—ã–π: $${comparison.previous.totalIncome.toFixed(2)}\n`;
      message += `‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${comparison.changes.incomeChange > 0 ? '+' : ''}$${comparison.changes.incomeChange.toFixed(2)} (${comparison.changes.incomeChangePercent > 0 ? '+' : ''}${comparison.changes.incomeChangePercent.toFixed(1)}%)\n\n`;
      
      message += `üìà *–ë–∞–ª–∞–Ω—Å:*\n`;
      message += `‚Ä¢ –¢–µ–∫—É—â–∏–π: $${comparison.current.balance.toFixed(2)}\n`;
      message += `‚Ä¢ –ü—Ä–æ—à–ª—ã–π: $${comparison.previous.balance.toFixed(2)}\n`;
      message += `‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${comparison.changes.balanceChange > 0 ? '+' : ''}$${comparison.changes.balanceChange.toFixed(2)}\n`;
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error comparing periods', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –ø–µ—Ä–∏–æ–¥–æ–≤');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /trends –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤
  bot.onText(/\/trends/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const trends = await analyticsService.getTrends(appUserId, 3);
      
      let message = `üìà *–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞)*\n\n`;
      
      if (trends.monthlyTrend.length > 0) {
        message += `üìä *–ü–æ–º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:*\n`;
        trends.monthlyTrend.forEach(month => {
          const trendIcon = month.trend === 'up' ? 'üìà' : month.trend === 'down' ? 'üìâ' : '‚û°Ô∏è';
          message += `‚Ä¢ ${month.month}: $${month.totalExpenses.toFixed(2)} ${trendIcon}\n`;
        });
        message += '\n';
      }
      
      const velocityIcon = trends.spendingVelocity === 'increasing' ? '‚ö†Ô∏è –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è' : 
                           trends.spendingVelocity === 'decreasing' ? '‚úÖ –°–Ω–∏–∂–∞–µ—Ç—Å—è' : 
                           '‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω–∞—è';
      message += `‚ö° *–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤:* ${velocityIcon}\n\n`;
      
      if (trends.weekdayPattern.length > 0) {
        message += `üìÖ *–°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏:*\n`;
        const sortedDays = trends.weekdayPattern.sort((a, b) => b.avgExpense - a.avgExpense).slice(0, 3);
        sortedDays.forEach((day, idx) => {
          message += `${idx + 1}. ${day.day}: $${day.avgExpense.toFixed(2)}\n`;
        });
        message += '\n';
      }
      
      if (trends.topSpendingDays.length > 0) {
        message += `üí∞ *–°–∞–º—ã–µ –∑–∞—Ç—Ä–∞—Ç–Ω—ã–µ –¥–Ω–∏:*\n`;
        trends.topSpendingDays.slice(0, 3).forEach((day, idx) => {
          message += `${idx + 1}. ${day.date}: $${day.amount.toFixed(2)}\n   ${day.description}\n`;
        });
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting trends', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–¥–æ–≤');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /categories –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  bot.onText(/\/categories/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
      const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
      
      const categories = await analyticsService.getCategoryBreakdown(appUserId, monthStart, monthEnd);
      
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                          '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
      
      let message = `üìä *–ê–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞ ${monthNames[now.getMonth()]}*\n\n`;
      
      if (categories.length === 0) {
        message += '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü.';
      } else {
        categories.forEach((cat, idx) => {
          const trendIcon = cat.trend === 'up' ? 'üìà' : cat.trend === 'down' ? 'üìâ' : '‚û°Ô∏è';
          message += `*${idx + 1}. ${cat.category}* ${trendIcon}\n`;
          message += `‚Ä¢ –í—Å–µ–≥–æ: $${cat.amount.toFixed(2)} (${cat.percentage.toFixed(1)}%)\n`;
          message += `‚Ä¢ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${cat.transactionCount}\n`;
          message += `‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: $${cat.avgTransactionAmount.toFixed(2)}\n\n`;
        });
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting category breakdown', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /achievements –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
  bot.onText(/\/achievements/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const achievements = await storage.getAchievements(appUserId);
      
      if (achievements.length === 0) {
        bot.sendMessage(chatId, '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π');
        return;
      }
      
      const unlocked = achievements.filter(a => a.isUnlocked);
      const locked = achievements.filter(a => !a.isUnlocked);
      
      let message = `üèÜ *–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è* (${unlocked.length}/${achievements.length})\n\n`;
      
      if (unlocked.length > 0) {
        message += `‚úÖ *–û—Ç–∫—Ä—ã—Ç–æ:*\n`;
        unlocked.forEach(a => {
          message += `üèÖ *${a.title}*\n`;
          message += `   ${a.description}\n`;
          message += `   –û—Ç–∫—Ä—ã—Ç–æ: ${new Date(a.unlockedAt!).toLocaleDateString()}\n\n`;
        });
      }
      
      if (locked.length > 0) {
        message += `üîí *–í –ø—Ä–æ—Ü–µ—Å—Å–µ:*\n`;
        locked.forEach(a => {
          const currentVal = a.currentValue || 0;
          const progress = Math.min((currentVal / a.targetValue) * 100, 100).toFixed(0);
          message += `‚≠ê *${a.title}*\n`;
          message += `   ${a.description}\n`;
          message += `   –ü—Ä–æ–≥—Ä–µ—Å—Å: ${currentVal}/${a.targetValue} (${progress}%)\n\n`;
        });
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting achievements', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /challenges –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
  bot.onText(/\/challenges/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const challenges = await storage.getChallenges(appUserId);
      
      if (challenges.length === 0) {
        bot.sendMessage(chatId, '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π');
        return;
      }
      
      const active = challenges.filter(c => c.status === 'active');
      const completed = challenges.filter(c => c.status === 'completed');
      const failed = challenges.filter(c => c.status === 'failed');
      
      let message = `üéØ *–í–∞—à–∏ —á–µ–ª–ª–µ–Ω–¥–∂–∏*\n\n`;
      
      if (active.length > 0) {
        message += `‚ö° *–ê–∫—Ç–∏–≤–Ω—ã–µ:*\n`;
        active.forEach(c => {
          const currentVal = c.currentValue || '0';
          const progress = Math.min((parseFloat(currentVal) / parseFloat(c.targetValue)) * 100, 100).toFixed(0);
          const daysLeft = Math.ceil((new Date(c.endDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24));
          message += `üî• *${c.title}*\n`;
          message += `   ${c.description}\n`;
          message += `   –ü—Ä–æ–≥—Ä–µ—Å—Å: ${currentVal}/${c.targetValue} (${progress}%)\n`;
          message += `   –û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} –¥–Ω–µ–π\n`;
          message += `   –ù–∞–≥—Ä–∞–¥–∞: ${c.rewardPoints || 0} –æ—á–∫–æ–≤\n\n`;
        });
      }
      
      if (completed.length > 0) {
        message += `‚úÖ *–ó–∞–≤–µ—Ä—à–µ–Ω—ã:*\n`;
        completed.slice(0, 3).forEach(c => {
          message += `üèÜ *${c.title}* - ${c.rewardPoints || 0} –æ—á–∫–æ–≤\n`;
        });
        if (completed.length > 3) {
          message += `   ...–∏ –µ—â–µ ${completed.length - 3}\n`;
        }
        message += '\n';
      }
      
      if (failed.length > 0) {
        message += `‚ùå *–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ:* ${failed.length}\n`;
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting challenges', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /streaks –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–∫—É—â–∏—Ö —Å—Ç—Ä–∏–∫–æ–≤
  bot.onText(/\/streaks/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const streaks = await storage.getActivityStreaks(appUserId);
      
      if (streaks.length === 0) {
        bot.sendMessage(chatId, '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç—Ä–∏–∫–æ–≤');
        return;
      }
      
      let message = `üî• *–í–∞—à–∏ —Å—Ç—Ä–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏*\n\n`;
      
      streaks.forEach(streak => {
        const icon = streak.type === 'daily_tracking' ? 'üìù' : 
                     streak.type === 'budget_adherence' ? 'üí∞' : 
                     streak.type === 'goal_progress' ? 'üéØ' : '‚≠ê';
        
        message += `${icon} *${streak.type.replace(/_/g, ' ')}*\n`;
        message += `   –¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: ${streak.currentStreak || 0} –¥–Ω–µ–π üî•\n`;
        message += `   –õ—É—á—à–∏–π —Å—Ç—Ä–∏–∫: ${streak.longestStreak || 0} –¥–Ω–µ–π üèÜ\n`;
        message += `   –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π: ${streak.totalActiveDays || 0}\n`;
        if (streak.lastActivityDate) {
          message += `   –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${new Date(streak.lastActivityDate).toLocaleDateString()}\n`;
        }
        message += '\n';
      });
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting streaks', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç—Ä–∏–∫–æ–≤');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /analyze –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
  bot.onText(/\/analyze/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∞–Ω–∞–ª–∏–∑–∞
      bot.sendMessage(chatId, 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ —Ñ–∏–Ω–∞–Ω—Å—ã...');
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
      const now = new Date();
      const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1).toISOString().split('T')[0];
      const today = now.toISOString().split('T')[0];
      
      const transactions = await storage.getDailyTransactions(appUserId, threeMonthsAgo, today);
      const goals = await storage.getGoals();
      const user = await storage.getUser(appUserId);
      
      // –í—ã–∑—ã–≤–∞–µ–º AI –∞–Ω–∞–ª–∏–∑ (—Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å user –≤–º–µ—Å—Ç–æ partner)
      const analysis = await aiService.analyzeFinancialData(user ? [user] : [], goals, transactions, appUserId);
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      let message = `ü§ñ *AI –ê–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤*\n\n`;
      
      if (analysis.insights.length > 0) {
        message += `üí° *–û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã:*\n`;
        analysis.insights.forEach((insight, idx) => {
          message += `${idx + 1}. ${insight}\n`;
        });
        message += '\n';
      }
      
      if (analysis.recommendations.length > 0) {
        message += `üìã *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*\n`;
        analysis.recommendations.forEach((rec, idx) => {
          message += `${idx + 1}. ${rec}\n`;
        });
        message += '\n';
      }
      
      if (analysis.expenseOptimization.length > 0) {
        message += `üí∞ *–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤:*\n`;
        analysis.expenseOptimization.forEach(opt => {
          const savings = opt.potentialSavings;
          message += `‚Ä¢ *${opt.category}*: $${opt.currentAmount} ‚Üí $${opt.recommendedAmount}\n`;
          message += `  –≠–∫–æ–Ω–æ–º–∏—è: $${savings.toFixed(2)}/–º–µ—Å\n`;
          message += `  ${opt.reasoning}\n\n`;
        });
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error in AI analysis', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ AI-–∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /predict –¥–ª—è AI-–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤
  bot.onText(/\/predict/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
      bot.sendMessage(chatId, 'üîÆ –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—é –≤–∞—à–∏ —Ä–∞—Å—Ö–æ–¥—ã...');
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      const now = new Date();
      const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, 1).toISOString().split('T')[0];
      const today = now.toISOString().split('T')[0];
      
      const transactions = await storage.getDailyTransactions(appUserId, sixMonthsAgo, today);
      
      if (transactions.length < 10) {
        bot.sendMessage(chatId, '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.');
        return;
      }
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
      const tips = await aiService.generateSmartTips(transactions, appUserId);
      
      let message = `üîÆ *AI –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∏ –°–æ–≤–µ—Ç—ã*\n\n`;
      message += `–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ ${transactions.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤:\n\n`;
      
      if (tips.length > 0) {
        message += `üí° *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*\n`;
        tips.forEach((tip, idx) => {
          message += `${idx + 1}. ${tip}\n\n`;
        });
      }
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error in AI prediction', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /budgets –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –±—é–¥–∂–µ—Ç–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤
  bot.onText(/\/budgets/, async (msg) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    try {
      const budgets = await storage.getBudgetLimits(appUserId);
      
      if (budgets.length === 0) {
        bot.sendMessage(chatId, `üí∞ *–ë—é–¥–∂–µ—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã*\n\n–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /budget <–∫–∞—Ç–µ–≥–æ—Ä–∏—è> <–ª–∏–º–∏—Ç> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è.\n\n*–ü—Ä–∏–º–µ—Ä:*\n/budget –ü—Ä–æ–¥—É–∫—Ç—ã 500`, { parse_mode: 'Markdown' });
        return;
      }
      
      let message = `üí∞ *–í–∞—à–∏ –±—é–¥–∂–µ—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã*\n\n`;
      
      budgets.forEach(budget => {
        const spent = parseFloat(budget.currentSpent || '0');
        const limit = parseFloat(budget.monthlyLimit);
        const percentage = limit > 0 ? (spent / limit) * 100 : 0;
        
        let statusIcon = '‚úÖ';
        if (percentage >= 100) statusIcon = 'üî¥';
        else if (percentage >= 80) statusIcon = '‚ö†Ô∏è';
        else if (percentage >= 50) statusIcon = 'üü°';
        
        message += `${statusIcon} *${budget.category.name}*\n`;
        message += `   –õ–∏–º–∏—Ç: $${limit.toFixed(2)} / –º–µ—Å—è—Ü\n`;
        message += `   –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: $${spent.toFixed(2)} (${percentage.toFixed(0)}%)\n`;
        message += `   –û—Å—Ç–∞–ª–æ—Å—å: $${(limit - spent).toFixed(2)}\n\n`;
      });
      
      message += `\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /budget <–∫–∞—Ç–µ–≥–æ—Ä–∏—è> <–ª–∏–º–∏—Ç> –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è`;
      
      bot.sendMessage(chatId, message, { parse_mode: 'Markdown' });
      
    } catch (error) {
      logger.error('Error getting budgets', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–æ–≤');
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /budget –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏–º–∏—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  bot.onText(/\/budget\s+(.+)\s+(\d+\.?\d*)/, async (msg, match) => {
    const chatId = msg.chat.id;
    const telegramUserId = msg.from?.id;
    
    if (!telegramUserId || !match) return;
    
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: /auth <—Ç–æ–∫–µ–Ω>');
      return;
    }
    
    const categoryName = match[1].trim();
    const limit = parseFloat(match[2]);
    
    if (limit <= 0) {
      bot.sendMessage(chatId, '‚ùå –õ–∏–º–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è');
      return;
    }
    
    try {
      const allCategories = await storage.getCategories(appUserId);
      const category = allCategories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
      
      if (!category) {
        bot.sendMessage(chatId, `‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è "${categoryName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.`);
        return;
      }
      
      const existingBudgets = await storage.getBudgetLimits(appUserId);
      const existingBudget = existingBudgets.find(b => b.categoryId === category.id);
      
      if (existingBudget) {
        await storage.updateBudgetLimit(existingBudget.id, {
          monthlyLimit: limit.toString()
        });
        
        bot.sendMessage(chatId, `‚úÖ –õ–∏–º–∏—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *${category.name}* –æ–±–Ω–æ–≤–ª—ë–Ω!\n\nüí∞ –ù–æ–≤—ã–π –ª–∏–º–∏—Ç: $${limit.toFixed(2)} / –º–µ—Å—è—Ü`, { parse_mode: 'Markdown' });
      } else {
        const couple = await storage.getCoupleByUserId(appUserId);
        
        await storage.createBudgetLimit({
          userId: appUserId,
          coupleId: couple?.id || null,
          categoryId: category.id,
          monthlyLimit: limit.toString(),
          period: 'monthly',
          warningThreshold: 80,
          alertThreshold: 100,
          enableTelegramNotifications: true,
          enableEmailNotifications: false,
          isActive: true
        });
        
        bot.sendMessage(chatId, `‚úÖ –õ–∏–º–∏—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *${category.name}* —Å–æ–∑–¥–∞–Ω!\n\nüí∞ –õ–∏–º–∏—Ç: $${limit.toFixed(2)} / –º–µ—Å—è—Ü\n‚ö†Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: 80% –∏ 100%`, { parse_mode: 'Markdown' });
      }
      
    } catch (error) {
      logger.error('Error setting budget', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ª–∏–º–∏—Ç–∞');
    }
  });


  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –º–µ–¥–∏–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏)
  bot.on('text', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;
    const userId = msg.from?.id;

    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if (text?.startsWith('/')) return;

    if (!userId || !text) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥
    const userState = userStates.get(userId);
    
    if (userState?.action === 'reset_password_waiting_email') {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª email –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
      const email = text.trim().toLowerCase();
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        bot.sendMessage(chatId, '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        return;
      }
      
      try {
        // –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
        const response = await fetch('http://localhost:5000/api/auth/request-password-reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email }),
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
          const resetLink = `http://localhost:5000/reset-password?token=${data.token}`;
          
          bot.sendMessage(chatId, `‚úÖ *–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è —Å–æ–∑–¥–∞–Ω–∞!*

üîó –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è:
${resetLink}

‚è∞ –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞.

üí° –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.`, { parse_mode: 'Markdown' });
        } else {
          bot.sendMessage(chatId, '‚úÖ –ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º email —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.');
        }
        
        // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        userStates.delete(userId);
        
      } catch (error) {
        logger.error('Error requesting password reset', error instanceof Error ? error : new Error(String(error)));
        bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        userStates.delete(userId);
      }
      
      return;
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    if (text === 'üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥') {
      const helpText = `üìù –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥:

–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
‚Ä¢ "–∫–æ—Ñ–µ 200" ‚Üí 200‚ÇΩ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ "–æ–±–µ–¥ $15 –≤—á–µ—Ä–∞" ‚Üí $15 –Ω–∞ –≤—á–µ—Ä–∞
‚Ä¢ "—Ç–∞–∫—Å–∏ 300‚ÇΩ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" ‚Üí 300‚ÇΩ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
‚Ä¢ "–ø—Ä–æ–¥—É–∫—Ç—ã 1500‚ÇΩ 25.09" ‚Üí 1500‚ÇΩ –Ω–∞ 25 —Å–µ–Ω—Ç—è–±—Ä—è

üéôÔ∏è –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
üì∏ –ò–ª–∏ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ —á–µ–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è!`;
      
      bot.sendMessage(chatId, helpText);
      return;
    }

    if (text === 'üí∞ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥') {
      const helpText = `üí∞ –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥:

–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "–¥–æ—Ö–æ–¥" –∏–ª–∏ "income":
‚Ä¢ "–¥–æ—Ö–æ–¥ –∑–∞—Ä–ø–ª–∞—Ç–∞ 50000‚ÇΩ" ‚Üí 50000‚ÇΩ –∑–∞—Ä–ø–ª–∞—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ "income salary $2000 –≤—á–µ—Ä–∞" ‚Üí $2000 –∑–∞—Ä–ø–ª–∞—Ç—ã –Ω–∞ –≤—á–µ—Ä–∞
‚Ä¢ "–¥–æ—Ö–æ–¥ —Ñ—Ä–∏–ª–∞–Ω—Å 30000‚ÇΩ 25.09" ‚Üí 30000‚ÇΩ —Ñ—Ä–∏–ª–∞–Ω—Å–∞ –Ω–∞ 25 —Å–µ–Ω—Ç—è–±—Ä—è

üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è!
üìù –ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏—Ç–µ: "–î–æ—Ö–æ–¥ –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø—è—Ç—å–¥–µ—Å—è—Ç —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π"`;
      
      bot.sendMessage(chatId, helpText);
      return;
    }

    if (text === 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞') {
      // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ /week)
      const appUserId = telegramUserMap.get(userId);
      
      if (!appUserId) {
        bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /auth <—Ç–æ–∫–µ–Ω>');
        return;
      }
      
      try {
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        
        const startDate = weekAgo.toISOString().split('T')[0];
        const endDate = today.toISOString().split('T')[0];
        
        const transactions = await storage.getDailyTransactions(appUserId, startDate, endDate);
        
        const expenses = transactions.filter(t => t.type === 'expense');
        const incomes = transactions.filter(t => t.type === 'income');
        
        const totalExpenses = expenses.reduce((sum, t) => sum + Number(t.amount), 0);
        const totalIncomes = incomes.reduce((sum, t) => sum + Number(t.amount), 0);
        
        const expensesByCategory = expenses.reduce((acc, t) => {
          const category = t.category || '–†–∞–∑–Ω–æ–µ';
          acc[category] = (acc[category] || 0) + Number(t.amount);
          return acc;
        }, {} as Record<string, number>);
        
        const topCategories = Object.entries(expensesByCategory)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 3);
        
        const statsMessage = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é (${startDate} - ${endDate}):

üí∏ **–†–∞—Å—Ö–æ–¥—ã:** $${totalExpenses.toFixed(2)} (${expenses.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
üí∞ **–î–æ—Ö–æ–¥—ã:** $${totalIncomes.toFixed(2)} (${incomes.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
üìà **–ë–∞–ª–∞–Ω—Å:** $${(totalIncomes - totalExpenses).toFixed(2)}

üìä **–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:**${topCategories.map(([cat, amount]) => `\n‚Ä¢ ${cat}: $${amount.toFixed(2)}`).join('')}

üìÖ **–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å:** $${(totalExpenses / 7).toFixed(2)}`;

        bot.sendMessage(chatId, statsMessage);
      } catch (error) {
        logger.error('Error getting stats from button', error instanceof Error ? error : new Error(String(error)));
        bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
      }
      return;
    }

    if (text === '‚ùì –ü–æ–º–æ—â—å') {
      const helpMessage = `üìö –°–ø—Ä–∞–≤–∫–∞ –ø–æ TogetherBudget:

üìù **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤:**
‚Ä¢ "–∫–æ—Ñ–µ 200‚ÇΩ" ‚Üí –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ "–æ–±–µ–¥ $15 –≤—á–µ—Ä–∞" ‚Üí –Ω–∞ –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É  
‚Ä¢ "—Ç–∞–∫—Å–∏ 300‚ÇΩ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" ‚Üí –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
‚Ä¢ "–ø—Ä–æ–¥—É–∫—Ç—ã 50$ 25.09" ‚Üí –Ω–∞ 25 —Å–µ–Ω—Ç—è–±—Ä—è
‚Ä¢ üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ üì∏ –§–æ—Ç–æ —á–µ–∫–æ–≤

üí∞ **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤:**
‚Ä¢ "–¥–æ—Ö–æ–¥ –∑–∞—Ä–ø–ª–∞—Ç–∞ 50000‚ÇΩ" ‚Üí –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ "income salary $2000 –≤—á–µ—Ä–∞" ‚Üí –Ω–∞ –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
‚Ä¢ "–¥–æ—Ö–æ–¥ —Ñ—Ä–∏–ª–∞–Ω—Å 30000‚ÇΩ 25.09" ‚Üí –Ω–∞ 25 —Å–µ–Ω—Ç—è–±—Ä—è
‚Ä¢ üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ: "–î–æ—Ö–æ–¥ –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø—è—Ç—å–¥–µ—Å—è—Ç —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π"

üìÖ **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç:**
‚Ä¢ –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ: "–≤—á–µ—Ä–∞", "–ø–æ–∑–∞–≤—á–µ—Ä–∞", "–≤ —Å—Ä–µ–¥—É"
‚Ä¢ –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ: "25.09", "1 –æ–∫—Ç—è–±—Ä—è", "25/09/2025"

üí° **–ö–æ–º–∞–Ω–¥—ã:**
/menu - –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
/status - —Å—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞
/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
/week - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

üí± **–í–∞–ª—é—Ç—ã:** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è ‚ÇΩ (—Ä—É–±–ª–∏) –∏ $ (–¥–æ–ª–ª–∞—Ä—ã)
üîÑ **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫—É—Ä—Å—É`;
      
      bot.sendMessage(chatId, helpMessage);
      return;
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (text) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –¥–æ—Ö–æ–¥–æ–º
      const lowerText = text.toLowerCase().trim();
      const isIncome = lowerText.startsWith('–¥–æ—Ö–æ–¥ ') || lowerText.startsWith('income ') || 
                       lowerText.startsWith('–¥–æ—Ö–æ–¥:') || lowerText.startsWith('income:');
      
      if (isIncome) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –¥–æ—Ö–æ–¥
        const cleanedText = text.replace(/^(–¥–æ—Ö–æ–¥|income)[:\s]+/i, '').trim();
        await processIncomeMessage(chatId, userId, cleanedText);
      } else {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞—Å—Ö–æ–¥
        await processExpenseMessage(chatId, userId, text);
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  bot.on('voice', async (msg) => {
    const chatId = msg.chat.id;
    const userId = msg.from?.id;
    
    if (!userId) return;

    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      const appUserId = telegramUserMap.get(userId);
      if (!appUserId) {
        bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /auth <—Ç–æ–∫–µ–Ω>');
        return;
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
      const fileId = msg.voice?.file_id;
      if (!fileId) {
        bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
        return;
      }

      bot.sendMessage(chatId, 'üéß –†–∞—Å–ø–æ–∑–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...');
      
      // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑ Telegram
      const file = await bot.getFile(fileId);
      const filePath = file.file_path;
      
      if (!filePath) {
        bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª');
        return;
      }

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      const fileUrl = `https://api.telegram.org/file/bot${token}/${filePath}`;
      const response = await fetch(fileUrl);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = Buffer.from(arrayBuffer);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ –∫–∞–∫ —Ñ–∞–π–ª –¥–ª—è Whisper API
      const tempFilePath = `/tmp/voice_${Date.now()}.ogg`;
      await fs.writeFile(tempFilePath, audioBuffer);

      try {
        // –†–∞—Å–ø–æ–∑–Ω–∞–µ–º –≥–æ–ª–æ—Å —Å –ø–æ–º–æ—â—å—é Whisper API
        const transcription = await openai.audio.transcriptions.create({
          file: await fs.readFile(tempFilePath).then(buffer => 
            new File([buffer], 'audio.ogg', { type: 'audio/ogg' })
          ),
          model: 'whisper-1',
          language: 'ru', // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
          prompt: '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: –¥–æ—Ö–æ–¥, —Ä–∞—Å—Ö–æ–¥, –∑–∞—Ä–ø–ª–∞—Ç–∞, –∫–æ—Ñ–µ, –ø—Ä–æ–¥—É–∫—Ç—ã, —Ç–∞–∫—Å–∏, —Ä—É–±–ª–∏, –¥–æ–ª–ª–∞—Ä—ã'
        });

        const transcribedText = transcription.text;
        logger.info('Voice transcription successful', {
          userId: appUserId,
          text: transcribedText
        });

        if (transcribedText) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –¥–æ—Ö–æ–¥–æ–º
          const lowerText = transcribedText.toLowerCase().trim();
          const isIncome = lowerText.startsWith('–¥–æ—Ö–æ–¥ ') || lowerText.startsWith('income ') || 
                           lowerText.startsWith('–¥–æ—Ö–æ–¥:') || lowerText.startsWith('income:');
          
          if (isIncome) {
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –¥–æ—Ö–æ–¥
            const cleanedText = transcribedText.replace(/^(–¥–æ—Ö–æ–¥|income)[:\s]+/i, '').trim();
            await processIncomeMessage(chatId, userId, cleanedText, true);
          } else {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞—Å—Ö–æ–¥
            await processExpenseMessage(chatId, userId, transcribedText, true);
          }
        } else {
          bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ç—á–µ.');
        }
      } finally {
        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        try {
          await fs.unlink(tempFilePath);
        } catch (error) {
          logger.error('Error deleting temp voice file', error instanceof Error ? error : new Error(String(error)));
        }
      }
    } catch (error) {
      logger.error('Error processing voice message', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º.');
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (—á–µ–∫–æ–≤)
  bot.on('photo', async (msg) => {
    const chatId = msg.chat.id;
    const userId = msg.from?.id;
    
    if (!userId) return;

    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      const appUserId = telegramUserMap.get(userId);
      
      if (!appUserId) {
        bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /auth <—Ç–æ–∫–µ–Ω>');
        return;
      }
      
      // –ü–æ–ª—É—á–∞–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ñ–æ—Ç–æ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ –º–∞—Å—Å–∏–≤–µ)
      const photo = msg.photo?.[msg.photo.length - 1];
      if (!photo) {
        bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ');
        return;
      }

      bot.sendMessage(chatId, 'üì∏ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —á–µ–∫, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...');

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –∏ —Å–∫–∞—á–∏–≤–∞–µ–º –µ–≥–æ
      const file = await bot.getFile(photo.file_id);
      const filePath = file.file_path;
      
      if (!filePath) {
        bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª');
        return;
      }

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      const fileUrl = `https://api.telegram.org/file/bot${token}/${filePath}`;
      const response = await fetch(fileUrl);
      const arrayBuffer = await response.arrayBuffer();
      const imageBuffer = Buffer.from(arrayBuffer);

      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á–µ–∫ —Å –ø–æ–º–æ—â—å—é OCR
      const result = await ocrService.analyzeReceipt(imageBuffer, `receipt_${Date.now()}.jpg`);

      if (!result.success || !result.receiptData) {
        bot.sendMessage(chatId, `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —á–µ–∫.\n${result.error || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ç—á–µ'}`);
        return;
      }

      const receipt = result.receiptData;
      
      // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ —á–µ–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º userId –Ω–∞–ø—Ä—è–º—É—é)
      const transaction = await ocrService.createTransactionFromReceipt(receipt, appUserId);

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
      const confirmationMessage = `‚úÖ –ß–µ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω!

üíµ –°—É–º–º–∞: ${receipt.currency || 'USD'} ${receipt.amount.toFixed(2)}
üè™ –ú–∞–≥–∞–∑–∏–Ω: ${receipt.merchant || '–ù–µ —É–∫–∞–∑–∞–Ω'}
üìù –û–ø–∏—Å–∞–Ω–∏–µ: ${receipt.description}
üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${receipt.category || '–†–∞–∑–Ω–æ–µ'}
üìÖ –î–∞—Ç–∞: ${receipt.date || '–°–µ–≥–æ–¥–Ω—è'}
üéØ –¢–æ—á–Ω–æ—Å—Ç—å: ${receipt.confidence}

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è #${transaction.id} –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≤–∞—à –±—é–¥–∂–µ—Ç!`;

      // –î–æ–±–∞–≤–∏–º inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      const inlineKeyboard = {
        inline_keyboard: [
          [
            { text: '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', callback_data: `edit_category_${transaction.id}` },
            { text: '‚ùå –£–¥–∞–ª–∏—Ç—å', callback_data: `delete_${transaction.id}` }
          ]
        ]
      };

      bot.sendMessage(chatId, confirmationMessage, {
        reply_markup: inlineKeyboard
      });

      logger.info('Receipt processed via Telegram', {
        userId: appUserId,
        transactionId: transaction.id,
        amount: receipt.amount,
        confidence: receipt.confidence
      });

    } catch (error) {
      logger.error('Error processing receipt photo', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ —á–µ–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∫–Ω–æ–ø–æ–∫
  bot.on('callback_query', async (query) => {
    const chatId = query.message?.chat.id;
    const userId = query.from.id;
    const data = query.data;

    if (!chatId || !data) return;

    try {
      // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏"
      await bot.answerCallbackQuery(query.id);

      if (data.startsWith('delete_')) {
        const transactionId = parseInt(data.replace('delete_', ''));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        const appUserId = telegramUserMap.get(userId);
        if (!appUserId) {
          bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã');
          return;
        }

        // –£–¥–∞–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        await storage.deleteDailyTransaction(transactionId);
        
        bot.editMessageText(`‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è #${transactionId} —É–¥–∞–ª–µ–Ω–∞`, {
          chat_id: chatId,
          message_id: query.message?.message_id
        });

        logger.info('Transaction deleted via Telegram', {
          userId: appUserId,
          transactionId
        });
      } 
      else if (data.startsWith('edit_category_')) {
        const transactionId = parseInt(data.replace('edit_category_', ''));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
        const categories = ['–ï–¥–∞', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–ó–¥–æ—Ä–æ–≤—å–µ', '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', '–ö—Ä–∞—Å–æ—Ç–∞', '–î–æ–º', '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '–†–∞–±–æ—Ç–∞', '–ü–æ–¥–∞—Ä–∫–∏', '–†–∞–∑–Ω–æ–µ'];
        
        const categoryKeyboard = {
          inline_keyboard: categories.map(cat => [{
            text: cat,
            callback_data: `set_category_${transactionId}_${cat}`
          }])
        };

        bot.sendMessage(chatId, 'üè∑Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:', {
          reply_markup: categoryKeyboard
        });
      }
      else if (data.startsWith('set_category_')) {
        const parts = data.replace('set_category_', '').split('_');
        const transactionId = parseInt(parts[0]);
        const category = parts.slice(1).join('_');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        const appUserId = telegramUserMap.get(userId);
        if (!appUserId) {
          bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã');
          return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        await storage.updateDailyTransaction(transactionId, { category });
        
        bot.sendMessage(chatId, `‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ #${transactionId} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ "${category}"`);

        logger.info('Transaction category updated via Telegram', {
          userId: appUserId,
          transactionId,
          newCategory: category
        });
      }
    } catch (error) {
      logger.error('Error handling callback query', error instanceof Error ? error : new Error(String(error)));
      bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–µ–π—Å—Ç–≤–∏—è');
    }
  });

  // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ polling
  bot.on('polling_error', async (error) => {
    console.error('Telegram bot polling error:', error);
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
    const errorMessage = error.message || error.toString();
    
    // –î–ª—è –æ—à–∏–±–∫–∏ 409 (conflict) –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ - –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    if (errorMessage.includes('409')) {
      console.log('üîÑ 409 –ö–æ–Ω—Ñ–ª–∏–∫—Ç - –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π.');
      
      // Clear any pending restart
      if (restartTimeoutId) {
        clearTimeout(restartTimeoutId);
        restartTimeoutId = null;
      }
      
      await stopPolling();
      restartAttempts = MAX_RESTART_ATTEMPTS; // Prevent further restarts
      return;
    }
    
    if (errorMessage.includes('ECONNRESET') || 
        errorMessage.includes('ENOTFOUND') || 
        errorMessage.includes('ETIMEDOUT') ||
        errorMessage.includes('ECONNREFUSED')) {
      console.log('üîÑ –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫...');
      isPollingStarted = false; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π
      scheduleRestart();
    } else if (errorMessage.includes('401')) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TELEGRAM_BOT_TOKEN');
      // –ù–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ç–æ–∫–µ–Ω–∞
    } else {
      console.log('üîÑ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ - –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞...');
      isPollingStarted = false;
      scheduleRestart();
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  bot.on('polling_start', () => {
    console.log('‚úÖ Telegram bot polling started successfully');
    isPollingStarted = true;
    restartAttempts = 0;
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ polling
  bot.on('polling_stop', () => {
    logger.info('Telegram bot polling stopped');
    isPollingStarted = false;
  });

  // –ó–∞–ø—É—Å–∫–∞–µ–º polling
  startPolling();
  
  logger.info('Telegram bot is running and listening for messages');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ä–∞—Å—Ö–æ–¥–µ
async function processExpenseMessage(chatId: number, telegramUserId: number, text: string, isVoice: boolean = false) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /auth <—Ç–æ–∫–µ–Ω> –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await storage.getUser(appUserId);
    if (!user) {
      bot.sendMessage(chatId, '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–æ–π /auth <—Ç–æ–∫–µ–Ω>');
      telegramUserMap.delete(telegramUserId);
      return;
    }

    // –ü–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const parsed = parseExpenseMessage(text);
    
    if (!parsed) {
      const helpMessage = isVoice ? 
        `‚ùå –ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —Å—É–º–º—É –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏: "${text}"\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å —á–µ—Ç—á–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ—Ç—Ä–∞—Ç–∏–ª –¥–≤–µ—Å—Ç–∏ —Ä—É–±–ª–µ–π –Ω–∞ –∫–æ—Ñ–µ" –∏–ª–∏ "Spent 20 dollars on coffee"` :
        `‚ùå –ù–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–∞–∫:\n‚Ä¢ "–ö–æ—Ñ–µ 200‚ÇΩ" –∏–ª–∏ "Coffee $5"\n‚Ä¢ "–ü—Ä–æ–¥—É–∫—Ç—ã 1500 —Ä—É–±–ª–µ–π"\n‚Ä¢ "–ü–æ—Ç—Ä–∞—Ç–∏–ª 20 –¥–æ–ª–ª–∞—Ä–æ–≤ –Ω–∞ –æ–±–µ–¥"`;
      
      bot.sendMessage(chatId, helpMessage);
      return;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—É–º–º—É –≤ –¥–æ–ª–ª–∞—Ä—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ
    const originalAmount = parsed.amount;
    const originalCurrency = parsed.currency;
    let usdAmount: number;
    let exchangeRate: number;

    if (originalCurrency === 'USD') {
      // –£–∂–µ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö
      usdAmount = originalAmount;
      exchangeRate = 1.0;
    } else {
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä—É–±–ª–∏ –≤ –¥–æ–ª–ª–∞—Ä—ã
      usdAmount = await convertRubToUsd(originalAmount);
      const rateInfo = await getExchangeRateInfo();
      exchangeRate = rateInfo.rate;
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–ª–∏ fallback –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    const transactionDate = parsed.date || new Date();
    
    // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –≤–∞–ª—é—Ç–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    const transactionData = {
      userId: appUserId,
      date: transactionDate.toISOString().split('T')[0], // YYYY-MM-DD
      type: 'expense' as const,
      amount: usdAmount, // –í—Å–µ–≥–¥–∞ –≤ USD –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
      description: parsed.description,
      category: detectCategory(parsed.description),
      originalCurrency,
      originalAmount: originalAmount,
      exchangeRate: exchangeRate
    };

    const validatedData = insertDailyTransactionSchema.parse(transactionData);
    const transaction = await storage.createDailyTransaction(validatedData);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—é–¥–∂–µ—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    await checkBudgetLimitsAndNotify(chatId, appUserId, validatedData.category || null, usdAmount);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    const updatedAchievements = await gamificationService.checkAndUnlockAchievements(appUserId);
    if (updatedAchievements.length > 0) {
      const achievement = updatedAchievements[0];
      bot.sendMessage(chatId, `üèÜ *–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!*\n\n*${achievement.title}*\n${achievement.description}`, { parse_mode: 'Markdown' });
    }

    // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userName = user.name;

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–±–µ–∏–º–∏ –≤–∞–ª—é—Ç–∞–º–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    let amountDisplay = '';
    let conversionInfo = '';
    
    if (originalCurrency === 'USD') {
      amountDisplay = `$${originalAmount.toLocaleString('en-US')}`;
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ —Ä—É–±–ª—è—Ö –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
      const rubEquivalent = await convertUsdToRub(originalAmount);
      conversionInfo = `\nüí± –ö—É—Ä—Å: $1 = ${exchangeRate.toFixed(2)}‚ÇΩ (‚âà${rubEquivalent.toLocaleString('ru-RU')}‚ÇΩ)`;
    } else {
      amountDisplay = `${originalAmount.toLocaleString('ru-RU')}‚ÇΩ`;
      conversionInfo = `\nüí± –ö—É—Ä—Å: $1 = ${exchangeRate.toFixed(2)}‚ÇΩ (‚âà$${usdAmount.toFixed(2)})`;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const prefix = isVoice ? 'üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!' : '‚úÖ –†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!';
    const confirmMessage = `${prefix}

üí∞ –°—É–º–º–∞: ${amountDisplay}
üìù –û–ø–∏—Å–∞–Ω–∏–µ: ${parsed.description}
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName}
üìÖ –î–∞—Ç–∞: ${transactionDate.toLocaleDateString('ru-RU')}${validatedData.category ? `\nüè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${validatedData.category}` : ''}${conversionInfo}`;

    // –î–æ–±–∞–≤–ª—è–µ–º inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
    const inlineKeyboard = {
      inline_keyboard: [
        [
          { text: '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', callback_data: `edit_category_${transaction.id}` },
          { text: '‚ùå –£–¥–∞–ª–∏—Ç—å', callback_data: `delete_${transaction.id}` }
        ]
      ]
    };

    bot.sendMessage(chatId, confirmMessage, {
      reply_markup: inlineKeyboard
    });

    logger.info(`Expense added via Telegram${isVoice ? ' (voice)' : ''}: ${originalAmount} ${originalCurrency} (${usdAmount.toFixed(2)} USD) for "${parsed.description}" on ${transactionDate.toISOString().split('T')[0]}`);

  } catch (error) {
    logger.error('Error processing expense message', error instanceof Error ? error : new Error(String(error)));
    
    // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
    
    if (error instanceof Error) {
      if (error.message.includes('validation')) {
        errorMessage = '‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—É–º–º—ã –∏ –æ–ø–∏—Å–∞–Ω–∏—è.';
      } else if (error.message.includes('database') || error.message.includes('connect')) {
        errorMessage = '‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.';
      } else if (error.message.includes('rate limit')) {
        errorMessage = '‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
      }
    }
    
    bot.sendMessage(chatId, errorMessage);
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –¥–æ—Ö–æ–¥–µ
async function processIncomeMessage(chatId: number, telegramUserId: number, text: string, isVoice: boolean = false) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const appUserId = telegramUserMap.get(telegramUserId);
    
    if (!appUserId) {
      bot.sendMessage(chatId, '‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /auth <—Ç–æ–∫–µ–Ω> –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await storage.getUser(appUserId);
    if (!user) {
      bot.sendMessage(chatId, '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–æ–π /auth <—Ç–æ–∫–µ–Ω>');
      telegramUserMap.delete(telegramUserId);
      return;
    }

    // –ü–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é –ø–∞—Ä—Å–∏–Ω–≥–∞)
    const parsed = parseExpenseMessage(text);
    
    if (!parsed) {
      const helpMessage = isVoice ? 
        `‚ùå –ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —Å—É–º–º—É –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏: "${text}"\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å —á–µ—Ç—á–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: "–î–æ—Ö–æ–¥ –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø—è—Ç—å–¥–µ—Å—è—Ç —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π" –∏–ª–∏ "Income salary two thousand dollars"` :
        `‚ùå –ù–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–∞–∫:\n‚Ä¢ "–¥–æ—Ö–æ–¥ –∑–∞—Ä–ø–ª–∞—Ç–∞ 50000‚ÇΩ"\n‚Ä¢ "income salary $2000"\n‚Ä¢ "–¥–æ—Ö–æ–¥ —Ñ—Ä–∏–ª–∞–Ω—Å —Ç—Ä–∏–¥—Ü–∞—Ç—å —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π"`;
      
      bot.sendMessage(chatId, helpMessage);
      return;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—É–º–º—É –≤ –¥–æ–ª–ª–∞—Ä—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ
    const originalAmount = parsed.amount;
    const originalCurrency = parsed.currency;
    let usdAmount: number;
    let exchangeRate: number;

    if (originalCurrency === 'USD') {
      // –£–∂–µ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö
      usdAmount = originalAmount;
      exchangeRate = 1.0;
    } else {
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä—É–±–ª–∏ –≤ –¥–æ–ª–ª–∞—Ä—ã
      usdAmount = await convertRubToUsd(originalAmount);
      const rateInfo = await getExchangeRateInfo();
      exchangeRate = rateInfo.rate;
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–ª–∏ fallback –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    const transactionDate = parsed.date || new Date();
    
    // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –≤–∞–ª—é—Ç–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (type: income)
    const transactionData = {
      userId: appUserId,
      date: transactionDate.toISOString().split('T')[0], // YYYY-MM-DD
      type: 'income' as const,
      amount: usdAmount, // –í—Å–µ–≥–¥–∞ –≤ USD –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
      description: parsed.description,
      category: null, // –î–æ—Ö–æ–¥—ã –æ–±—ã—á–Ω–æ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      originalCurrency,
      originalAmount: originalAmount,
      exchangeRate: exchangeRate
    };

    const validatedData = insertDailyTransactionSchema.parse(transactionData);
    const transaction = await storage.createDailyTransaction(validatedData);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—é–¥–∂–µ—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    await checkBudgetLimitsAndNotify(chatId, appUserId, validatedData.category || null, usdAmount);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    const updatedAchievements = await gamificationService.checkAndUnlockAchievements(appUserId);
    if (updatedAchievements.length > 0) {
      const achievement = updatedAchievements[0];
      bot.sendMessage(chatId, `üèÜ *–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!*\n\n*${achievement.title}*\n${achievement.description}`, { parse_mode: 'Markdown' });
    }

    // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userName = user.name;

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–±–µ–∏–º–∏ –≤–∞–ª—é—Ç–∞–º–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    let amountDisplay = '';
    let conversionInfo = '';
    
    if (originalCurrency === 'USD') {
      amountDisplay = `$${originalAmount.toLocaleString('en-US')}`;
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ —Ä—É–±–ª—è—Ö –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
      const rubEquivalent = await convertUsdToRub(originalAmount);
      conversionInfo = `\nüí± –ö—É—Ä—Å: $1 = ${exchangeRate.toFixed(2)}‚ÇΩ (‚âà${rubEquivalent.toLocaleString('ru-RU')}‚ÇΩ)`;
    } else {
      amountDisplay = `${originalAmount.toLocaleString('ru-RU')}‚ÇΩ`;
      conversionInfo = `\nüí± –ö—É—Ä—Å: $1 = ${exchangeRate.toFixed(2)}‚ÇΩ (‚âà$${usdAmount.toFixed(2)})`;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const prefix = isVoice ? 'üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–π –¥–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!' : '‚úÖ –î–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!';
    const confirmMessage = `${prefix}

üí∞ –°—É–º–º–∞: ${amountDisplay}
üìù –û–ø–∏—Å–∞–Ω–∏–µ: ${parsed.description}
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName}
üìÖ –î–∞—Ç–∞: ${transactionDate.toLocaleDateString('ru-RU')}${conversionInfo}`;

    // –î–æ–±–∞–≤–ª—è–µ–º inline –∫–Ω–æ–ø–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –¥–æ—Ö–æ–¥–æ–≤)
    const inlineKeyboard = {
      inline_keyboard: [
        [
          { text: '‚ùå –£–¥–∞–ª–∏—Ç—å', callback_data: `delete_${transaction.id}` }
        ]
      ]
    };

    bot.sendMessage(chatId, confirmMessage, {
      reply_markup: inlineKeyboard
    });

    logger.info(`Income added via Telegram${isVoice ? ' (voice)' : ''}: ${originalAmount} ${originalCurrency} (${usdAmount.toFixed(2)} USD) for "${parsed.description}" on ${transactionDate.toISOString().split('T')[0]}`);

  } catch (error) {
    logger.error('Error processing income message', error instanceof Error ? error : new Error(String(error)));
    
    // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–æ—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
    
    if (error instanceof Error) {
      if (error.message.includes('validation')) {
        errorMessage = '‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—É–º–º—ã –∏ –æ–ø–∏—Å–∞–Ω–∏—è.';
      } else if (error.message.includes('database') || error.message.includes('connect')) {
        errorMessage = '‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.';
      } else if (error.message.includes('rate limit')) {
        errorMessage = '‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
      }
    }
    
    bot.sendMessage(chatId, errorMessage);
  }
}

// detectCategory now imported from telegram-parser.ts module

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–≤—è–∑–µ–π Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
async function loadExistingTelegramUsers() {
  try {
    const users = await storage.getUsers();
    let loadedCount = 0;
    
    for (const user of users) {
      if (user.telegramId) {
        const telegramId = parseInt(user.telegramId);
        if (!isNaN(telegramId)) {
          telegramUserMap.set(telegramId, user.id);
          loadedCount++;
        }
      }
    }
    
    logger.info(`Loaded ${loadedCount} existing Telegram user connections`);
  } catch (error) {
    logger.error('Error loading existing Telegram users', error instanceof Error ? error : new Error(String(error)));
  }
}

// Graceful shutdown –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
function setupGracefulShutdown() {
  const cleanup = () => {
    logger.info('Graceful shutdown initiated...');
    stopPolling();
    process.exit(0);
  };

  process.on('SIGINT', cleanup);
  process.on('SIGTERM', cleanup);
  process.on('SIGQUIT', cleanup);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º graceful shutdown
setupGracefulShutdown();