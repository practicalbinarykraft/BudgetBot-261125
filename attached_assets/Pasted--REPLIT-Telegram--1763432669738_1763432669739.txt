–û–¢–ü–†–ê–í–¨ REPLIT:

---

–î–æ–±–∞–≤—å –ø–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–æ–≤ –ø–æ–∫—É–ø–æ–∫ –≤ Telegram –±–æ—Ç–∞.

–ó–ê–î–ê–ß–ê:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å:
"Pepito: –∞—Ä–±—É–∑ 22–∫, –º—ã–ª–æ 189–∫, —Å–æ–∫ 32–∫"

–ë–æ—Ç –¥–æ–ª–∂–µ–Ω:
1. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
2. –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (—Å—É–º–º–∞ = 22–∫ + 189–∫ + 32–∫)
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –≤ receipt_items

–§–û–†–ú–ê–¢–´ –ü–û–î–î–ï–†–ñ–ê–¢–¨:

1. –ö–æ—Ä–æ—Ç–∫–∏–π:
   "Pepito: –∞—Ä–±—É–∑ 22–∫, –º—ã–ª–æ 189–∫, —Å–æ–∫ 32–∫"

2. –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π:
   "–ü–æ–∫—É–ø–∫–∏ Pepito:
   - –∞—Ä–±—É–∑ 22000
   - –º—ã–ª–æ 189000
   - —Å–æ–∫ 32500"

3. –° –∑–∞–ø—è—Ç—ã–º–∏:
   "Moris: —Ö–ª–µ–± 5000, –º–æ–ª–æ–∫–æ 12000, —è–π—Ü–∞ 18000"

–ü–ê–†–°–ï–†:

// server/telegram/parser.ts

export function parseShoppingList(text: string): ParsedShoppingList | null {
  // 1. –ò–∑–≤–ª–µ—á—å –º–∞–≥–∞–∑–∏–Ω
  const merchantMatch = text.match(/^([^:]+):/i);
  if (!merchantMatch) return null;
  
  const merchant = merchantMatch[1].trim();
  
  // 2. –ò–∑–≤–ª–µ—á—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
  const itemsText = text.substring(merchantMatch[0].length).trim();
  
  // –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –∑–∞–ø—è—Ç—ã–º –∏–ª–∏ –Ω–æ–≤—ã–º —Å—Ç—Ä–æ–∫–∞–º
  const itemLines = itemsText
    .split(/[,\n]/)
    .map(line => line.trim())
    .filter(line => line.length > 0);
  
  const items: ShoppingItem[] = [];
  let total = 0;
  
  for (const line of itemLines) {
    // –£–±—Ä–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã "- " –∏–ª–∏ "‚Ä¢ "
    const cleaned = line.replace(/^[-‚Ä¢]\s*/, '');
    
    // –§–æ—Ä–º–∞—Ç: "—Ç–æ–≤–∞—Ä —Ü–µ–Ω–∞" –∏–ª–∏ "—Ç–æ–≤–∞—Ä: —Ü–µ–Ω–∞"
    const match = cleaned.match(/^(.+?)\s*:?\s*(\d+[–∫k]?|\d+,\d+)$/i);
    
    if (match) {
      const name = match[1].trim();
      let price = match[2].toLowerCase().replace(',', '.');
      
      // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å "22–∫" ‚Üí 22000
      if (price.endsWith('–∫') || price.endsWith('k')) {
        price = parseFloat(price) * 1000;
      } else {
        price = parseFloat(price);
      }
      
      items.push({
        name,
        price,
        normalizedName: normalizeItemName(name)
      });
      
      total += price;
    }
  }
  
  if (items.length === 0) return null;
  
  return {
    merchant,
    items,
    total
  };
}

interface ShoppingItem {
  name: string;
  price: number;
  normalizedName: string;
}

interface ParsedShoppingList {
  merchant: string;
  items: ShoppingItem[];
  total: number;
}

–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í –ö–û–ú–ê–ù–î–´:

–í server/telegram/commands.ts –¥–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä–µ–¥ –æ–±—ã—á–Ω—ã–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º:

// –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
const shoppingList = parseShoppingList(trimmedMessage);

if (shoppingList) {
  // –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  const transaction = await db.insert(dailyTransactions).values({
    userId: ctx.from.id,
    description: shoppingList.merchant,
    amountUsd: shoppingList.total / exchangeRate,
    type: 'expense',
    source: 'telegram',
    date: new Date().toISOString().split('T')[0]
  }).returning();
  
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä—ã
  const receiptItems = shoppingList.items.map(item => ({
    transactionId: transaction[0].id,
    itemName: item.name,
    normalizedName: item.normalizedName,
    quantity: '1',
    pricePerUnit: item.price.toString(),
    totalPrice: item.price.toString(),
    merchantName: shoppingList.merchant
  }));
  
  await receiptItemsRepository.createBulk(receiptItems);
  
  // –û—Ç–≤–µ—Ç–∏—Ç—å —Å —Ç–æ–≤–∞—Ä–∞–º–∏
  const itemsList = shoppingList.items
    .map(item => `‚Ä¢ ${item.name} - ‚Çπ${item.price.toLocaleString()}`)
    .join('\n');
  
  ctx.reply(`üí∏ –ü–æ–∫—É–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã!

üè™ –ú–∞–≥–∞–∑–∏–Ω: ${shoppingList.merchant}
–°—É–º–º–∞: ‚Çπ${shoppingList.total.toLocaleString()}

üõí –¢–æ–≤–∞—Ä—ã:
${itemsList}

–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: 1 USD = ${exchangeRate} IDR
–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ USD: ~$${(shoppingList.total / exchangeRate).toFixed(2)}

–û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª: $${calculateCapital(ctx.from.id)}`);
  
  return;
}

// –ï—Å–ª–∏ –Ω–µ —Å–ø–∏—Å–æ–∫ - –æ–±—ã—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
const parsed = parseTransaction(trimmedMessage);
...

–†–ï–ó–£–õ–¨–¢–ê–¢:
‚úÖ –¢–µ–∫—Å—Ç–æ–º: "Pepito: –∞—Ä–±—É–∑ 22–∫, –º—ã–ª–æ 189–∫"
‚úÖ –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ: "–ü–æ–∫—É–ø–∫–∏:\n- —Ç–æ–≤–∞—Ä 1000\n- —Ç–æ–≤–∞—Ä 2000"
‚úÖ –ì–æ–ª–æ—Å–æ–º: "–ö—É–ø–∏–ª –≤ Pepito –∞—Ä–±—É–∑ –∑–∞ 22 —Ç—ã—Å—è—á–∏, –º—ã–ª–æ –∑–∞ 189 —Ç—ã—Å—è—á"
‚úÖ –§–æ—Ç–æ —á–µ–∫–∞: –∫–∞–∫ —Ä–∞–Ω—å—à–µ

–í—Å–µ —Å–ø–æ—Å–æ–±—ã ‚Üí —Ç–æ–≤–∞—Ä—ã –≤ receipt_items ‚Üí Price Comparison! üî•

---