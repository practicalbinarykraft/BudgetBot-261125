ğŸ“Š Ğ­Ğ¢ĞĞŸ 3: ĞĞ‘ĞĞĞ’Ğ˜Ğ¢Ğ¬ PRODUCT CATALOG SERVICE (20 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ—ĞĞ”ĞĞ§Ğ 3.1: Ğ¡ĞĞ¥Ğ ĞĞĞ¯Ğ¢Ğ¬ Ğ˜Ğ¡Ğ¥ĞĞ”ĞĞ£Ğ® Ğ’ĞĞ›Ğ®Ğ¢Ğ£
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ¤ĞĞ™Ğ›: server/services/product-catalog.service.ts

ĞĞĞ™Ğ¢Ğ˜ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ®: processReceiptItems

Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ™ ĞšĞĞ”:
// 4. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
await productPriceHistoryRepository.create({
  productId,
  storeName,
  price: item.price.toString(),
  currency: 'USD',
  purchaseDate
});

Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ¬ ĞĞ:

// 4. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ (Ñ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ²Ğ°Ğ»ÑÑ‚Ğ¾Ğ¹)
await productPriceHistoryRepository.create({
  productId,
  storeName,
  
  // USD Ñ†ĞµĞ½Ğ° (ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ)
  price: item.priceUsd?.toString() || item.price.toString(),
  currency: 'USD',
  
  // Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ°Ñ Ñ†ĞµĞ½Ğ° Ğ¸Ğ· Ñ‡ĞµĞºĞ°
  priceOriginal: item.priceOriginal?.toString() || item.price.toString(),
  currencyOriginal: item.currencyOriginal || params.currency || 'USD',
  exchangeRate: item.exchangeRate?.toString(),
  
  purchaseDate
});

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ—ĞĞ”ĞĞ§Ğ 3.2: ĞĞ‘ĞĞĞ’Ğ˜Ğ¢Ğ¬ Ğ¡Ğ˜Ğ“ĞĞĞ¢Ğ£Ğ Ğ£ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞĞĞ™Ğ¢Ğ˜:
interface ReceiptItem {
  name: string;
  price: number;
  quantity?: number;
}

Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ¬ ĞĞ:

interface ReceiptItem {
  name: string;
  
  // USD Ñ†ĞµĞ½Ğ°
  price: number;
  priceUsd?: number;
  
  // Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ°Ñ Ñ†ĞµĞ½Ğ°
  priceOriginal?: number;
  currencyOriginal?: string;
  exchangeRate?: number;
  
  quantity?: number;
}

Ğ˜ ĞĞ‘ĞĞĞ’Ğ˜Ğ¢Ğ¬ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ Ğ«:

export async function processReceiptItems(params: {
  receiptItems: ReceiptItem[];
  userId: number;
  storeName: string;
  purchaseDate: string;
  currency?: string; // â† ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ 
  anthropicApiKey?: string;
}): Promise<void>

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ—ĞĞ”ĞĞ§Ğ 3.3: ĞĞ‘ĞĞĞ’Ğ˜Ğ¢Ğ¬ updateBestPrice
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞĞĞ™Ğ¢Ğ˜:
export async function updateBestPrice(productId: number): Promise<void> {
  const prices = await productPriceHistoryRepository.findByProduct(productId);
  
  if (prices.length === 0) return;
  
  const best = prices.reduce((min, p) => 
    parseFloat(p.price) < parseFloat(min.price) ? p : min
  );
  
  const sum = prices.reduce((acc, p) => acc + parseFloat(p.price), 0);
  const avg = sum / prices.length;
  
  await productCatalogRepository.update(productId, {
    bestPrice: best.price,
    bestStore: best.storeName,
    averagePrice: avg.toFixed(2)
  });
}

Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ¬ ĞĞ:

export async function updateBestPrice(productId: number): Promise<void> {
  const prices = await productPriceHistoryRepository.findByProduct(productId);
  
  if (prices.length === 0) return;
  
  // ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ»ÑƒÑ‡ÑˆÑƒÑ Ñ†ĞµĞ½Ñƒ Ğ¿Ğ¾ USD
  const best = prices.reduce((min, p) => 
    parseFloat(p.price) < parseFloat(min.price) ? p : min
  );
  
  // Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ÑÑ€ĞµĞ´Ğ½ÑÑ USD Ñ†ĞµĞ½Ñƒ
  const sum = prices.reduce((acc, p) => acc + parseFloat(p.price), 0);
  const avg = sum / prices.length;
  
  await productCatalogRepository.update(productId, {
    // USD Ñ†ĞµĞ½Ñ‹
    bestPrice: best.price,
    bestStore: best.storeName,
    averagePrice: avg.toFixed(2),
    
    // Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ°Ñ Ñ†ĞµĞ½Ğ° Ğ»ÑƒÑ‡ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    bestPriceOriginal: best.priceOriginal,
    bestPriceCurrency: best.currencyOriginal
  });
}

ĞĞ–Ğ˜Ğ”ĞĞ•ĞœĞ«Ğ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢:
âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ¾Ğ±Ğµ Ğ²Ğ°Ğ»ÑÑ‚Ñ‹
âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ product_catalog Ñ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ²Ğ°Ğ»ÑÑ‚Ğ¾Ğ¹