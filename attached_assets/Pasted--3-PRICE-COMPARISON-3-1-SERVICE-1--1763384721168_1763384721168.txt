üí∞ –°–ü–†–ò–ù–¢ 3: PRICE COMPARISON
–ó–ê–î–ê–ß–ê 3.1: SERVICE (1 —á–∞—Å)
–¶–ï–õ–¨: –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω

–ß–¢–û –î–ï–õ–ê–¢–¨:
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: server/services/ai/price-comparison.service.ts

–ö–û–î:
import { db } from '../../db';
import { receiptItems, dailyTransactions } from '@shared/schema';
import { eq, and, gte } from 'drizzle-orm';

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω –º–µ–∂–¥—É –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
 * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
 */

interface PriceRecommendation {
  itemName: string;
  normalizedName: string;
  cheapestMerchant: string;
  cheapestPrice: number;
  expensiveMerchant: string;
  expensivePrice: number;
  savingsAmount: number;
  savingsPercent: number;
  purchaseCount: number;
  recommendation: string;
}

/**
 * –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Å–∏–≤ –ø–æ –∫–ª—é—á—É
 */
function groupBy<T>(array: T[], keyFn: (item: T) => string): Record<string, T[]> {
  return array.reduce((result, item) => {
    const key = keyFn(item);
    if (!result[key]) result[key] = [];
    result[key].push(item);
    return result;
  }, {} as Record<string, T[]>);
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–∞–º
 */
export async function generatePriceRecommendations(
  userId: number,
  minSavingsPercent: number = 20
): Promise<PriceRecommendation[]> {
  
  // 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞
  const threeMonthsAgo = new Date();
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
  
  const items = await db
    .select({
      itemName: receiptItems.itemName,
      normalizedName: receiptItems.normalizedName,
      pricePerUnit: receiptItems.pricePerUnit,
      merchantName: receiptItems.merchantName
    })
    .from(receiptItems)
    .innerJoin(
      dailyTransactions,
      eq(receiptItems.transactionId, dailyTransactions.id)
    )
    .where(
      and(
        eq(dailyTransactions.userId, userId),
        gte(dailyTransactions.date, threeMonthsAgo.toISOString().split('T')[0])
      )
    );
  
  if (items.length === 0) {
    return [];
  }
  
  // 2. –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ normalizedName
  const grouped = groupBy(items, item => item.normalizedName || '');
  
  // 3. –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã —Å —Ä–∞–∑–Ω–∏—Ü–µ–π —Ü–µ–Ω
  const recommendations: PriceRecommendation[] = [];
  
  for (const [normalizedName, purchases] of Object.entries(grouped)) {
    if (!normalizedName || purchases.length < 2) continue;
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ü–µ–Ω–µ
    const sorted = purchases.sort((a, b) => 
      parseFloat(a.pricePerUnit) - parseFloat(b.pricePerUnit)
    );
    
    const cheapest = sorted[0];
    const mostExpensive = sorted[sorted.length - 1];
    
    const cheapPrice = parseFloat(cheapest.pricePerUnit);
    const expPrice = parseFloat(mostExpensive.pricePerUnit);
    
    const savingsAmount = expPrice - cheapPrice;
    const savingsPercent = (savingsAmount / expPrice) * 100;
    
    if (savingsPercent >= minSavingsPercent) {
      recommendations.push({
        itemName: cheapest.itemName,
        normalizedName,
        cheapestMerchant: cheapest.merchantName || 'Unknown',
        cheapestPrice: cheapPrice,
        expensiveMerchant: mostExpensive.merchantName || 'Unknown',
        expensivePrice: expPrice,
        savingsAmount,
        savingsPercent,
        purchaseCount: purchases.length,
        recommendation: `Buy "${cheapest.itemName}" at ${cheapest.merchantName} (${cheapPrice.toFixed(0)}) instead of ${mostExpensive.merchantName} (${expPrice.toFixed(0)}). Save ${savingsAmount.toFixed(0)} (${savingsPercent.toFixed(0)}%)!`
      });
    }
  }
  
  // 4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏
  return recommendations.sort((a, b) => b.savingsAmount - a.savingsAmount);
}

–†–ê–ó–ú–ï–†: ~150 —Å—Ç—Ä–æ–∫ ‚úÖ

–§–ê–ô–õ–´:
‚îî‚îÄ server/services/ai/price-comparison.service.ts (–Ω–æ–≤—ã–π)

–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚úÖ –ù–µ —Ç—Ä–æ–≥–∞–µ—Ç –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã
‚úÖ –ü—Ä–æ—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –Ω–µ—Ç AI API