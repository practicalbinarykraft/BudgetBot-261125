# üîê Security Fix: API Keys Encryption

## –ü—Ä–æ–±–ª–µ–º–∞
–î–æ —ç—Ç–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ –ë–î **–ë–ï–ó –®–ò–§–†–û–í–ê–ù–ò–Ø** –≤ –ø–æ–ª—è—Ö `anthropic_api_key` –∏ `openai_api_key`.

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
1. ‚úÖ `GET /api/settings` - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ encrypted –ø–æ–ª–µ–π
2. ‚úÖ `PATCH /api/settings` - —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —à–∏—Ñ—Ä—É–µ—Ç API –∫–ª—é—á–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AES-256-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
4. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ legacy-–∫–ª—é—á–µ–π –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

## –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `server/routes/settings.routes.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- `server/repositories/settings.repository.ts` - —É–∂–µ –±—ã–ª–∏ –º–µ—Ç–æ–¥—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ –∏–∑–º–µ–Ω—ë–Ω)

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π (PATCH /api/settings):
```typescript
// 1. –ò–∑–≤–ª–µ–∫–∞–µ–º API –∫–ª—é—á–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
const { anthropicApiKey, openaiApiKey, ...otherSettings } = req.body;

// 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ã—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
await storage.updateSettings(userId, otherSettings);

// 3. –®–∏—Ñ—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º API –∫–ª—é—á–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
if (anthropicApiKey) {
  await settingsRepository.saveAnthropicApiKey(userId, anthropicApiKey);
  // -> –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ anthropic_api_key_encrypted (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ)
  // -> –û—á–∏—â–∞–µ—Ç—Å—è anthropic_api_key (legacy)
}

if (openaiApiKey) {
  await settingsRepository.saveOpenAiApiKey(userId, openaiApiKey);
  // -> –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ openai_api_key_encrypted (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ)
  // -> –û—á–∏—â–∞–µ—Ç—Å—è openai_api_key (legacy)
}
```

### –ß—Ç–µ–Ω–∏–µ –∫–ª—é—á–µ–π (GET /api/settings):
```typescript
// 1. –ü–æ–ª—É—á–∞–µ–º settings –∏–∑ –ë–î
const settings = await storage.getSettingsByUserId(userId);

// 2. –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –∫–ª—é—á–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É
const response = {
  ...settings,
  anthropicApiKey: settings.anthropicApiKeyEncrypted
    ? await settingsRepository.getAnthropicApiKey(userId)  // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
    : settings.anthropicApiKey,  // Fallback –¥–ª—è legacy
  openaiApiKey: settings.openaiApiKeyEncrypted
    ? await settingsRepository.getOpenAiApiKey(userId)  // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
    : settings.openaiApiKey,  // Fallback –¥–ª—è legacy
};
```

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π:

```bash
# –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ
cd /root/BudgetBot-Improved
DATABASE_URL="postgresql://..." ENCRYPTION_KEY="..." npx tsx server/migrations/migrate-encrypt-keys.ts
```

–°–∫—Ä–∏–ø—Ç:
- ‚úÖ –ù–∞–π–¥—ë—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
- ‚úÖ –ó–∞—à–∏—Ñ—Ä—É–µ—Ç –∏—Ö —Å –ø–æ–º–æ—â—å—é AES-256-GCM
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç –≤ `*_encrypted` –ø–æ–ª—è
- ‚úÖ –ù–ï —É–¥–∞–ª—è–µ—Ç legacy –ø–æ–ª—è (–¥–ª—è backward compatibility)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
SELECT COUNT(*) FROM settings
WHERE (anthropic_api_key IS NOT NULL OR openai_api_key IS NOT NULL)
  AND (anthropic_api_key_encrypted IS NULL AND openai_api_key_encrypted IS NULL);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
SELECT COUNT(*) FROM settings
WHERE anthropic_api_key_encrypted IS NOT NULL
   OR openai_api_key_encrypted IS NOT NULL;
```

## –£–¥–∞–ª–µ–Ω–∏–µ legacy –ø–æ–ª–µ–π (–ü–û–°–õ–ï –º–∏–≥—Ä–∞—Ü–∏–∏)

**–í–ê–ñ–ù–û**: –£–¥–∞–ª—è—Ç—å legacy –ø–æ–ª—è –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫:
1. ‚úÖ –í—Å–µ –∫–ª—é—á–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã (—Å–º. –ø—Ä–æ–≤–µ—Ä–∫—É –≤—ã—à–µ)
2. ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production –º–∏–Ω–∏–º—É–º 1-2 –Ω–µ–¥–µ–ª–∏
3. ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å API –∫–ª—é—á–∞–º–∏

```sql
-- –û–°–¢–û–†–û–ñ–ù–û! –ù–µ–æ–±—Ä–∞—Ç–∏–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è!
ALTER TABLE settings DROP COLUMN anthropic_api_key;
ALTER TABLE settings DROP COLUMN openai_api_key;
```

## –§–æ—Ä–º–∞—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```
iv:authTag:encrypted
```

–ü—Ä–∏–º–µ—Ä:
```
a1b2c3d4e5f6a7b8c9d0e1f2:1a2b3c4d5e6f7a8b9c0d1e2f:3c4d5e6f7a8b9c0d1e2f3a4b...
```

- `iv` - Initialization Vector (16 –±–∞–π—Ç, hex)
- `authTag` - Authentication Tag (16 –±–∞–π—Ç, hex)
- `encrypted` - –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (hex)

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:
- ‚úÖ API –∫–ª—é—á–∏ —à–∏—Ñ—Ä—É—é—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-256-GCM
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π IV –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞
- ‚úÖ Authentication Tag –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–¥–µ–ª–∫—É –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ö–ª—é—á–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ plain text —á–µ—Ä–µ–∑ API

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- ‚ö†Ô∏è `ENCRYPTION_KEY` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 32 –±–∞–π—Ç–∞ (256 –±–∏—Ç)
- ‚ö†Ô∏è `ENCRYPTION_KEY` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–¥—ë–∂–Ω–æ –∑–∞—â–∏—â—ë–Ω
- ‚ö†Ô∏è –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—å `ENCRYPTION_KEY` –≤ git
- ‚ö†Ô∏è –•—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ secrets manager

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞:
```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
openssl rand -base64 32

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# J9QPe1LBR1dy/HYgdS1b1dQsqmsY5wybqV7yinx/wVQ=
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞:
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å API –∫–ª—é—á–æ–º
curl -X PATCH http://localhost:5000/api/settings \
  -H "Cookie: connect.sid=..." \
  -H "Content-Type: application/json" \
  -d '{
    "anthropicApiKey": "sk-ant-api03-test-key",
    "currency": "USD"
  }'
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:
```sql
SELECT
  anthropic_api_key,           -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å NULL
  anthropic_api_key_encrypted  -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å "iv:authTag:encrypted"
FROM settings WHERE user_id = 1;
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–µ–Ω–∏—è –∫–ª—é—á–∞:
```bash
curl http://localhost:5000/api/settings \
  -H "Cookie: connect.sid=..."
```

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
```json
{
  "anthropicApiKey": "sk-ant-api03-test-key",  // ‚Üê –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π
  "anthropicApiKeyEncrypted": null  // ‚Üê –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É
}
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–ª—é—á–∞:
```bash
curl -X PATCH http://localhost:5000/api/settings \
  -H "Cookie: connect.sid=..." \
  -H "Content-Type: application/json" \
  -d '{"anthropicApiKey": ""}'
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:
```sql
SELECT
  anthropic_api_key,
  anthropic_api_key_encrypted
FROM settings WHERE user_id = 1;
-- –û–±–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å NULL
```

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ö–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è:
1. **Legacy –∫–ª—é—á–∏** (unencrypted) - –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏
2. **–ù–æ–≤—ã–µ –∫–ª—é—á–∏** (encrypted) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —á—Ç–µ–Ω–∏—è:
```
encrypted field ‚Üí legacy field ‚Üí null
```

## Checklist –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] `ENCRYPTION_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ production
- [ ] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ production
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ UI
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á—Ç–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–æ–∫ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- [ ] Telegram –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
- [ ] OCR —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
- [ ] AI chat —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –ß—Ç–æ –ù–ï –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ Telegram –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ `settingsRepository`
- ‚úÖ OCR –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ AI chat –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### –ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å:
- ‚úÖ API –∫–ª—é—á–∏ –±–æ–ª—å—à–µ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ plain text
- ‚úÖ –î–∞–∂–µ –ø—Ä–∏ —É—Ç–µ—á–∫–µ –ë–î –∫–ª—é—á–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∑–∞—â–∏—â—ë–Ω–Ω—ã–º–∏
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ best practices –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
