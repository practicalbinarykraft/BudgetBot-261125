# External Integrations

**Analysis Date:** 2026-02-19

## APIs & External Services

**AI/LLM Providers:**
- Claude (Anthropic) - Primary OCR for receipt parsing, AI chat assistant, financial analysis
  - SDK: `@anthropic-ai/sdk` 0.37.0
  - Auth: `SYSTEM_ANTHROPIC_API_KEY` (optional, system credits) or user BYOK
  - Usage: `server/services/ocr/anthropic-ocr-provider.ts`, `server/services/ai/chat.service.ts`
  - Implementation: `server/services/api-key-manager.ts` routes to this provider first

- OpenAI - GPT-4o for OCR fallback, Whisper for voice transcription
  - SDK: `openai` 6.9.1
  - Auth: `SYSTEM_OPENAI_API_KEY` (optional, system credits) or user BYOK
  - Usage: `server/services/ocr/openai-receipt-parser.service.ts`, `server/services/whisper-transcription.service.ts`
  - Fallback: Used when Anthropic fails due to rate limiting or billing errors

- DeepSeek - Cheaper alternative for transaction categorization and normalization
  - SDK: Not explicitly imported (HTTP calls via axios)
  - Auth: `SYSTEM_DEEPSEEK_API_KEY` (optional)
  - Usage: `server/services/deepseek.service.ts`
  - Implementation: Cheaper LLM for non-critical tasks

- OpenRouter - Unified API routing with fallback support
  - SDK: Not explicitly imported (HTTP calls)
  - Auth: `SYSTEM_OPENROUTER_API_KEY` (optional)
  - Usage: `server/services/ai/openrouter.service.ts`
  - Implementation: Fallback routing for various LLM models

**Messaging/Notifications:**
- Telegram Bot API - Inline bot for quick expense logging
  - SDK: `node-telegram-bot-api` 0.66.0
  - Auth: `TELEGRAM_BOT_TOKEN` (from @BotFather)
  - Implementation: `server/telegram/bot.ts`, `server/telegram/` directory
  - Modes: Polling (development) or Webhook (production)
  - Webhook URL: `TELEGRAM_WEBHOOK_URL` (production only)
  - Features: Text commands, photo OCR, voice transcription, inline buttons/menus, AI chat

## Data Storage

**Databases:**
- PostgreSQL 16 - Primary relational database
  - Connection: `DATABASE_URL` (format: `postgresql://user:password@host:port/database`)
  - Client: `pg` 8.11.3 (node-postgres)
  - ORM: Drizzle ORM 0.39.1
  - Schema: `shared/schema.ts` (Drizzle table definitions)
  - Migrations: `migrations/` directory (auto-generated by drizzle-kit)
  - Session Store: PostgreSQL via `connect-pg-simple` 10.0.0
  - Key tables: users, transactions, wallets, categories, budgets, settings, user_credits, audit_logs, notifications

**File Storage:**
- Local filesystem only - No cloud storage integration
- Files served via Express static middleware: `server/static.ts`
- Public assets: `dist/public/` (Vite build output)

**Caching:**
- Redis (optional) - In-memory cache for performance
  - Connection: `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`, `REDIS_DB` (env vars)
  - Alternative: `REDIS_URL` connection string
  - Client: `ioredis` 5.8.2
  - Implementation: `server/lib/redis.ts` with CacheService wrapper
  - Cached data: Categories, wallets, exchange rates
  - Fallback: node-cache 5.1.2 (in-memory) if Redis unavailable

## Authentication & Identity

**Auth Provider:**
- Custom - No external OAuth provider
  - Username/password via Passport.js Local Strategy
  - Sessions: Express Session with PostgreSQL store (fallback to memory)
  - Password hashing: bcryptjs 3.0.3 (or bcrypt 6.0.0 for performance)
  - JWT tokens: jsonwebtoken 9.0.3 for mobile/API authentication
  - 2FA: TOTP support (otplib 12.0.1) with encrypted secrets

**Telegram Mini App Auth:**
- WebApp API validation for Telegram inline bot
- Token verification against Telegram Bot token
- Route: `server/routes/auth-telegram.routes.ts`, `server/routes/auth-miniapp.routes.ts`

**Session Storage:**
- PostgreSQL (primary) via `connect-pg-simple` 10.0.0
- Memory (fallback) via `memorystore` 1.6.7
- Session secret: `SESSION_SECRET` env var (minimum 32 characters)

**API Key Encryption:**
- User API keys encrypted with `ENCRYPTION_KEY` env var (base64-encoded 32-byte key)
- Encryption: Custom encryption service in `server/services/api-key-manager.ts`
- Storage: User API keys stored in settings table (encrypted)

## Monitoring & Observability

**Error Tracking:**
- Sentry 10.26.0 (server-side via @sentry/node, client-side via @sentry/react)
  - Optional - only if `SENTRY_DSN` is set
  - Server config: `server/lib/sentry.ts` with error filtering and sensitive data redaction
  - Client config: Via environment variable `VITE_SENTRY_DSN`
  - Features: Error tracking, performance monitoring (10% in prod, 100% in dev), breadcrumbs
  - Filters: Ignores common network errors, redacts sensitive headers/cookies

**Logs:**
- Winston 3.18.3 - Structured logging
  - JSON format for prod, human-readable for dev
  - Files: `logs/` directory with daily rotation
  - Levels: error, warn, info, debug, trace (configurable via `LOG_LEVEL` env var)
  - Logger: `server/lib/logger.ts` exports `logInfo`, `logWarning`, `logError` functions
  - Request logging: `logRequest` middleware logs API requests with timing

**Metrics:**
- Custom metrics collection scripts in `scripts/metrics/`
  - Line counting, test counting, code quality metrics
  - No external monitoring service (data collection only)

## CI/CD & Deployment

**Hosting:**
- VPS (Linux) at IP 5.129.230.171
  - Process manager: pm2
  - Web server: nginx (reverse proxy)
  - Database: PostgreSQL 16 (local)
  - Cache: Redis (local)

**CI Pipeline:**
- GitHub Actions (workflows in `.github/workflows/`)
  - Type check: `npm run check` (tsc)
  - Tests: `npm run test:run` and `npm run test:mobile`
  - Build: `npm run build`
  - Deploy: Auto-deploy to production on merge to main
  - Deployment script: `/root/deploy.sh` on server (restricted SSH access)

**Deployment:**
- Automatic on git push to main
- Docker container orchestration via pm2
- Static file serving: Express for web, nginx for mobile web
- Database migrations: Run via `npm run db:push` before deployment

## Environment Configuration

**Required env vars:**
- `DATABASE_URL` - PostgreSQL connection (MUST START with `postgresql://`)
- `SESSION_SECRET` - Session cookie signing key (min 32 chars, use `openssl rand -base64 32`)
- `ENCRYPTION_KEY` - API key encryption (exactly 44 chars, base64 encoded 32 bytes)
- `NODE_ENV` - One of: development, production, test

**Optional env vars (AI/Billing):**
- `SYSTEM_ANTHROPIC_API_KEY` - Claude API key (if not set, users must use BYOK)
- `SYSTEM_OPENAI_API_KEY` - OpenAI API key (fallback)
- `SYSTEM_DEEPSEEK_API_KEY` - DeepSeek API key
- `SYSTEM_OPENROUTER_API_KEY` - OpenRouter API key
- `BILLING_ENABLED` - Enable credit system (default: false)
- `FREE_TIER_CREDITS` - Starting credits for new users (default: 25)

**Optional env vars (Telegram):**
- `TELEGRAM_BOT_TOKEN` - Bot token from @BotFather
- `TELEGRAM_USE_WEBHOOK` - Use webhook mode (true/false, default: false for polling)
- `TELEGRAM_WEBHOOK_URL` - Public URL for webhook (production only)

**Optional env vars (Caching):**
- `REDIS_HOST` - Redis host (default: localhost)
- `REDIS_PORT` - Redis port (default: 6379)
- `REDIS_PASSWORD` - Redis auth password (if any)
- `REDIS_DB` - Redis database number (default: 0)
- Or: `REDIS_URL` - Full Redis connection string

**Optional env vars (Monitoring):**
- `SENTRY_DSN` - Sentry error tracking DSN
- `LOG_LEVEL` - Logging level: error, warn, info, debug, trace (default: info)

**Client-side env vars (prefixed with VITE_):**
- `VITE_API_URL` - API base URL (optional, defaults to same origin)
- `VITE_SENTRY_DSN` - Client-side Sentry DSN
- `VITE_ENABLE_ANALYTICS` - Enable analytics (default: false)

**Secrets location:**
- Production: `/root/BudgetBot-Improved/.env` on VPS
- Development: `.env` file (ignored by git via `.gitignore`)
- CI/CD: GitHub Secrets for deploy key and sensitive variables

## Webhooks & Callbacks

**Incoming:**
- Telegram Webhook - Receives messages/callbacks from Telegram
  - Endpoint: `POST /api/telegram/webhook`
  - Route: `server/routes/telegram-webhook.routes.ts`
  - Activation: Set via `TELEGRAM_WEBHOOK_URL` and `TELEGRAM_USE_WEBHOOK=true`
  - Payload: Telegram Update object with message/callback data

**Outgoing:**
- None currently implemented
- Could extend to: Stripe webhooks (future billing), external notifications, etc.

## Rate Limiting

**API Rate Limiting:**
- express-rate-limit 8.2.1
- Implementation: `server/middleware/rate-limiter.ts`
- Auth endpoints: Special limiter (`authRateLimiter`) - stricter limits
- General API: 100 requests per 15 minutes per IP
- Prevents brute force attacks and API abuse

## Security Headers

**CORS:**
- Express CORS middleware: `server/middleware/cors.ts`
- Allowed origins: `budgetbot.online`, `m.budgetbot.online`, `localhost` (dev)
- Socket.IO CORS: Synced with Express CORS in `server/lib/websocket.ts`

**Security Headers:**
- Helmet 8.1.0: `server/middleware/security-headers.ts`
- Sets: Content-Security-Policy, X-Frame-Options, X-Content-Type-Options, etc.
- WebSocket allowed: `ws://localhost:*`, `ws://127.0.0.1:*`

---

*Integration audit: 2026-02-19*
