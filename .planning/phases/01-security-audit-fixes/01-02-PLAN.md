---
phase: 01-security-audit-fixes
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/middleware/security-headers.ts
  - server/middleware/cors.ts
  - server/middleware/__tests__/security-headers.test.ts
  - server/middleware/__tests__/cors.security.test.ts
autonomous: true
requirements:
  - SEC-05
  - SEC-06
  - SEC-07

must_haves:
  truths:
    - "HSTS header is returned in production mode"
    - "HSTS header is NOT returned in development mode"
    - "localhost:5000 is NOT in ALLOWED_ORIGINS in any environment"
    - "Socket.IO CORS uses the same ALLOWED_ORIGINS as Express CORS (no separate list)"
  artifacts:
    - path: "server/middleware/security-headers.ts"
      provides: "Helmet config with conditional HSTS (production-only)"
      contains: "isProduction"
    - path: "server/middleware/cors.ts"
      provides: "CORS origins without localhost:5000"
    - path: "server/middleware/__tests__/security-headers.test.ts"
      provides: "Tests for HSTS in production vs development"
    - path: "server/middleware/__tests__/cors.security.test.ts"
      provides: "Tests for CORS origin list and Socket.IO sync"
  key_links:
    - from: "server/middleware/security-headers.ts"
      to: "server/lib/env.ts"
      via: "import { isProduction } from '../lib/env'"
      pattern: "isProduction"
    - from: "server/lib/websocket.ts"
      to: "server/middleware/cors.ts"
      via: "import { ALLOWED_ORIGINS } from '../middleware/cors'"
      pattern: "ALLOWED_ORIGINS"
---

<objective>
Fix HSTS, CORS, and WebSocket CORS security issues: enable HSTS in production (SEC-05), remove localhost:5000 from CORS origins (SEC-06), verify Socket.IO CORS is synced (SEC-07).

Purpose: These three fixes are independent config/header changes that don't touch business logic. SEC-07 is auto-fixed by SEC-06 (websocket.ts already imports ALLOWED_ORIGINS from cors.ts), so it only needs a verification test.

Output: Production-ready security headers with HSTS, clean CORS origins, verified Socket.IO sync. All TDD-verified.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-audit-fixes/01-RESEARCH.md

@server/middleware/security-headers.ts
@server/middleware/cors.ts
@server/lib/websocket.ts
@server/lib/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for HSTS, CORS, and Socket.IO CORS sync</name>
  <files>
    server/middleware/__tests__/security-headers.test.ts
    server/middleware/__tests__/cors.security.test.ts
  </files>
  <action>
Create test files that assert secure behavior. These tests MUST FAIL against the current code.

**File 1: `server/middleware/__tests__/security-headers.test.ts`**

Use vitest. This tests the helmet middleware output.

Approach: Call the `securityHeaders` middleware with a mock `req`, `res`, `next`. Inspect what headers were set on `res`. Helmet calls `res.setHeader()` or sets headers internally.

Simpler approach: Since helmet returns middleware, and the current code has `hsts: false`, we can test this by:
1. Mock `../lib/env` to set `isProduction = true`.
2. Re-import `security-headers.ts` (use `vi.resetModules()` + dynamic import).
3. Create Express-like mock req/res/next.
4. Call the middleware.
5. Assert `Strict-Transport-Security` header is set on the response.

However, the simplest reliable approach for the RED test: Read the source file with `fs.readFileSync` and assert it does NOT contain `hsts: false` as a bare value (i.e., assert it uses `isProduction` conditional). Currently `security-headers.ts` has `hsts: false`, so this MUST fail.

Additionally, write a more functional test:
- Mock `isProduction` from `../../lib/env` as `true`.
- Use `vi.resetModules()` to reload `security-headers.ts` with the new mock.
- Create mock `req`, `res` (with `setHeader` spy, `getHeader` spy), `next`.
- Call the middleware.
- Assert that `Strict-Transport-Security` header was set (helmet sets it via `res.setHeader`).
- This test MUST fail because current code has `hsts: false` unconditionally.

**File 2: `server/middleware/__tests__/cors.security.test.ts`**

Test cases:
1. **SEC-06**: "ALLOWED_ORIGINS should NOT contain localhost:5000 in development" -- Set `process.env.NODE_ENV = 'development'`, use `vi.resetModules()` to re-import `cors.ts`. Assert that `ALLOWED_ORIGINS` does not include `'http://localhost:5000'`. Currently it IS pushed in development, so this MUST fail.

2. **SEC-07**: "Socket.IO should use the same ALLOWED_ORIGINS as Express CORS" -- Read `server/lib/websocket.ts` source, assert it imports `ALLOWED_ORIGINS` from `'../middleware/cors'` and passes it to Socket.IO `cors.origin`. This is a static analysis test. Read the file, check for the import pattern and usage. This should already PASS (websocket.ts already does this correctly). SEC-07 test passes immediately -- existing code is already correct; the test exists to document and guard this property.

Run tests and confirm the HSTS test and CORS localhost test FAIL (RED). SEC-07 sync test will pass immediately.
  </action>
  <verify>Run `npx vitest run server/middleware/__tests__/security-headers.test.ts server/middleware/__tests__/cors.security.test.ts` -- HSTS test and CORS localhost:5000 test must FAIL. SEC-07 sync test may pass (confirming existing correct behavior).</verify>
  <done>Test files exist. Tests for SEC-05 and SEC-06 fail against current insecure code. SEC-07 sync verification test confirms websocket.ts imports ALLOWED_ORIGINS correctly. Note: SEC-07 test passes immediately -- existing code is already correct, so no RED phase is possible for this specific requirement.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Fix SEC-05 (HSTS), SEC-06 (CORS localhost), verify SEC-07</name>
  <files>
    server/middleware/security-headers.ts
    server/middleware/cors.ts
  </files>
  <action>
**Fix 1 -- SEC-05: Enable HSTS in production**

In `server/middleware/security-headers.ts`:
- Add import at top: `import { isProduction } from '../lib/env';`
- Replace `hsts: false,` with:
```typescript
hsts: isProduction
  ? { maxAge: 31536000, includeSubDomains: true, preload: true }
  : false,
```
- Keep the comment updated: change "Disabled for HTTP-only deployments" to "Enabled in production (HTTPS via nginx), disabled in development"

**Fix 2 -- SEC-06: Remove localhost:5000 from CORS**

In `server/middleware/cors.ts`, remove `'http://localhost:5000'` from the development push list (line 20). Keep `localhost:8081`, `localhost:19006`, and `localhost:3000` (those are actual dev client ports). Port 5000 is the API server itself and should never be a CORS origin.

After:
```typescript
if (process.env.NODE_ENV === 'development') {
  ALLOWED_ORIGINS.push(
    'http://localhost:8081',
    'http://localhost:19006',
    'http://localhost:3000',
  );
}
```

**SEC-07: No code change needed.** `server/lib/websocket.ts` already imports `ALLOWED_ORIGINS` from `../middleware/cors` and uses it. Removing `localhost:5000` from cors.ts automatically fixes Socket.IO CORS too.

Run tests to confirm GREEN. Then run full test suite.
  </action>
  <verify>
Run `npx vitest run server/middleware/__tests__/security-headers.test.ts server/middleware/__tests__/cors.security.test.ts` -- ALL tests must PASS.
Run `npx vitest run` -- no new failures.
Run `npx tsc --noEmit` -- must pass.
  </verify>
  <done>
SEC-05: HSTS is enabled in production with maxAge=31536000, includeSubDomains, preload. Disabled in development.
SEC-06: `localhost:5000` removed from CORS ALLOWED_ORIGINS in all environments (it was only in development, now removed entirely).
SEC-07: Socket.IO CORS confirmed synced via shared ALLOWED_ORIGINS import (no separate code change needed).
All tests pass. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
- `grep "isProduction" server/middleware/security-headers.ts` confirms HSTS uses production check
- `grep "localhost:5000" server/middleware/cors.ts` returns nothing
- `grep "ALLOWED_ORIGINS" server/lib/websocket.ts` confirms Socket.IO uses shared origins
- `npx vitest run` -- no new failures
- `npx tsc --noEmit` -- clean
</verification>

<success_criteria>
- HSTS header is set in production mode with 1-year max-age (SEC-05)
- localhost:5000 is not in CORS origins in any environment (SEC-06)
- Socket.IO CORS uses the same ALLOWED_ORIGINS as Express (SEC-07)
- All assertions verified via TDD
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-audit-fixes/01-02-SUMMARY.md`
</output>
