---
phase: 01-security-audit-fixes
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/services/password-recovery.service.ts
  - server/services/password-reset.service.ts
  - server/lib/env.ts
  - tests/setup.ts
  - server/services/__tests__/password-recovery.security.test.ts
  - server/services/__tests__/password-reset.security.test.ts
autonomous: true
requirements:
  - SEC-01
  - SEC-02
  - SEC-03

must_haves:
  truths:
    - "Recovery code is never logged in plaintext"
    - "JWT signing and password reset HMAC use different secrets"
    - "Application crashes at startup if PASSWORD_RESET_SECRET is missing"
    - "No fallback secret strings exist in production code"
  artifacts:
    - path: "server/services/password-recovery.service.ts"
      provides: "Recovery service without plaintext logging, using env.PASSWORD_RESET_SECRET"
      contains: "env.PASSWORD_RESET_SECRET"
    - path: "server/services/password-reset.service.ts"
      provides: "Reset service using env.PASSWORD_RESET_SECRET"
      contains: "env.PASSWORD_RESET_SECRET"
    - path: "server/lib/env.ts"
      provides: "PASSWORD_RESET_SECRET field in Zod schema"
      contains: "PASSWORD_RESET_SECRET"
    - path: "tests/setup.ts"
      provides: "Test env setup with PASSWORD_RESET_SECRET"
      contains: "PASSWORD_RESET_SECRET"
    - path: "server/services/__tests__/password-recovery.security.test.ts"
      provides: "Tests for SEC-01 (no plaintext logging) and SEC-02/03 (separate secret, no fallback)"
    - path: "server/services/__tests__/password-reset.security.test.ts"
      provides: "Tests for SEC-02/03 (separate secret, no fallback) in password-reset"
  key_links:
    - from: "server/services/password-recovery.service.ts"
      to: "server/lib/env.ts"
      via: "import { env } from '../lib/env'"
      pattern: "env\\.PASSWORD_RESET_SECRET"
    - from: "server/services/password-reset.service.ts"
      to: "server/lib/env.ts"
      via: "import { env } from '../lib/env'"
      pattern: "env\\.PASSWORD_RESET_SECRET"
---

<objective>
Fix password recovery/reset security vulnerabilities: remove plaintext code logging (SEC-01), add dedicated PASSWORD_RESET_SECRET (SEC-02), remove fallback secret strings (SEC-03).

Purpose: These three fixes are tightly coupled -- they all touch password-recovery.service.ts and relate to secret management. SEC-02 and SEC-03 are implemented together (adding env var + removing fallback are two sides of the same change).

Output: Secure password recovery/reset services with separate HMAC secret, no plaintext logging, no fallback secrets. All verified via TDD.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-audit-fixes/01-RESEARCH.md

@server/services/password-recovery.service.ts
@server/services/password-reset.service.ts
@server/lib/env.ts
@tests/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing security tests for SEC-01, SEC-02, SEC-03</name>
  <files>
    server/services/__tests__/password-recovery.security.test.ts
    server/services/__tests__/password-reset.security.test.ts
  </files>
  <action>
Create two test files that assert secure behavior. These tests MUST FAIL against the current (insecure) code.

**File 1: `server/services/__tests__/password-recovery.security.test.ts`**

Use vitest with `vi.mock` to mock `../../lib/logger`, `../../db`, `../../telegram/bot`, `../../telegram/language`, `@shared/i18n`, `@shared/schema`.

Test cases:
1. **SEC-01**: "should NOT log recovery code in plaintext" -- Call `saveRecoveryCode` (or `requestPasswordRecovery` with mocked DB returning a user with telegramId). Assert that `logInfo` mock was NEVER called with an object containing `code` property. Currently the code logs `{ code, expiresAt }` so this test MUST fail.

2. **SEC-02/03 (recovery)**: "should use env.PASSWORD_RESET_SECRET instead of process.env.SESSION_SECRET" -- Call `verifyRecoveryCode` with a valid code setup. Assert that the HMAC is computed using `env.PASSWORD_RESET_SECRET` (not `process.env.SESSION_SECRET`). Approach: mock `../../lib/env` to return `{ PASSWORD_RESET_SECRET: 'test-reset-secret-32-characters!!' }`. Then verify the generated resetToken uses this secret (decode the base64url token, recompute HMAC with the mocked secret, compare). Currently the code uses `process.env.SESSION_SECRET || 'default-secret...'` so this test MUST fail.

3. **SEC-03 (recovery)**: "should NOT contain fallback default-secret string" -- Read the source file content with `fs.readFileSync` and assert it does NOT contain `'default-secret-change-in-production'`. Currently it does, so this MUST fail.

**File 2: `server/services/__tests__/password-reset.security.test.ts`**

Use vitest with `vi.mock` for `../../lib/logger`, `../../db`, `@shared/schema`.

Test cases:
1. **SEC-02/03 (reset)**: "verifyResetToken should use env.PASSWORD_RESET_SECRET" -- Create a token using the mocked `env.PASSWORD_RESET_SECRET`, call `verifyResetToken(token)`, assert it returns a valid userId. Mock `../../lib/env` to provide `{ PASSWORD_RESET_SECRET: 'test-reset-secret-32-characters!!' }`. Currently the code reads `process.env.SESSION_SECRET || 'default-secret...'`, so verifying a token signed with `PASSWORD_RESET_SECRET` MUST fail.

2. **SEC-03 (reset)**: "should NOT contain fallback default-secret string" -- Same fs.readFileSync approach. MUST fail.

Run `npx vitest run server/services/__tests__/password-recovery.security.test.ts server/services/__tests__/password-reset.security.test.ts` and confirm ALL tests fail (RED phase).

Important: The `__tests__` directory may not exist yet under `server/services/` -- create it.
  </action>
  <verify>Run `npx vitest run server/services/__tests__/password-recovery.security.test.ts server/services/__tests__/password-reset.security.test.ts` -- ALL tests must FAIL (red phase of TDD).</verify>
  <done>Test files exist, all security tests fail against current insecure code, confirming they correctly detect the vulnerabilities.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Fix SEC-01, SEC-02, SEC-03 and make tests pass</name>
  <files>
    server/lib/env.ts
    server/services/password-recovery.service.ts
    server/services/password-reset.service.ts
    tests/setup.ts
  </files>
  <action>
Apply all three fixes in order. After each file change, confirm the related test(s) turn green.

**Fix 1 -- SEC-02/SEC-03: Add PASSWORD_RESET_SECRET to env schema**

In `server/lib/env.ts`, add to the `envSchema` object (after SESSION_SECRET):
```typescript
PASSWORD_RESET_SECRET: z.string()
  .min(32, 'PASSWORD_RESET_SECRET must be at least 32 characters for security')
  .describe('HMAC secret for password reset tokens (generate with: openssl rand -base64 32)'),
```

Also add to the startup log block (after SESSION_SECRET line):
```typescript
console.log(`   PASSWORD_RESET_SECRET: ${'*'.repeat(10)} (${parsed.PASSWORD_RESET_SECRET.length} chars)`);
```

In `tests/setup.ts`, add after the SESSION_SECRET line:
```typescript
process.env.PASSWORD_RESET_SECRET = process.env.PASSWORD_RESET_SECRET || 'test-password-reset-secret-32-chars!!';
```

**Fix 2 -- SEC-02/SEC-03: Replace secret usage in password-recovery.service.ts**

In `server/services/password-recovery.service.ts`:
- Add import at top: `import { env } from '../lib/env';`
- Line 299 area (in `verifyRecoveryCode`): Replace `const secret = process.env.SESSION_SECRET || 'default-secret-change-in-production';` with `const secret = env.PASSWORD_RESET_SECRET;`

**Fix 3 -- SEC-02/SEC-03: Replace secret usage in password-reset.service.ts**

In `server/services/password-reset.service.ts`:
- Add import at top: `import { env } from '../lib/env';`
- Line 67 area (in `verifyResetToken`): Replace `const secret = process.env.SESSION_SECRET || 'default-secret-change-in-production';` with `const secret = env.PASSWORD_RESET_SECRET;`

**Fix 4 -- SEC-01: Remove plaintext code from log**

In `server/services/password-recovery.service.ts`, line 81-84, change the logInfo call from:
```typescript
logInfo(`Recovery code generated for user ${userId}`, {
  code,
  expiresAt: expiresAt.toISOString(),
});
```
to:
```typescript
logInfo(`Recovery code generated for user ${userId}`, {
  expiresAt: expiresAt.toISOString(),
});
```

After all fixes, run the security tests to confirm GREEN.
Then run the full test suite: `npx vitest run` -- must pass (ignoring known pre-existing failures in notification.service.test.ts and password-reset.service.test.ts).
  </action>
  <verify>
Run `npx vitest run server/services/__tests__/password-recovery.security.test.ts server/services/__tests__/password-reset.security.test.ts` -- ALL tests must PASS.
Run `npx vitest run` -- no NEW failures (pre-existing failures in notification and password-reset are known and not caused by these changes).
Run `npx tsc --noEmit` -- must pass with no type errors.
  </verify>
  <done>
SEC-01: `logInfo` in `saveRecoveryCode` no longer includes `code` property.
SEC-02: `PASSWORD_RESET_SECRET` exists as required field in env.ts Zod schema, used in both service files.
SEC-03: No `|| 'default-secret-change-in-production'` fallback exists in either service file.
All security tests pass. Full test suite has no new failures. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
- `grep -r "default-secret" server/services/` returns nothing
- `grep "code," server/services/password-recovery.service.ts` does NOT match the logInfo call (only the function parameter and DB insert)
- `grep "PASSWORD_RESET_SECRET" server/lib/env.ts` shows the Zod field
- `grep "env.PASSWORD_RESET_SECRET" server/services/password-recovery.service.ts server/services/password-reset.service.ts` shows both files use it
- `npx vitest run` -- no new failures
- `npx tsc --noEmit` -- clean
</verification>

<success_criteria>
- Recovery code is never logged in plaintext (SEC-01)
- JWT signing (SESSION_SECRET) and password reset HMAC (PASSWORD_RESET_SECRET) use separate secrets (SEC-02)
- No fallback secret strings exist -- app crashes at startup if PASSWORD_RESET_SECRET is missing (SEC-03)
- All assertions verified via TDD (red then green)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-audit-fixes/01-01-SUMMARY.md`
</output>
