---
phase: 01-security-audit-fixes
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/middleware/lib/create-redis-store.ts
  - server/middleware/rate-limit.ts
  - server/middleware/rate-limiter.ts
  - server/middleware/__tests__/rate-limit.test.ts
  - server/middleware/__tests__/rate-limiter.test.ts
autonomous: true
requirements:
  - SEC-04

must_haves:
  truths:
    - "All 8 rate limiters use Redis store when Redis is available"
    - "Rate limiters gracefully fall back to in-memory when Redis is not available"
    - "Rate limiter state persists across application restarts (via Redis)"
    - "createRedisStore is defined once in a shared module and imported by both rate-limit.ts and rate-limiter.ts"
  artifacts:
    - path: "server/middleware/lib/create-redis-store.ts"
      provides: "Shared createRedisStore factory function"
      exports: ["createRedisStore"]
      contains: "getRedisClient"
    - path: "server/middleware/rate-limit.ts"
      provides: "5 rate limiters with Redis store"
      contains: "createRedisStore"
    - path: "server/middleware/rate-limiter.ts"
      provides: "3 rate limiters with Redis store"
      contains: "createRedisStore"
    - path: "server/middleware/__tests__/rate-limit.test.ts"
      provides: "Tests verifying Redis store is used in rate-limit.ts limiters"
    - path: "server/middleware/__tests__/rate-limiter.test.ts"
      provides: "Tests verifying Redis store is used in rate-limiter.ts limiters"
  key_links:
    - from: "server/middleware/lib/create-redis-store.ts"
      to: "server/lib/redis.ts"
      via: "import { getRedisClient } from '../../lib/redis'"
      pattern: "getRedisClient"
    - from: "server/middleware/rate-limit.ts"
      to: "server/middleware/lib/create-redis-store.ts"
      via: "import { createRedisStore } from './lib/create-redis-store'"
      pattern: "createRedisStore"
    - from: "server/middleware/rate-limiter.ts"
      to: "server/middleware/lib/create-redis-store.ts"
      via: "import { createRedisStore } from './lib/create-redis-store'"
      pattern: "createRedisStore"
    - from: "server/middleware/lib/create-redis-store.ts"
      to: "rate-limit-redis"
      via: "import { RedisStore } from 'rate-limit-redis'"
      pattern: "RedisStore"
---

<objective>
Add Redis persistence to all 8 rate limiters across two files (SEC-04). Rate limit counters must survive pm2 restarts.

Purpose: Currently all rate limiters use in-memory storage, which resets on every pm2 restart -- allowing attackers to bypass rate limits by triggering a restart. Redis-backed storage persists counters across restarts.

Output: All 8 rate limiters use RedisStore when Redis is available, with graceful fallback to in-memory when Redis is not configured. Shared `createRedisStore` factory extracted per locked decision (reusable code 2+ times -> separate function). TDD-verified.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-audit-fixes/01-RESEARCH.md

@server/middleware/rate-limit.ts
@server/middleware/rate-limiter.ts
@server/lib/redis.ts
@server/middleware/__tests__/rate-limit.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install rate-limit-redis and write RED tests</name>
  <files>
    server/middleware/__tests__/rate-limit.test.ts
    server/middleware/__tests__/rate-limiter.test.ts
  </files>
  <action>
**Step 1: Install rate-limit-redis**

Run `npm install rate-limit-redis` in the project root. This package is already in package.json but not in node_modules (verified). Version 4.3.1 expected.

**Step 2: Write failing tests**

**Update existing file: `server/middleware/__tests__/rate-limit.test.ts`**

Keep existing tests (they verify limiters are defined and callable). ADD new test cases:

```typescript
describe('Redis Store Integration', () => {
  it('rate-limit.ts should import createRedisStore from shared module', () => {
    const source = fs.readFileSync(
      path.resolve(__dirname, '../rate-limit.ts'), 'utf-8'
    );
    // Must import from shared module, NOT define locally
    expect(source).toContain("from './lib/create-redis-store'");
    expect(source).not.toContain('function createRedisStore');
  });

  it('rate-limit.ts should use createRedisStore for each limiter', () => {
    const source = fs.readFileSync(
      path.resolve(__dirname, '../rate-limit.ts'), 'utf-8'
    );
    expect(source).toContain("createRedisStore('rl:auth:");
    expect(source).toContain("createRedisStore('rl:ai:");
    expect(source).toContain("createRedisStore('rl:general:");
    expect(source).toContain("createRedisStore('rl:strict:");
    expect(source).toContain("createRedisStore('rl:heavy:");
  });
});

describe('Shared Module', () => {
  it('create-redis-store.ts should exist and export createRedisStore', () => {
    const source = fs.readFileSync(
      path.resolve(__dirname, '../lib/create-redis-store.ts'), 'utf-8'
    );
    expect(source).toContain('export function createRedisStore');
    expect(source).toContain('getRedisClient');
    expect(source).toContain("from 'rate-limit-redis'");
  });
});
```

These tests MUST FAIL because current `rate-limit.ts` has no Redis imports and the shared module does not exist.

**Create new file: `server/middleware/__tests__/rate-limiter.test.ts`**

Same pattern for the second file:
```typescript
describe('Redis Store Integration', () => {
  it('rate-limiter.ts should import createRedisStore from shared module', () => {
    const source = fs.readFileSync(
      path.resolve(__dirname, '../rate-limiter.ts'), 'utf-8'
    );
    // Must import from shared module, NOT define locally
    expect(source).toContain("from './lib/create-redis-store'");
    expect(source).not.toContain('function createRedisStore');
  });

  it('rate-limiter.ts should use createRedisStore for each limiter', () => {
    const source = fs.readFileSync(
      path.resolve(__dirname, '../rate-limiter.ts'), 'utf-8'
    );
    expect(source).toContain("createRedisStore('rl:api:");
    expect(source).toContain("createRedisStore('rl:auth2:");
    expect(source).toContain("createRedisStore('rl:ai2:");
  });
});
```

Also add basic smoke tests: each limiter is defined and is a function.

Run tests and confirm the Redis Store Integration tests FAIL (RED).

**Note on prefix naming:** Use distinct prefixes for each limiter to avoid counter collisions. For `rate-limiter.ts` use `rl:api:`, `rl:auth2:`, `rl:ai2:` (the "2" suffix distinguishes from `rate-limit.ts` limiters that use `rl:auth:` and `rl:ai:`).
  </action>
  <verify>Run `npx vitest run server/middleware/__tests__/rate-limit.test.ts server/middleware/__tests__/rate-limiter.test.ts` -- Redis Store Integration tests must FAIL. Existing smoke tests should still pass.</verify>
  <done>rate-limit-redis is installed. Test files have Redis store assertions that fail against current code (no Redis store used, no shared module exists). Tests explicitly verify both files import from shared module (not define locally). Existing tests preserved.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Extract shared createRedisStore and add Redis store to all 8 rate limiters</name>
  <files>
    server/middleware/lib/create-redis-store.ts
    server/middleware/rate-limit.ts
    server/middleware/rate-limiter.ts
  </files>
  <action>
**Step 1: Create the shared `createRedisStore` module.**

Per locked user decision: "Reusable code (2+ times) -> separate function". `createRedisStore` is used in 2 files, so it MUST be extracted to a shared module.

Create `server/middleware/lib/create-redis-store.ts`:
```typescript
/**
 * Shared Redis store factory for rate limiters
 *
 * Used by rate-limit.ts and rate-limiter.ts
 * Returns undefined if Redis is not available (falls back to in-memory)
 */
import { RedisStore } from 'rate-limit-redis';
import type { RedisReply } from 'rate-limit-redis';
import { getRedisClient } from '../../lib/redis';

export function createRedisStore(prefix: string): RedisStore | undefined {
  const client = getRedisClient();
  if (!client) return undefined;
  return new RedisStore({
    sendCommand: (command: string, ...args: string[]) =>
      client.call(command, ...args) as Promise<RedisReply>,
    prefix,
  });
}
```

This file is ~20 lines -- junior-friendly, single responsibility, well-commented.

**Step 2: Update `server/middleware/rate-limit.ts`**

Add import at the top:
```typescript
import { createRedisStore } from './lib/create-redis-store';
```

Add `store` property to each of the 5 limiters:
- `authRateLimiter`: `store: createRedisStore('rl:auth:'),`
- `aiRateLimiter`: `store: createRedisStore('rl:ai:'),`
- `generalRateLimiter`: `store: createRedisStore('rl:general:'),`
- `strictRateLimiter`: `store: createRedisStore('rl:strict:'),`
- `heavyOperationRateLimiter`: `store: createRedisStore('rl:heavy:'),`

Do NOT add `RedisStore`, `getRedisClient` imports or a local `createRedisStore` function -- everything comes from the shared module.

**Step 3: Update `server/middleware/rate-limiter.ts`**

Add the same import:
```typescript
import { createRedisStore } from './lib/create-redis-store';
```

Add `store` to each of the 3 limiters:
- `apiLimiter`: `store: createRedisStore('rl:api:'),`
- `authLimiter`: `store: createRedisStore('rl:auth2:'),`
- `aiLimiter`: `store: createRedisStore('rl:ai2:'),`

**Important:** Keep files under 200 lines. `rate-limit.ts` is currently 113 lines, adding ~6 lines (1 import + 5 store lines) = ~119 lines (OK). `rate-limiter.ts` is 63 lines, adding ~4 lines = ~67 lines (OK). The shared module is ~20 lines (OK).

After changes, run tests to confirm GREEN. Then run full suite.
  </action>
  <verify>
Run `npx vitest run server/middleware/__tests__/rate-limit.test.ts server/middleware/__tests__/rate-limiter.test.ts` -- ALL tests must PASS.
Run `npx vitest run` -- no new failures.
Run `npx tsc --noEmit` -- must pass.
  </verify>
  <done>
SEC-04: All 8 rate limiters use RedisStore with unique prefixes.
Graceful fallback: if Redis is not connected, `createRedisStore` returns `undefined` and express-rate-limit uses in-memory store.
`createRedisStore` is defined once in `server/middleware/lib/create-redis-store.ts` and imported by both consumer files (per locked decision: reusable code 2+ times -> separate function).
All tests pass. TypeScript compiles clean. All files stay under 200 lines.
  </done>
</task>

</tasks>

<verification>
- `cat server/middleware/lib/create-redis-store.ts` shows the shared factory function
- `grep "from './lib/create-redis-store'" server/middleware/rate-limit.ts server/middleware/rate-limiter.ts` shows both files import from shared module
- `grep "function createRedisStore" server/middleware/rate-limit.ts server/middleware/rate-limiter.ts` returns nothing (not defined locally)
- `grep "function createRedisStore" server/middleware/lib/create-redis-store.ts` shows it is defined in shared module
- Count 8 `store:` lines across both files (5 in rate-limit.ts, 3 in rate-limiter.ts)
- `wc -l server/middleware/rate-limit.ts server/middleware/rate-limiter.ts server/middleware/lib/create-redis-store.ts` -- all under 200 lines
- `npx vitest run` -- no new failures
- `npx tsc --noEmit` -- clean
</verification>

<success_criteria>
- All 8 rate limiters have `store: createRedisStore(...)` with unique prefixes (SEC-04)
- Redis store creation is graceful (returns undefined if Redis unavailable)
- `createRedisStore` lives in shared module `server/middleware/lib/create-redis-store.ts` (per locked decision)
- Both consumer files import from shared module, neither defines it locally
- Files remain under 200 lines
- All tests pass via TDD
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-audit-fixes/01-03-SUMMARY.md`
</output>
