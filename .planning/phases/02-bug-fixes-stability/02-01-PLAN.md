---
phase: 02-bug-fixes-stability
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/services/password-recovery.service.ts
  - server/services/__tests__/password-recovery.service.test.ts
  - server/services/transaction.service.ts
  - server/services/__tests__/transaction.service.test.ts
autonomous: true
requirements:
  - BUG-01
  - BUG-02

must_haves:
  truths:
    - "Password recovery for email-only user returns method 'none', not 'email'"
    - "Transaction access by wrong user logs authorization denial with context"
    - "Transaction not found still returns null without logging (expected behavior)"
  artifacts:
    - path: "server/services/password-recovery.service.ts"
      provides: "Honest recovery method response"
      contains: "method: 'none'"
    - path: "server/services/transaction.service.ts"
      provides: "Authorization denial logging for getTransaction"
      contains: "logInfo"
    - path: "server/services/__tests__/password-recovery.service.test.ts"
      provides: "Test for BUG-01 fix"
      contains: "method.*none"
    - path: "server/services/__tests__/transaction.service.test.ts"
      provides: "Test for BUG-02 authorization denial logging"
      contains: "logInfo"
  key_links:
    - from: "server/services/password-recovery.service.ts"
      to: "RecoveryRequestResult type"
      via: "method field value"
      pattern: "method: 'none'"
    - from: "server/services/transaction.service.ts"
      to: "server/lib/logger.ts"
      via: "logInfo import"
      pattern: "import.*logInfo.*from.*logger"
---

<objective>
Fix two service-layer bugs using TDD: (1) password recovery returns misleading `method: 'email'` when no email service exists, and (2) transaction authorization denial is silent with no logging context.

Purpose: Eliminate misleading API responses and improve observability for authorization failures in service layer.
Output: Two fixed services with passing TDD tests confirming correct behavior.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes-stability/02-RESEARCH.md

@server/services/password-recovery.service.ts
@server/services/transaction.service.ts
@server/services/__tests__/password-recovery.service.test.ts
@server/services/__tests__/transaction.service.test.ts
@server/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD fix for BUG-01 — password recovery method: 'email' -> 'none'</name>
  <files>
    server/services/__tests__/password-recovery.service.test.ts
    server/services/password-recovery.service.ts
  </files>
  <action>
**RED phase:**
Add a test case to the existing `password-recovery.service.test.ts` file. The test should cover the scenario: user has email but no Telegram linked, Telegram send fails -> result should have `method: 'none'` (not `method: 'email'`).

Test name: `'returns method "none" when user has email but no Telegram (BUG-01)'`

Mock setup:
- Mock user with email set, telegramId null or Telegram send fails
- Mock `sendCodeViaTelegram` to return false
- Call `requestPasswordRecovery` with that user's email/username

Assert: `expect(result.method).toBe('none')` and `expect(result.success).toBe(false)` and expect error message mentions email recovery not implemented.

Run test — it MUST fail (currently returns `method: 'email'`).

**GREEN phase:**
Fix `password-recovery.service.ts` line 204: change `method: 'email'` to `method: 'none'`. Keep the `'email'` value in the TypeScript type union (RecoveryRequestResult) for future use. Only change the returned value.

Optionally improve the error message: `'Email recovery not yet implemented. Please link your Telegram account.'`

Run test — it MUST pass.

**Important:** Do NOT remove `'email'` from the TypeScript union type — it will be used when email service is implemented (v2). Do NOT touch any other lines in the file.
  </action>
  <verify>
Run `npx vitest run server/services/__tests__/password-recovery.service.test.ts` — all tests pass including the new BUG-01 test.
Run `npx vitest run` — full test suite passes (excluding known pre-existing failures in notification.service and password-reset.service).
  </verify>
  <done>
Password recovery returns `method: 'none'` (not `'email'`) when user has email but no working Telegram recovery. Test confirms the fix.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD fix for BUG-02 — transaction authorization denial logging</name>
  <files>
    server/services/__tests__/transaction.service.test.ts
    server/services/transaction.service.ts
  </files>
  <action>
**RED phase:**
Add a test case to the existing `transaction.service.test.ts`. The test should cover: when a transaction exists but belongs to a different user, `getTransaction` should return null AND call `logInfo` with authorization denial context (transactionId and requestingUserId).

Test name: `'logs authorization denial when user accesses another user transaction (BUG-02)'`

Mock setup:
- Mock `transactionRepository.getTransactionById` to return a transaction with `userId: 999`
- Call `getTransaction(1, 123)` (transactionId 1, requesting userId 123)
- Mock `logInfo` from `../../lib/logger`

Assert: `expect(result).toBeNull()` and `expect(logInfo).toHaveBeenCalledWith(expect.stringContaining('access denied'), expect.objectContaining({ transactionId: 1, requestingUserId: 123 }))`.

Run test — it MUST fail (currently no logInfo call).

**GREEN phase:**
Fix `transaction.service.ts` `getTransaction` method (lines 62-68). Split the combined condition:

```typescript
async getTransaction(id: number, userId: number) {
  const transaction = await transactionRepository.getTransactionById(id);
  if (!transaction) {
    return null;
  }
  if (transaction.userId !== userId) {
    logInfo('Transaction access denied: userId mismatch', { transactionId: id, requestingUserId: userId });
    return null;
  }
  return transaction;
}
```

Add `import { logInfo } from '../lib/logger';` at the top of the file if not already imported.

Run test — it MUST pass.

**Scope note per research:** Do NOT modify `api-key-manager.ts` — `checkUserOwnKey()` returning null for "no BYOK key" is intentional design. Do NOT modify `admin-users.service.ts` line 241 — the null for "user not found" is correct with existing error logging in outer catch.
  </action>
  <verify>
Run `npx vitest run server/services/__tests__/transaction.service.test.ts` — all tests pass including the new BUG-02 test.
Run `npx vitest run` — full test suite passes (excluding known pre-existing failures).
  </verify>
  <done>
`getTransaction()` logs an authorization denial with context (transactionId, requestingUserId) when a user tries to access another user's transaction. "Not found" case still returns null silently (correct behavior). Test confirms the fix.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run server/services/__tests__/password-recovery.service.test.ts` — passes
2. `npx vitest run server/services/__tests__/transaction.service.test.ts` — passes
3. `npx vitest run` — full suite passes (excluding known pre-existing failures)
4. `npx tsc --noEmit` — no type errors
5. Grep for `method: 'email'` in password-recovery.service.ts — should NOT appear in the email fallback block (line ~204)
6. Grep for `logInfo` in transaction.service.ts — should appear in getTransaction method
</verification>

<success_criteria>
- BUG-01: password-recovery.service.ts returns `method: 'none'` for email-only users with no Telegram
- BUG-02: transaction.service.ts logs authorization denial with transactionId and requestingUserId
- All new tests follow TDD (RED -> GREEN) with atomic commits
- No regressions in existing test suite
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes-stability/02-01-SUMMARY.md`
</output>
