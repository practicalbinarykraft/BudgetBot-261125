---
phase: 02-bug-fixes-stability
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/services/admin-users.service.ts
  - server/services/__tests__/admin-users.service.test.ts
  - server/middleware/mobile-auth.ts
  - server/middleware/__tests__/mobile-auth.test.ts
autonomous: true
requirements:
  - BUG-03
  - BUG-04

must_haves:
  truths:
    - "Credits calculation error in getUserDetails is logged with logError, not logDebug"
    - "getUserDetails still returns zero credits (not crash) when getCreditBalance throws"
    - "JWT NotBeforeError returns 401 with 'Token not yet valid' message"
    - "JWT TokenExpiredError still returns 401 with 'Token expired' (not caught by base class first)"
    - "JWT JsonWebTokenError returns 401 with 'Invalid token' as fallback"
  artifacts:
    - path: "server/services/admin-users.service.ts"
      provides: "logError in credits catch block instead of logDebug"
      contains: "logError"
    - path: "server/middleware/mobile-auth.ts"
      provides: "Complete JWT error handling with all 3 error types"
      contains: "NotBeforeError"
    - path: "server/services/__tests__/admin-users.service.test.ts"
      provides: "Test for BUG-03 credits error logging"
      contains: "logError"
    - path: "server/middleware/__tests__/mobile-auth.test.ts"
      provides: "Tests for all JWT error types including NotBeforeError"
      contains: "NotBeforeError"
  key_links:
    - from: "server/services/admin-users.service.ts"
      to: "server/lib/logger.ts"
      via: "logError import"
      pattern: "logError.*Failed to get credit balance"
    - from: "server/middleware/mobile-auth.ts"
      to: "jsonwebtoken"
      via: "instanceof checks for all 3 error classes"
      pattern: "NotBeforeError"
---

<objective>
Fix two bugs using TDD: (1) credits error in getUserDetails uses logDebug instead of logError making failures invisible at default log level, and (2) mobile-auth JWT error handling misses NotBeforeError and has wrong instanceof check order.

Purpose: Make credit calculation errors visible in production logs, and ensure all JWT error types return proper 401 responses instead of falling through to 500 errors.
Output: Two fixed modules with passing TDD tests confirming correct behavior.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes-stability/02-RESEARCH.md

@server/services/admin-users.service.ts
@server/middleware/mobile-auth.ts
@server/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD fix for BUG-03 — credits error logging in getUserDetails</name>
  <files>
    server/services/__tests__/admin-users.service.test.ts
    server/services/admin-users.service.ts
  </files>
  <action>
**RED phase:**
Add a test case to the existing `admin-users.service.test.ts`. The test should cover: when `getCreditBalance` throws an error during `getUserDetails`, `logError` should be called (not `logDebug`), and the function should still return a result with zero credits (not throw).

Test name: `'logs credit balance error with logError and returns zero credits (BUG-03)'`

Mock setup:
- Mock `getCreditBalance` (from `../../services/credits.service` or wherever it's imported) to throw `new Error('Redis connection failed')`
- Mock `logError` and `logDebug` from `../../lib/logger`
- Mock the user lookup and transaction queries to return valid data
- Call `getUserDetails(userId)`

Assert:
1. `expect(logError).toHaveBeenCalledWith(expect.stringContaining('credit balance'), expect.any(Error), expect.objectContaining({ userId }))`
2. `expect(logDebug).not.toHaveBeenCalled()` — for the credits catch block specifically
3. `expect(result.credits.messagesRemaining).toBe(0)` — zero fallback preserved
4. Result should NOT throw — the function should return normally

Run test — it MUST fail (currently uses logDebug, not logError).

**GREEN phase:**
Fix `admin-users.service.ts` credits catch block (lines 310-312):

Replace:
```typescript
logDebug('[DEBUG] getUserDetails ERROR getting credits', { error: error instanceof Error ? error.message : String(error) });
logDebug('[DEBUG] getUserDetails ERROR stack', { stack: error instanceof Error ? error.stack : 'no stack' });
```

With:
```typescript
logError('Failed to get credit balance in getUserDetails', error as Error, { userId });
```

Keep the zero fallback (`creditsBalance = { totalGranted: 0, totalUsed: 0, messagesRemaining: 0 };`).

Also ensure `logError` is imported from `../lib/logger` (check existing imports — it may already be imported).

**Scope note per research:** Do NOT remove the `logDebug` calls outside the catch block (lines 289, 291-293, 303, 321). Those are Phase 3 scope (QUAL-07). BUG-03 is specifically about the catch block error logging level.

Run test — it MUST pass.
  </action>
  <verify>
Run `npx vitest run server/services/__tests__/admin-users.service.test.ts` — all tests pass including the new BUG-03 test.
Run `npx vitest run` — full suite passes (excluding known pre-existing failures).
  </verify>
  <done>
Credits error in `getUserDetails` is logged with `logError` (visible at default log level in production). Zero fallback is preserved. Test confirms logError is called with error context and userId.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD fix for BUG-04 — JWT NotBeforeError and error check order in mobile-auth</name>
  <files>
    server/middleware/__tests__/mobile-auth.test.ts
    server/middleware/mobile-auth.ts
  </files>
  <action>
**RED phase:**
Create NEW test file `server/middleware/__tests__/mobile-auth.test.ts`. This file does not exist yet.

Write tests for the `withMobileAuth` middleware covering all JWT error types:

1. Test: `'returns 401 with "Token expired" for TokenExpiredError (BUG-04)'`
   - Make `jwt.verify` throw a `jwt.TokenExpiredError`
   - Assert: response status 401, body `{ error: "Token expired" }`

2. Test: `'returns 401 with "Token not yet valid" for NotBeforeError (BUG-04)'`
   - Make `jwt.verify` throw a `jwt.NotBeforeError`
   - Assert: response status 401, body `{ error: "Token not yet valid" }`

3. Test: `'returns 401 with "Invalid token" for generic JsonWebTokenError (BUG-04)'`
   - Make `jwt.verify` throw a `jwt.JsonWebTokenError`
   - Assert: response status 401, body `{ error: "Invalid token" }`

4. Test: `'calls next(error) for non-JWT errors'`
   - Make `jwt.verify` throw a generic `Error('db failed')`
   - Assert: `next` called with the error, response NOT sent

**Mocking approach:** Use `vi.mock('jsonwebtoken')` to control `jwt.verify` behavior per test. Create real error instances using the jsonwebtoken library's error classes. The mock setup needs `SESSION_SECRET` env var set before import.

Use `vi.doMock` pattern (per locked decision from STATE.md) if you need per-test env overrides. Set `process.env.SESSION_SECRET = 'test-secret'` in `beforeEach`.

Create mock req/res/next objects:
```typescript
const mockReq = { headers: { authorization: 'Bearer test-token' } };
const mockRes = { status: vi.fn().mockReturnThis(), json: vi.fn().mockReturnThis() };
const mockNext = vi.fn();
```

Run tests — test 2 (NotBeforeError) MUST fail (currently falls through to next(error)). Test 1 (TokenExpiredError) may also fail because `JsonWebTokenError` check comes BEFORE `TokenExpiredError` in current code.

**GREEN phase:**
Fix `mobile-auth.ts` catch block (lines 65-72). Reorder and add NotBeforeError:

```typescript
} catch (error) {
  if (error instanceof jwt.TokenExpiredError) {
    return res.status(401).json({ error: "Token expired" } as any);
  }
  if (error instanceof jwt.NotBeforeError) {
    return res.status(401).json({ error: "Token not yet valid" } as any);
  }
  if (error instanceof jwt.JsonWebTokenError) {
    return res.status(401).json({ error: "Invalid token" } as any);
  }
  next(error);
}
```

**Critical:** The order matters. `TokenExpiredError` and `NotBeforeError` both extend `JsonWebTokenError`. Check subclasses FIRST, then the base class.

Run all tests — they MUST all pass.
  </action>
  <verify>
Run `npx vitest run server/middleware/__tests__/mobile-auth.test.ts` — all 4 tests pass.
Run `npx vitest run` — full suite passes (excluding known pre-existing failures).
Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
All 3 JWT error types (TokenExpiredError, NotBeforeError, JsonWebTokenError) return proper 401 responses with specific error messages. Subclass checks come before parent class check. Non-JWT errors pass through to next(). New test file covers all cases.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run server/services/__tests__/admin-users.service.test.ts` — passes
2. `npx vitest run server/middleware/__tests__/mobile-auth.test.ts` — passes
3. `npx vitest run` — full suite passes (excluding known pre-existing failures)
4. `npx tsc --noEmit` — no type errors
5. Grep for `logDebug` in admin-users.service.ts catch block (lines 310-312) — should be replaced with `logError`
6. Grep for `NotBeforeError` in mobile-auth.ts — should appear in catch block
7. Verify instanceof check order: TokenExpiredError -> NotBeforeError -> JsonWebTokenError (subclasses before parent)
</verification>

<success_criteria>
- BUG-03: credits error logged with logError (not logDebug), zero fallback preserved
- BUG-04: all 3 JWT error types return 401 with specific messages, correct check order
- New test file server/middleware/__tests__/mobile-auth.test.ts created with 4 test cases
- All new tests follow TDD (RED -> GREEN) with atomic commits
- No regressions in existing test suite
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes-stability/02-02-SUMMARY.md`
</output>
