---
phase: 03-code-quality
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/admin-users.service.ts
  - server/services/admin-users/list.ts
  - server/services/admin-users/details.ts
  - server/services/admin-users/transactions.ts
  - server/services/admin-users/timeline.ts
  - server/services/trend-calculator.service.ts
  - server/services/trend-calculator/calculate-trend.ts
  - server/services/trend-calculator/forecast-filters.ts
  - server/services/trend-calculator/forecast-processor.ts
autonomous: true
requirements:
  - QUAL-04
  - QUAL-06
  - QUAL-07

must_haves:
  truths:
    - "admin-users.service.ts is under 30 LOC (re-export index only)"
    - "Each sub-module in admin-users/ is under 200 LOC (list.ts and details.ts contain large Drizzle queries that cannot be split further without harming readability; 200 LOC aligns with ROADMAP success criteria)"
    - "All debug logDebug calls removed from getUserDetails (was lines 220-357)"
    - "trend-calculator.service.ts is under 30 LOC (re-export index only)"
    - "Each sub-module in trend-calculator/ is under 150 LOC"
    - "All existing tests pass for both services without modification"
    - "analytics.routes.ts still imports calculateTrend successfully"
  artifacts:
    - path: "server/services/admin-users/list.ts"
      provides: "GetUsersListParams + UsersListResult types + getUsersList function"
      contains: "getUsersList"
    - path: "server/services/admin-users/details.ts"
      provides: "UserDetails type + getUserDetails function (debug logs removed)"
      contains: "getUserDetails"
    - path: "server/services/admin-users/transactions.ts"
      provides: "GetUserTransactionsParams + getUserTransactions function"
      contains: "getUserTransactions"
    - path: "server/services/admin-users/timeline.ts"
      provides: "UserTimelineEvent type + getUserTimeline function"
      contains: "getUserTimeline"
    - path: "server/services/admin-users.service.ts"
      provides: "Re-export index preserving all existing import paths"
      contains: "export.*from.*admin-users/"
    - path: "server/services/trend-calculator/calculate-trend.ts"
      provides: "TrendCalculationParams + TrendWithMetadata types + calculateTrend function"
      contains: "calculateTrend"
    - path: "server/services/trend-calculator/forecast-filters.ts"
      provides: "applyForecastFilters function — per-day filter application loop (recurring, planned, budgets)"
      contains: "applyForecastFilters"
    - path: "server/services/trend-calculator/forecast-processor.ts"
      provides: "generateAndProcessForecast orchestration function"
      contains: "generateAndProcessForecast"
    - path: "server/services/trend-calculator.service.ts"
      provides: "Re-export index preserving existing import paths"
      contains: "export.*from.*trend-calculator/"
  key_links:
    - from: "server/services/__tests__/admin-users.service.test.ts"
      to: "server/services/admin-users.service.ts"
      via: "import from ../admin-users.service"
      pattern: "from.*admin-users.service"
    - from: "server/routes/analytics.routes.ts"
      to: "server/services/trend-calculator.service.ts"
      via: "import calculateTrend"
      pattern: "import.*calculateTrend.*from.*trend-calculator.service"
    - from: "server/services/admin-users/details.ts"
      to: "server/lib/logger.ts"
      via: "logError import (logDebug removed)"
      pattern: "import.*logError.*from.*logger"
    - from: "server/services/trend-calculator/forecast-processor.ts"
      to: "server/services/trend-calculator/forecast-filters.ts"
      via: "import applyForecastFilters"
      pattern: "import.*applyForecastFilters.*from.*forecast-filters"
    - from: "server/services/trend-calculator/calculate-trend.ts"
      to: "server/services/trend-calculator/forecast-processor.ts"
      via: "import generateAndProcessForecast"
      pattern: "import.*generateAndProcessForecast.*from.*forecast-processor"
---

<objective>
Split `admin-users.service.ts` (570 LOC) and `trend-calculator.service.ts` (551 LOC) into sub-modules under 200 LOC each. Remove all debug logging from getUserDetails during the split.

Purpose: Bring the remaining two oversized service files under the project LOC limit (200 LOC per ROADMAP success criteria), eliminate excessive debug logging that clutters production logs, and preserve all existing test and import compatibility.
Output: 4 sub-modules for admin-users + index (debug-free), 3 sub-modules for trend-calculator + index.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality/03-RESEARCH.md

@server/services/admin-users.service.ts
@server/services/__tests__/admin-users.service.test.ts
@server/services/trend-calculator.service.ts
@server/routes/analytics.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split admin-users.service.ts with debug log removal</name>
  <files>
    server/services/admin-users/list.ts
    server/services/admin-users/details.ts
    server/services/admin-users/transactions.ts
    server/services/admin-users/timeline.ts
    server/services/admin-users.service.ts
  </files>
  <action>
Read `server/services/admin-users.service.ts` fully. Identify the 4 exported function groups per research:
1. `getUsersList` + `GetUsersListParams` + `UsersListResult` types
2. `getUserDetails` + `UserDetails` type
3. `getUserTransactions` + `GetUserTransactionsParams` + `UserTransactionsResult` types
4. `getUserTimeline` + `UserTimelineEvent` type

Create directory `server/services/admin-users/`.

Extract `list.ts` (~175 LOC — contains large Drizzle query builder with SQL subqueries, cannot be split further without harming readability; under 200 LOC per ROADMAP success criteria):
- Move `GetUsersListParams` type, `UsersListResult` type, and `getUsersList()` function
- Keep all DB/repository imports this function needs

Extract `details.ts` (~155 LOC after debug log removal — contains 7 sequential DB queries + credits lookup; under 200 LOC per ROADMAP success criteria):
- Move `UserDetails` type and `getUserDetails()` function
- **QUAL-07: Remove ALL `logDebug` calls** from `getUserDetails`. There are 13 `logDebug` calls at lines 220-356 with `[DEBUG]` prefix. Remove every one.
- Keep `logError` calls -- those are for actual errors, not debug noise
- If `logDebug` is no longer imported by any function in this file, remove `logDebug` from the import statement (keep `logError` and any other logger imports)
- The credits calculation try/catch block should keep `logError` for the catch path but remove the surrounding `logDebug` statements

Extract `transactions.ts` (~100 LOC):
- Move `GetUserTransactionsParams` type, `UserTransactionsResult` type, and `getUserTransactions()` function

Extract `timeline.ts` (~90 LOC):
- Move `UserTimelineEvent` type and `getUserTimeline()` function

Replace `admin-users.service.ts` with re-export index (~20 LOC):
```typescript
export type { GetUsersListParams, UsersListResult } from './admin-users/list';
export { getUsersList } from './admin-users/list';
export type { UserDetails } from './admin-users/details';
export { getUserDetails } from './admin-users/details';
export type { GetUserTransactionsParams, UserTransactionsResult } from './admin-users/transactions';
export { getUserTransactions } from './admin-users/transactions';
export type { UserTimelineEvent } from './admin-users/timeline';
export { getUserTimeline } from './admin-users/timeline';
```

Verify re-exports cover ALL named exports from the test file:
```
server/services/__tests__/admin-users.service.test.ts:21:} from '../admin-users.service';
```
Every name imported by the test must be in the re-export index.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass.
Run `wc -l server/services/admin-users.service.ts server/services/admin-users/*.ts` -- index under 30 LOC, each sub-module under 200 LOC.
Run `grep -n 'logDebug' server/services/admin-users/details.ts` -- must return empty (all debug logs removed).
Run `npx vitest run server/services/__tests__/admin-users.service.test.ts --reporter=verbose 2>&1 | tail -20` -- all tests pass.
  </verify>
  <done>`admin-users.service.ts` split into 4 sub-modules + re-export index. All sub-modules under 200 LOC. All `logDebug` calls removed from `getUserDetails`. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Split trend-calculator.service.ts into 3 sub-modules</name>
  <files>
    server/services/trend-calculator/calculate-trend.ts
    server/services/trend-calculator/forecast-filters.ts
    server/services/trend-calculator/forecast-processor.ts
    server/services/trend-calculator.service.ts
  </files>
  <action>
Read `server/services/trend-calculator.service.ts` fully.

This file has 2 major functions: `calculateTrend` (lines 75-213, ~139 LOC) and `generateAndProcessForecast` (lines 219-550, ~332 LOC). The forecast function is too large for a single sub-module. Split into 3 sub-modules.

Create directory `server/services/trend-calculator/`.

Extract `calculate-trend.ts` (~148 LOC):
- Move all imports needed by calculateTrend (storage, PlannedIncome, generateForecast, makeCumulative, calculateHistoricalData, makeCumulativeFromBase, TrendDataPoint, assetsRepository, assetValueCalculator, liabilityCalculator, logWarning, logError)
- Move `TrendDataPoint` re-export
- Move `TrendWithMetadata` interface (lines 36-43)
- Move `TrendCalculationParams` interface (lines 48-63)
- Move `calculateTrend()` function (lines 75-213)
- Import `generateAndProcessForecast` from `./forecast-processor` (one-directional dependency, no circular import)

Extract `forecast-filters.ts` (~140 LOC):
- This is the per-day filter application loop extracted from `generateAndProcessForecast` lines 340-443 (the `result.forecast.map((f) => { ... })` callback body)
- Create an exported function `applyForecastFilters` that accepts:
  - `forecast`: the raw forecast array from `generateForecast`
  - `activeRecurring`: pre-fetched recurring data
  - `activePlanned`: pre-fetched planned expenses
  - `plannedIncomeData`: pre-fetched planned income
  - `budgetsData`: pre-fetched budgets
  - Filter flags: `includeRecurringIncome`, `includeRecurringExpense`, `includePlannedIncome`, `includePlannedExpenses`, `includeBudgetLimits`
- Move the entire per-day mapping logic into this function: budget limits application (switch on period), recurring income/expense matching (monthly/weekly/daily), planned expenses matching, planned income matching
- Return the mapped array with `{ date, income, expense, capital: 0, assetsNet: 0, isToday: false, isForecast: true }`
- Also export a `ForecastFilterData` interface for the pre-fetched data parameter shape

Extract `forecast-processor.ts` (~100 LOC after filter extraction):
- Move `generateAndProcessForecast()` function
- Import `applyForecastFilters` from `./forecast-filters`
- The function keeps: parameter destructuring, early return for forecastDays===0, the `generateForecast` call, pre-fetching data from storage (recurring, planned, budgets), calling `applyForecastFilters` with pre-fetched data, the cumulative conversion + asset value calculation loop, error handling/fallback
- The large `result.forecast.map(...)` body is now just a call to `applyForecastFilters(...)` (~1 line vs ~100 lines)
- Use `import type { TrendDataPoint } from './calculate-trend'` for return type — the `type` keyword ensures TypeScript erases this import at compile time, preventing a circular module reference
- Import `makeCumulativeFromBase` from `../../lib/charts/historical-data-helpers`
- Import asset calculators for the cumulative asset value loop

Replace `trend-calculator.service.ts` with re-export index (~15 LOC):
```typescript
export type { TrendDataPoint } from './trend-calculator/calculate-trend';
export type { TrendCalculationParams, TrendWithMetadata } from './trend-calculator/calculate-trend';
export { calculateTrend } from './trend-calculator/calculate-trend';
export { generateAndProcessForecast } from './trend-calculator/forecast-processor';
```

Verify re-exports cover the `calculateTrend` import used by `server/routes/analytics.routes.ts`:
```
import { calculateTrend } from "../services/trend-calculator.service";
```
This import path must resolve after the split.

Dependency direction (NO circular imports):
- `calculate-trend.ts` imports from `forecast-processor.ts` (calls generateAndProcessForecast)
- `forecast-processor.ts` imports from `forecast-filters.ts` (calls applyForecastFilters)
- `forecast-processor.ts` imports TrendDataPoint type from `calculate-trend.ts` (type-only import OK, not circular at runtime)
- `forecast-filters.ts` imports nothing from sibling modules (leaf dependency)
  </action>
  <verify>
Run `tsc --noEmit` -- must pass.
Run `wc -l server/services/trend-calculator.service.ts server/services/trend-calculator/*.ts` -- index under 30 LOC, each sub-module under 150 LOC.
Run `npx vitest run --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|Tests)" | tail -10` -- no test regressions across the full suite.
  </verify>
  <done>`trend-calculator.service.ts` split into 3 sub-modules + re-export index. All sub-modules under 150 LOC. `calculateTrend` import from `analytics.routes.ts` still resolves. All tests pass.</done>
</task>

</tasks>

<verification>
1. `wc -l server/services/admin-users.service.ts server/services/trend-calculator.service.ts` -- both under 30 LOC
2. `wc -l server/services/admin-users/*.ts` -- all under 200 LOC
3. `wc -l server/services/trend-calculator/*.ts` -- all under 150 LOC
4. `grep -rn 'logDebug' server/services/admin-users/` -- returns empty (no debug logging)
5. `npx vitest run server/services/__tests__/admin-users.service.test.ts` -- passes
6. `tsc --noEmit` -- passes
7. `grep 'calculateTrend' server/routes/analytics.routes.ts` -- import still present and resolves
</verification>

<success_criteria>
- admin-users.service.ts: 570 LOC -> re-export index under 30 LOC + 4 sub-modules each under 200 LOC
- All 13 logDebug calls removed from getUserDetails (QUAL-07)
- trend-calculator.service.ts: 551 LOC -> re-export index under 30 LOC + 3 sub-modules each under 150 LOC
- All existing tests pass without modification
- analytics.routes.ts calculateTrend import resolves
- TypeScript compilation passes
- No circular imports between sub-modules
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality/03-04-SUMMARY.md`
</output>
