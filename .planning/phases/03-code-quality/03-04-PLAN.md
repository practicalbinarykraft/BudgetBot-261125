---
phase: 03-code-quality
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/admin-users.service.ts
  - server/services/admin-users/list.ts
  - server/services/admin-users/details.ts
  - server/services/admin-users/transactions.ts
  - server/services/admin-users/timeline.ts
  - server/services/trend-calculator.service.ts
  - server/services/trend-calculator/calculate-trend.ts
  - server/services/trend-calculator/forecast-processor.ts
autonomous: true
requirements:
  - QUAL-04
  - QUAL-06
  - QUAL-07

must_haves:
  truths:
    - "admin-users.service.ts is under 30 LOC (re-export index only)"
    - "Each sub-module in admin-users/ is under 150 LOC"
    - "All debug logDebug calls removed from getUserDetails (was lines 220-357)"
    - "trend-calculator.service.ts is under 30 LOC (re-export index only)"
    - "Each sub-module in trend-calculator/ is under 150 LOC"
    - "All existing tests pass for both services without modification"
    - "analytics.routes.ts still imports calculateTrend successfully"
  artifacts:
    - path: "server/services/admin-users/list.ts"
      provides: "GetUsersListParams type + getUsersList function"
      contains: "getUsersList"
    - path: "server/services/admin-users/details.ts"
      provides: "UserDetails type + getUserDetails function (debug logs removed)"
      contains: "getUserDetails"
    - path: "server/services/admin-users/transactions.ts"
      provides: "GetUserTransactionsParams + getUserTransactions function"
      contains: "getUserTransactions"
    - path: "server/services/admin-users/timeline.ts"
      provides: "UserTimelineEvent type + getUserTimeline function"
      contains: "getUserTimeline"
    - path: "server/services/admin-users.service.ts"
      provides: "Re-export index preserving all existing import paths"
      contains: "export.*from.*admin-users/"
    - path: "server/services/trend-calculator/calculate-trend.ts"
      provides: "TrendCalculationParams + TrendWithMetadata types + calculateTrend function"
      contains: "calculateTrend"
    - path: "server/services/trend-calculator/forecast-processor.ts"
      provides: "generateAndProcessForecast + helper types"
      contains: "generateAndProcessForecast"
    - path: "server/services/trend-calculator.service.ts"
      provides: "Re-export index preserving existing import paths"
      contains: "export.*from.*trend-calculator/"
  key_links:
    - from: "server/services/__tests__/admin-users.service.test.ts"
      to: "server/services/admin-users.service.ts"
      via: "import from ../admin-users.service"
      pattern: "from.*admin-users.service"
    - from: "server/routes/analytics.routes.ts"
      to: "server/services/trend-calculator.service.ts"
      via: "import calculateTrend"
      pattern: "import.*calculateTrend.*from.*trend-calculator.service"
    - from: "server/services/admin-users/details.ts"
      to: "server/lib/logger.ts"
      via: "logError import (logDebug removed)"
      pattern: "import.*logError.*from.*logger"
---

<objective>
Split `admin-users.service.ts` (570 LOC) and `trend-calculator.service.ts` (551 LOC) into sub-modules under 150 LOC each. Remove all debug logging from getUserDetails during the split.

Purpose: Bring the remaining two oversized service files under the <150 LOC rule, eliminate excessive debug logging that clutters production logs, and preserve all existing test and import compatibility.
Output: 4 sub-modules for admin-users + index (debug-free), 2 sub-modules for trend-calculator + index.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality/03-RESEARCH.md

@server/services/admin-users.service.ts
@server/services/__tests__/admin-users.service.test.ts
@server/services/trend-calculator.service.ts
@server/routes/analytics.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split admin-users.service.ts with debug log removal</name>
  <files>
    server/services/admin-users/list.ts
    server/services/admin-users/details.ts
    server/services/admin-users/transactions.ts
    server/services/admin-users/timeline.ts
    server/services/admin-users.service.ts
  </files>
  <action>
Read `server/services/admin-users.service.ts` fully. Identify the 4 exported function groups per research:
1. `getUsersList` + `GetUsersListParams` type
2. `getUserDetails` + `UserDetails` type
3. `getUserTransactions` + `GetUserTransactionsParams` type
4. `getUserTimeline` + `UserTimelineEvent` type

Create directory `server/services/admin-users/`.

Extract `list.ts`:
- Move `GetUsersListParams` type and `getUsersList()` function
- Keep all DB/repository imports this function needs

Extract `details.ts`:
- Move `UserDetails` type and `getUserDetails()` function
- **QUAL-07: Remove ALL `logDebug` calls** from `getUserDetails`. Per research, there are 13 `logDebug` calls at lines 220-356 with `[DEBUG]` prefix. Remove every one.
- Keep `logError` calls -- those are for actual errors, not debug noise
- If `logDebug` is no longer imported by any function in this file, remove `logDebug` from the import statement (keep `logError` and any other logger imports)
- The credits calculation try/catch block should keep `logError` for the catch path but remove the surrounding `logDebug` statements

Extract `transactions.ts`:
- Move `GetUserTransactionsParams` type and `getUserTransactions()` function

Extract `timeline.ts`:
- Move `UserTimelineEvent` type and `getUserTimeline()` function

Replace `admin-users.service.ts` with re-export index (~20 LOC):
```typescript
export type { GetUsersListParams } from './admin-users/list';
export { getUsersList } from './admin-users/list';
export type { UserDetails } from './admin-users/details';
export { getUserDetails } from './admin-users/details';
export type { GetUserTransactionsParams } from './admin-users/transactions';
export { getUserTransactions } from './admin-users/transactions';
export type { UserTimelineEvent } from './admin-users/timeline';
export { getUserTimeline } from './admin-users/timeline';
```

Verify re-exports cover ALL named exports from the test file:
```
server/services/__tests__/admin-users.service.test.ts:21:} from '../admin-users.service';
```
Every name imported by the test must be in the re-export index.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass.
Run `wc -l server/services/admin-users.service.ts server/services/admin-users/*.ts` -- index under 30 LOC, each sub-module under 150 LOC.
Run `grep -n 'logDebug' server/services/admin-users/details.ts` -- must return empty (all debug logs removed).
Run `npx vitest run server/services/__tests__/admin-users.service.test.ts --reporter=verbose 2>&1 | tail -20` -- all tests pass.
  </verify>
  <done>`admin-users.service.ts` split into 4 sub-modules + re-export index. All under 150 LOC. All `logDebug` calls removed from `getUserDetails`. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Split trend-calculator.service.ts into sub-modules</name>
  <files>
    server/services/trend-calculator/calculate-trend.ts
    server/services/trend-calculator/forecast-processor.ts
    server/services/trend-calculator.service.ts
  </files>
  <action>
Read `server/services/trend-calculator.service.ts` fully.

Per research: This file has 2 major functions that share internal dependencies. Careful dependency extraction is needed to avoid circular imports.

Create directory `server/services/trend-calculator/`.

Identify shared internal types/helpers:
- If there are shared helper functions or types used by both `calculateTrend` and `generateAndProcessForecast`, extract them into the same file as the more dependent function, OR into `calculate-trend.ts` (since it's the primary function).
- Do NOT create a separate `helpers.ts` unless there are genuinely shared utilities used by both -- prefer keeping helpers co-located with the primary consumer.

Extract `calculate-trend.ts` (~150 LOC):
- Move `TrendCalculationParams` type
- Move `TrendWithMetadata` type (or whatever the return type is)
- Move `calculateTrend()` function
- Move any helper functions it depends on
- Import DB/repository dependencies as needed

Extract `forecast-processor.ts` (~150 LOC):
- Move `generateAndProcessForecast()` function and its types
- If it depends on types from `calculate-trend.ts`, import them (one-directional dependency is OK; circular is NOT)
- Move any forecast-specific helper functions

Replace `trend-calculator.service.ts` with re-export index (~15 LOC):
```typescript
export type { TrendCalculationParams, TrendWithMetadata } from './trend-calculator/calculate-trend';
export { calculateTrend } from './trend-calculator/calculate-trend';
export { generateAndProcessForecast } from './trend-calculator/forecast-processor';
// ... any other exports
```

Verify re-exports cover the `calculateTrend` import used by `server/routes/analytics.routes.ts`:
```
import { calculateTrend } from "../services/trend-calculator.service";
```
This import path must resolve after the split.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass.
Run `wc -l server/services/trend-calculator.service.ts server/services/trend-calculator/*.ts` -- index under 30 LOC, each sub-module under 150 LOC.
Run `npx vitest run --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|Tests)" | tail -10` -- no test regressions across the full suite.
  </verify>
  <done>`trend-calculator.service.ts` split into 2 sub-modules + re-export index. All under 150 LOC. `calculateTrend` import from `analytics.routes.ts` still resolves. All tests pass.</done>
</task>

</tasks>

<verification>
1. `wc -l server/services/admin-users.service.ts server/services/trend-calculator.service.ts` -- both under 30 LOC
2. `wc -l server/services/admin-users/*.ts server/services/trend-calculator/*.ts` -- all under 150 LOC
3. `grep -rn 'logDebug' server/services/admin-users/` -- returns empty (no debug logging)
4. `npx vitest run server/services/__tests__/admin-users.service.test.ts` -- passes
5. `tsc --noEmit` -- passes
6. `grep 'calculateTrend' server/routes/analytics.routes.ts` -- import still present and resolves
</verification>

<success_criteria>
- admin-users.service.ts: 570 LOC -> re-export index under 30 LOC + 4 sub-modules each under 150 LOC
- All 13 logDebug calls removed from getUserDetails (QUAL-07)
- trend-calculator.service.ts: 551 LOC -> re-export index under 30 LOC + 2 sub-modules each under 150 LOC
- All existing tests pass without modification
- analytics.routes.ts calculateTrend import resolves
- TypeScript compilation passes
- No circular imports between sub-modules
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality/03-04-SUMMARY.md`
</output>
