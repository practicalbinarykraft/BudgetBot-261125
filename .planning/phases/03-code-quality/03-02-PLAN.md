---
phase: 03-code-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/admin-metrics.service.ts
  - server/services/admin-metrics/cache.ts
  - server/services/admin-metrics/hero-metrics.ts
  - server/services/admin-metrics/growth-metrics.ts
  - server/services/admin-metrics/revenue-metrics.ts
autonomous: true
requirements:
  - QUAL-02

must_haves:
  truths:
    - "admin-metrics.service.ts is under 30 LOC (re-export index only)"
    - "Each sub-module in admin-metrics/ is under 150 LOC"
    - "All existing admin-metrics tests pass without modification"
    - "All existing imports of admin-metrics.service resolve correctly"
  artifacts:
    - path: "server/services/admin-metrics/cache.ts"
      provides: "Shared in-memory cache Map + getCached helper + clearMetricsCache"
      contains: "clearMetricsCache"
    - path: "server/services/admin-metrics/hero-metrics.ts"
      provides: "HeroMetrics type + getHeroMetrics function"
      contains: "getHeroMetrics"
    - path: "server/services/admin-metrics/growth-metrics.ts"
      provides: "GrowthMetrics type + getGrowthMetrics function"
      contains: "getGrowthMetrics"
    - path: "server/services/admin-metrics/revenue-metrics.ts"
      provides: "RevenueMetrics + CohortRetentionData types + getRevenueMetrics + getCohortRetention"
      contains: "getRevenueMetrics"
    - path: "server/services/admin-metrics.service.ts"
      provides: "Re-export index preserving all existing import paths"
      contains: "export.*from.*admin-metrics/"
  key_links:
    - from: "server/services/admin-metrics/hero-metrics.ts"
      to: "server/services/admin-metrics/cache.ts"
      via: "import getCached"
      pattern: "from.*cache"
    - from: "server/services/admin-metrics.service.ts"
      to: "server/services/admin-metrics/"
      via: "re-export all public API"
      pattern: "export.*from.*admin-metrics/"
    - from: "server/services/__tests__/admin-metrics.service.test.ts"
      to: "server/services/admin-metrics.service.ts"
      via: "import from ../admin-metrics.service"
      pattern: "from.*admin-metrics.service"
---

<objective>
Split `admin-metrics.service.ts` (772 LOC) into 4 sub-modules under 150 LOC each, using the index re-export pattern.

Purpose: Comply with the project's <150 LOC rule while preserving all existing imports and test compatibility.
Output: 4 focused sub-modules + re-export index. Zero consumer changes needed.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality/03-RESEARCH.md

@server/services/admin-metrics.service.ts
@server/services/__tests__/admin-metrics.service.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract cache, hero-metrics, and growth-metrics sub-modules</name>
  <files>
    server/services/admin-metrics/cache.ts
    server/services/admin-metrics/hero-metrics.ts
    server/services/admin-metrics/growth-metrics.ts
  </files>
  <action>
Read `server/services/admin-metrics.service.ts` fully to understand its structure.

Create directory `server/services/admin-metrics/`.

Extract `cache.ts` (~40 LOC):
- Move the in-memory `cache` Map declaration
- Move the `getCached<T>` helper function
- Move the `clearMetricsCache()` function
- Export all three: `cache` (the Map), `getCached`, `clearMetricsCache`
- This is the CRITICAL shared state -- all metric sub-modules MUST import from this single cache module (per research pitfall #5: if each sub-module creates its own cache, clearMetricsCache only clears one)

Extract `hero-metrics.ts` (~120 LOC):
- Move the `HeroMetrics` interface/type
- Move the `getHeroMetrics()` function
- Import `getCached` from `./cache`
- Import any DB/repository dependencies the function needs
- Keep all existing imports (drizzle, schema, db) that this function uses

Extract `growth-metrics.ts` (~100 LOC):
- Move the `GrowthMetrics` interface/type
- Move the `getGrowthMetrics()` function
- Import `getCached` from `./cache`
- Import any DB/repository dependencies needed

Ensure NO circular imports: sub-modules import from `./cache` and external deps only, never from each other.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass (even though admin-metrics.service.ts is temporarily incomplete, the extracted modules should compile independently).
Run `wc -l server/services/admin-metrics/cache.ts server/services/admin-metrics/hero-metrics.ts server/services/admin-metrics/growth-metrics.ts` -- each must be under 150 lines.
  </verify>
  <done>Three sub-modules created under `server/services/admin-metrics/`, each under 150 LOC, sharing the single cache instance from `cache.ts`.</done>
</task>

<task type="auto">
  <name>Task 2: Extract revenue-metrics and create re-export index</name>
  <files>
    server/services/admin-metrics/revenue-metrics.ts
    server/services/admin-metrics.service.ts
  </files>
  <action>
Extract `revenue-metrics.ts` (~140 LOC):
- Move `RevenueMetrics` and `CohortRetentionData` types
- Move `getRevenueMetrics()` and `getCohortRetention()` functions
- Import `getCached` from `./cache`
- Import DB/repository dependencies as needed

Replace the contents of `admin-metrics.service.ts` with a re-export index (~15-25 LOC):
```typescript
// Re-export index â€” preserves all existing import paths
export { clearMetricsCache } from './admin-metrics/cache';
export type { HeroMetrics } from './admin-metrics/hero-metrics';
export { getHeroMetrics } from './admin-metrics/hero-metrics';
export type { GrowthMetrics } from './admin-metrics/growth-metrics';
export { getGrowthMetrics } from './admin-metrics/growth-metrics';
export type { RevenueMetrics, CohortRetentionData } from './admin-metrics/revenue-metrics';
export { getRevenueMetrics, getCohortRetention } from './admin-metrics/revenue-metrics';
```

Verify the re-export covers ALL named exports that existed in the original file. Check the test file `server/services/__tests__/admin-metrics.service.test.ts` to confirm every import it uses is re-exported.

The test imports (from research):
```
} from '../admin-metrics.service';
```
All those names MUST be in the re-export index.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass with 0 errors.
Run `wc -l server/services/admin-metrics.service.ts server/services/admin-metrics/revenue-metrics.ts` -- index under 30 LOC, revenue-metrics under 150 LOC.
Run `npx vitest run server/services/__tests__/admin-metrics.service.test.ts --reporter=verbose 2>&1 | tail -20` -- all existing tests must pass without any test file modifications.
  </verify>
  <done>`admin-metrics.service.ts` is a re-export index under 30 LOC. All 4 sub-modules are under 150 LOC. All existing tests pass without modification. `tsc --noEmit` passes.</done>
</task>

</tasks>

<verification>
1. `wc -l server/services/admin-metrics.service.ts` -- under 30 LOC (re-export index)
2. `wc -l server/services/admin-metrics/*.ts` -- each file under 150 LOC
3. `npx vitest run server/services/__tests__/admin-metrics.service.test.ts` -- all tests pass
4. `tsc --noEmit` -- passes with 0 errors
5. No file in `server/services/admin-metrics/` imports from another sub-module (only from `./cache` or external)
</verification>

<success_criteria>
- Original 772-LOC file split into 4 sub-modules + re-export index
- Every sub-module under 150 LOC
- Re-export index under 30 LOC
- All existing tests pass without modification
- No circular imports between sub-modules
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality/03-02-SUMMARY.md`
</output>
