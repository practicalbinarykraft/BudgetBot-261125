---
phase: 03-code-quality
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routes/auth-telegram.routes.ts
  - server/routes/auth-telegram/helpers.ts
  - server/routes/auth-telegram/login.ts
  - server/routes/auth-telegram/link.ts
  - server/routes/transactions.routes.ts
  - server/routes/transactions/validation.ts
  - server/routes/transactions/list.ts
  - server/routes/transactions/mutate.ts
autonomous: true
requirements:
  - QUAL-03
  - QUAL-05

must_haves:
  truths:
    - "auth-telegram.routes.ts is under 50 LOC (router index with mounts)"
    - "Each sub-module in auth-telegram/ is under 150 LOC"
    - "transactions.routes.ts is under 50 LOC (router index with mounts)"
    - "Each sub-module in transactions/ is under 150 LOC"
    - "All existing route tests pass without modification"
    - "insertTransactionInputSchema is still importable from transactions.routes"
  artifacts:
    - path: "server/routes/auth-telegram/helpers.ts"
      provides: "verifyTelegramAuth + isAuthDataFresh + TelegramAuthData type"
      contains: "verifyTelegramAuth"
    - path: "server/routes/auth-telegram/login.ts"
      provides: "POST /telegram handler"
      contains: "handleTelegramLogin"
    - path: "server/routes/auth-telegram/link.ts"
      provides: "POST /link-telegram + POST /unlink-telegram handlers"
      contains: "handleLinkTelegram"
    - path: "server/routes/auth-telegram.routes.ts"
      provides: "Router index mounting sub-handlers, re-exporting helpers + types"
      contains: "export default router"
    - path: "server/routes/transactions/validation.ts"
      provides: "insertTransactionInputSchema + date/filter parsing helpers"
      contains: "insertTransactionInputSchema"
    - path: "server/routes/transactions/list.ts"
      provides: "GET handler for transactions list"
      contains: "handleListTransactions"
    - path: "server/routes/transactions/mutate.ts"
      provides: "POST + PATCH + DELETE handlers"
      contains: "handleCreateTransaction"
    - path: "server/routes/transactions.routes.ts"
      provides: "Router index mounting handlers, re-exporting insertTransactionInputSchema"
      contains: "export.*insertTransactionInputSchema"
  key_links:
    - from: "server/routes/auth-telegram.routes.ts"
      to: "server/routes/auth-telegram/login.ts"
      via: "router.post mount"
      pattern: "router\\.post.*telegram.*handleTelegramLogin"
    - from: "server/routes/transactions.routes.ts"
      to: "server/routes/transactions/validation.ts"
      via: "re-export insertTransactionInputSchema"
      pattern: "export.*insertTransactionInputSchema.*from.*validation"
    - from: "server/routes/__tests__/transactions.routes.test.ts"
      to: "server/routes/transactions.routes.ts"
      via: "import insertTransactionInputSchema"
      pattern: "insertTransactionInputSchema.*from.*transactions.routes"
    - from: "server/auth.ts"
      to: "server/routes/auth-telegram.routes.ts"
      via: "import default router"
      pattern: "import authTelegramRouter from.*auth-telegram.routes"
---

<objective>
Split `auth-telegram.routes.ts` (601 LOC) and `transactions.routes.ts` (552 LOC) into sub-modules under 150 LOC each, using the router index pattern.

Purpose: Bring the two largest route files under the project's <150 LOC rule while preserving all existing imports, default router exports, and named exports like `insertTransactionInputSchema`.
Output: 3 sub-modules for auth-telegram + index, 3 sub-modules for transactions + index.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality/03-RESEARCH.md

@server/routes/auth-telegram.routes.ts
@server/routes/__tests__/auth-telegram.test.ts
@server/routes/transactions.routes.ts
@server/routes/__tests__/transactions.routes.test.ts
@server/auth.ts
@server/routes/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split auth-telegram.routes.ts into sub-modules</name>
  <files>
    server/routes/auth-telegram/helpers.ts
    server/routes/auth-telegram/login.ts
    server/routes/auth-telegram/link.ts
    server/routes/auth-telegram.routes.ts
  </files>
  <action>
Read `server/routes/auth-telegram.routes.ts` fully.

Create directory `server/routes/auth-telegram/`.

Extract `helpers.ts` (~80 LOC):
- Move `TelegramAuthData` interface
- Move `verifyTelegramAuth()` function
- Move `isAuthDataFresh()` function
- These are pure helper functions with no Express Router dependency

Extract `login.ts` (~120 LOC):
- Move the POST `/telegram` route handler logic into an exported function `handleTelegramLogin`
- The function should accept `(req: Request, res: Response)` and contain all the handler logic
- Import helpers from `./helpers`
- Import any service/repository/middleware dependencies the handler uses

Extract `link.ts` (~150 LOC):
- Move POST `/link-telegram` handler logic into `handleLinkTelegram`
- Move POST `/unlink-telegram` handler logic into `handleUnlinkTelegram`
- Both export as named functions accepting `(req: Request, res: Response)`
- Import helpers from `./helpers` if needed

Replace `auth-telegram.routes.ts` with a router index (~30-40 LOC):
```typescript
import { Router } from 'express';
import { handleTelegramLogin } from './auth-telegram/login';
import { handleLinkTelegram, handleUnlinkTelegram } from './auth-telegram/link';
// ... any middleware imports needed (withAuth, etc.)

const router = Router();

router.post('/telegram', handleTelegramLogin);
router.post('/link-telegram', /* middleware if needed, */ handleLinkTelegram);
router.post('/unlink-telegram', /* middleware if needed, */ handleUnlinkTelegram);

// Re-export helpers and types for existing consumers
export { verifyTelegramAuth, isAuthDataFresh } from './auth-telegram/helpers';
export type { TelegramAuthData } from './auth-telegram/helpers';

export default router;
```

CRITICAL: The default export MUST remain a fully-mounted Express Router (per research pitfall #2). Sub-files export handler functions, NOT routers. The index creates the router, mounts handlers, and exports it as default.

Check `server/auth.ts` and test files to confirm they import `authTelegramRouter` as default -- this must keep working.

Check test files for any named imports from `auth-telegram.routes` that must be re-exported.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass.
Run `wc -l server/routes/auth-telegram.routes.ts server/routes/auth-telegram/*.ts` -- index under 50 LOC, each sub-module under 150 LOC.
Run `npx vitest run server/routes/__tests__/auth-telegram.test.ts --reporter=verbose 2>&1 | tail -20` -- all tests pass.
  </verify>
  <done>`auth-telegram.routes.ts` split into 3 sub-modules + router index. All under 150 LOC. Default router export preserved. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Split transactions.routes.ts into sub-modules</name>
  <files>
    server/routes/transactions/validation.ts
    server/routes/transactions/list.ts
    server/routes/transactions/mutate.ts
    server/routes/transactions.routes.ts
  </files>
  <action>
Read `server/routes/transactions.routes.ts` fully.

CRITICAL DISCOVERY from research: This file has NO receipt or export routes. It has exactly 4 CRUD handlers (GET, POST, PATCH, DELETE) plus `insertTransactionInputSchema` export and date/filter parsing helpers. Split must follow actual file contents.

Create directory `server/routes/transactions/`.

Extract `validation.ts` (~80 LOC):
- Move `insertTransactionInputSchema` (Zod schema or equivalent)
- Move any date parsing helpers, filter parsing helpers
- Move any shared validation/transformation utilities used by multiple handlers
- Export `insertTransactionInputSchema` as named export (CRITICAL: test file imports this by name)

Extract `list.ts` (~140 LOC):
- Move GET `/` handler logic into `handleListTransactions(req, res)`
- Include swagger docs comments if present (they are part of the LOC count)
- Import validation helpers from `./validation` if needed

Extract `mutate.ts` (~150 LOC):
- Move POST `/` handler into `handleCreateTransaction(req, res)`
- Move PATCH `/:id` handler into `handleUpdateTransaction(req, res)`
- Move DELETE `/:id` handler into `handleDeleteTransaction(req, res)`
- Import `insertTransactionInputSchema` from `./validation` for POST validation

Replace `transactions.routes.ts` with router index (~30-40 LOC):
```typescript
import { Router } from 'express';
import { handleListTransactions } from './transactions/list';
import { handleCreateTransaction, handleUpdateTransaction, handleDeleteTransaction } from './transactions/mutate';
// ... middleware imports (withAuth, etc.)

const router = Router();

router.get('/', /* middleware, */ handleListTransactions);
router.post('/', /* middleware, */ handleCreateTransaction);
router.patch('/:id', /* middleware, */ handleUpdateTransaction);
router.delete('/:id', /* middleware, */ handleDeleteTransaction);

// CRITICAL: Re-export insertTransactionInputSchema for test compatibility
// (test file imports: `import { insertTransactionInputSchema } from '../transactions.routes'`)
export { insertTransactionInputSchema } from './transactions/validation';

export default router;
```

Per research pitfall #3: `transactions.routes.test.ts` line 56 imports `{ insertTransactionInputSchema }` from `'../transactions.routes'`. The re-export MUST include this or tests break with `SyntaxError: The requested module does not provide an export named 'insertTransactionInputSchema'`.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass.
Run `wc -l server/routes/transactions.routes.ts server/routes/transactions/*.ts` -- index under 50 LOC, each sub-module under 150 LOC.
Run `npx vitest run server/routes/__tests__/transactions.routes.test.ts --reporter=verbose 2>&1 | tail -20` -- all tests pass.
  </verify>
  <done>`transactions.routes.ts` split into 3 sub-modules + router index. All under 150 LOC. `insertTransactionInputSchema` re-exported. Default router export preserved. All existing tests pass.</done>
</task>

</tasks>

<verification>
1. `wc -l server/routes/auth-telegram.routes.ts server/routes/transactions.routes.ts` -- both under 50 LOC
2. `wc -l server/routes/auth-telegram/*.ts server/routes/transactions/*.ts` -- all under 150 LOC
3. `npx vitest run server/routes/__tests__/auth-telegram.test.ts server/routes/__tests__/transactions.routes.test.ts` -- all tests pass
4. `tsc --noEmit` -- passes
5. `grep 'insertTransactionInputSchema' server/routes/transactions.routes.ts` -- confirms re-export exists
</verification>

<success_criteria>
- auth-telegram.routes.ts: 601 LOC -> router index under 50 LOC + 3 sub-modules each under 150 LOC
- transactions.routes.ts: 552 LOC -> router index under 50 LOC + 3 sub-modules each under 150 LOC
- Default router exports preserved for both
- insertTransactionInputSchema re-exported from transactions index
- All existing tests pass without modification
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality/03-03-SUMMARY.md`
</output>
