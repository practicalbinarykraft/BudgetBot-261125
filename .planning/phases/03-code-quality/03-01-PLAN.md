---
phase: 03-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eslint.config.js
  - package.json
  - server/middleware/auth-utils.ts
  - server/middleware/mobile-auth.ts
autonomous: true
requirements:
  - QUAL-01
  - QUAL-08
  - QUAL-09

must_haves:
  truths:
    - "npx eslint server/ runs without config errors"
    - "npm audit --audit-level=high returns 0 critical/high vulnerabilities (or only known false positives)"
    - "No 'any' type casts remain in auth-utils.ts and mobile-auth.ts"
    - "tsc --noEmit passes after all changes"
  artifacts:
    - path: "eslint.config.js"
      provides: "ESLint 9 flat config with typescript-eslint and eslint-plugin-security"
      contains: "tseslint.config"
    - path: "server/middleware/auth-utils.ts"
      provides: "Typed Express middleware without any casts"
    - path: "server/middleware/mobile-auth.ts"
      provides: "Typed mobile auth middleware without any casts"
  key_links:
    - from: "eslint.config.js"
      to: "server/**/*.ts"
      via: "ESLint linting scope"
      pattern: "ignores.*client.*mobile"
    - from: "server/middleware/auth-utils.ts"
      to: "server/types/express.d.ts"
      via: "AppUser type import"
      pattern: "AppUser"
---

<objective>
Configure ESLint 9 flat config, fix npm audit vulnerabilities, and replace `any` types in auth middleware.

Purpose: Establish static analysis tooling, eliminate known security vulnerabilities, and improve type safety in authentication middleware.
Output: Working ESLint config, clean npm audit, typed auth middleware.
</objective>

<execution_context>
@/Users/aleksandrmishin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aleksandrmishin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality/03-RESEARCH.md

@server/middleware/auth-utils.ts
@server/middleware/mobile-auth.ts
@server/types/express.d.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ESLint 9 and create flat config</name>
  <files>eslint.config.js, package.json</files>
  <action>
Install ESLint 9 and related packages:
```bash
npm install --save-dev eslint @eslint/js typescript-eslint eslint-plugin-security
```

Create `eslint.config.js` in project root (project uses `"type": "module"` so `.js` extension works):
```javascript
import eslint from '@eslint/js';
import tseslint from 'typescript-eslint';
import pluginSecurity from 'eslint-plugin-security';

export default tseslint.config(
  { ignores: ['dist/**', 'node_modules/**', 'client/**', 'mobile/**', '**/*.js', '!eslint.config.js'] },
  eslint.configs.recommended,
  ...tseslint.configs.recommended,
  pluginSecurity.configs.recommended,
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'warn',
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_', varsIgnorePattern: '^_' }],
    },
  },
);
```

Key decisions per research:
- Lint only `server/` and `shared/` -- NOT `client/` (different tooling) or `mobile/`
- `pluginSecurity.configs.recommended` is the flat config export
- `@typescript-eslint/no-explicit-any` set to `warn` (not error) to allow documented exceptions during gradual migration
- Ignore all `.js` files EXCEPT `eslint.config.js` itself

After install, run `npx eslint server/ --max-warnings=9999` to get baseline warning count. Do NOT attempt to fix all warnings in this task -- just confirm the config loads and runs without config errors. Existing code will have warnings; that is expected.
  </action>
  <verify>
Run `npx eslint --version` to confirm ESLint installed.
Run `npx eslint eslint.config.js` to confirm config file is valid.
Run `npx eslint server/ --max-warnings=9999 2>&1 | tail -5` to confirm it runs against server code without config errors (warnings are OK).
  </verify>
  <done>ESLint 9 flat config exists at `eslint.config.js`, lints `server/` and `shared/` TypeScript files, uses typescript-eslint recommended + eslint-plugin-security recommended rules. `npx eslint server/` runs without config/parse errors.</done>
</task>

<task type="auto">
  <name>Task 2: Fix npm audit vulnerabilities</name>
  <files>package.json</files>
  <action>
Step 1: Run `npm audit fix` (safe, non-breaking fixes for axios, @sentry/node).

Step 2: Add overrides to `package.json` for transitive vulnerabilities that `npm audit fix` cannot resolve:
```json
"overrides": {
  "@radix-ui/react-context": "1.1.3",
  "@radix-ui/react-primitive": "2.1.4",
  "form-data": ">=2.5.4",
  "qs": ">=6.14.2"
}
```
Keep existing overrides (`@radix-ui/*`), add `form-data` and `qs` overrides to fix critical/high vulnerabilities in the `node-telegram-bot-api` dependency chain.

Step 3: Run `npm install` to apply overrides.

Step 4: Run `npm audit --audit-level=high` to verify. If any critical/high remain that are NOT false positives (e.g., `minimatch` in `swagger-jsdoc` is dev-only and not exploitable), document them.

Do NOT use `npm audit fix --force` -- it downgrades `node-telegram-bot-api` to 0.63.x which breaks Telegram bot functionality (per research pitfall #4).
  </action>
  <verify>
Run `npm audit --audit-level=high` -- should show 0 critical and 0 high, OR only known false positives (minimatch in swagger-jsdoc dev dependency).
Run `npx vitest run --reporter=verbose 2>&1 | tail -20` to confirm no test regressions from dependency changes.
  </verify>
  <done>`npm audit --audit-level=high` shows no critical or high vulnerabilities (excluding documented false positives). All existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 3: Replace any types in auth-utils.ts and mobile-auth.ts</name>
  <files>server/middleware/auth-utils.ts, server/middleware/mobile-auth.ts</files>
  <action>
Read both files first to understand current `any` usage.

In `auth-utils.ts`:
- Replace `any` generic params in Express handler type with `unknown` or specific types.
- Replace `(req as any).user = user` with a typed cast using the project's existing `AppUser` type from `server/types/express.d.ts`. Use pattern: `(req as Request & { user: typeof user }).user = user` or `Object.assign(req, { user })`.
- Keep the function signature generic enough that callers don't break -- the `withAuth` wrapper must accept any route handler.

In `mobile-auth.ts`:
- Same pattern: replace `(req as any).user` casts with typed alternatives.
- Replace `any` in function parameter types with `unknown` or specific Express types.
- For JWT decode result typing: use the project's existing user type or `JwtPayload` from jsonwebtoken.

Per research pitfall #6: Do NOT blindly replace `any` with `unknown` in assignment targets -- `unknown` cannot be assigned to. Use the existing `AppUser` type augmentation or precise type intersection casts.

After changes, run `tsc --noEmit` to confirm no new type errors introduced.
  </action>
  <verify>
Run `tsc --noEmit` -- must pass with 0 errors.
Run `grep -n 'as any\|: any' server/middleware/auth-utils.ts server/middleware/mobile-auth.ts` -- should return empty (no `any` remaining).
Run `npx vitest run server/middleware/__tests__/ --reporter=verbose 2>&1 | tail -20` -- existing middleware tests must pass.
  </verify>
  <done>Zero `any` types in `auth-utils.ts` and `mobile-auth.ts`. `tsc --noEmit` passes. All middleware tests pass.</done>
</task>

</tasks>

<verification>
1. `npx eslint server/ --max-warnings=9999` runs without config/parse errors
2. `npm audit --audit-level=high` shows no critical/high vulnerabilities
3. `grep -rn 'as any\|: any' server/middleware/auth-utils.ts server/middleware/mobile-auth.ts` returns empty
4. `tsc --noEmit` passes with 0 errors
5. `npx vitest run` -- no test regressions
</verification>

<success_criteria>
- ESLint 9 flat config installed and configured for server/ TypeScript
- npm audit clean at high severity level
- auth-utils.ts and mobile-auth.ts have zero `any` types
- TypeScript compilation passes
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality/03-01-SUMMARY.md`
</output>
