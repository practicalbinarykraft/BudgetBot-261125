# Price Tracking & Consumer Cooperative — Product Vision

## Концепция

BudgetBot эволюционирует из личного финансового менеджера в платформу коллективных закупок через потребительские кооперативы.

### Воронка продукта

```
BudgetBot (бесплатный учёт финансов)
    -> привлекает пользователей
    -> они сканируют чеки
    -> создаётся crowdsourced база цен
        -> пользователи находят дешёвые товары
        -> видят что в кооперативе дешевле (нет НДС 22%)
            -> вступают в кооператив
            -> бизнес получает клиентов
            -> BudgetBot получает SaaS подписку с бизнеса
```

### Ценность для участников

**Для пользователя:**
- Бесплатный учёт доходов/расходов
- Поиск дешёвых товаров (crowdsourced цены)
- Price alerts — уведомления о скидках
- Доступ к ценам кооператива (ниже рынка за счёт отсутствия НДС)

**Для бизнеса (кооператива):**
- Регулярные клиенты через платформу
- Оптимизация налогов (потребительское общество — нет НДС, нет налога на прибыль)
- Автоматизация документооборота (каждая сделка = 7 документов)
- Цифровое управление пайщиками

### Конкурентное преимущество правовой формы ПО

```
ООО продаёт товар за 1000 руб:
  - НДС 22% = 220 руб государству
  - Бизнесу остаётся 780 руб

Кооператив продаёт тот же товар за 780 руб:
  - НДС 0% (паевые взносы не облагаются)
  - Кооператив получает все 780 руб
  - Покупатель экономит 220 руб
```

Референсы: Costco (США, членский взнос $100/год), ПО "Океан" (Россия, po-ocean.coop).

---

## Архитектура

### Три продукта

```
+--------------------------------------------------+
|                    КЛИЕНТЫ                        |
|  Web (budgetbot.online)                           |
|  Mobile (m.budgetbot.online)                      |
|  Telegram Mini App                                |
|  Admin Panel (отдельный репо)                     |
+--------+-----------------+----------------+-------+
         |                 |                |
   +-----v------+   +-----v-------+  +-----v------+
   | BudgetBot  |   |    Price    |  |    Coop    |
   |   Core     |   | Intelligence|  |  Platform  |
   |   API      |   |   Service   |  |    SaaS    |
   |            |   |             |  |            |
   | - auth     |   | - product   |  | - members  |
   | - txns     |   |   matching  |  | - docs     |
   | - budgets  |   | - prices    |  | - orders   |
   | - OCR      |   | - alerts    |  | - catalog  |
   | - wallets  |   | - watchlist |  | - payments |
   +-----+------+   +------+------+  +-----+------+
         |                 |                |
         +-----------------+----------------+
                     +-----v------+
                     |   Shared   |
                     |     DB     |
                     | (Postgres) |
                     +------------+
```

### Распределение по серверам

| Сервис             | Фаза   | Сервер                                        |
|--------------------|--------|-----------------------------------------------|
| BudgetBot Core     | сейчас | текущий 5.129.230.171                         |
| Admin Panel        | сейчас | тот же сервер, другой порт за nginx           |
| Price Intelligence | фаза 2 | отдельный сервер (CPU-intensive вычисления)   |
| Coop Platform      | фаза 3 | отдельный сервер                              |

---

## Фазы реализации

### Фаза 1 — Price Tracking MVP (в текущем BudgetBot)

**Цель:** Watchlist товаров + уведомления о снижении цен.

**Что делать:**

1. **Product Watchlist**
   - Новая таблица `product_watchlist` (userId, productId, targetPrice?, createdAt)
   - UI кнопка "Отслеживать" в каталоге товаров
   - Экран "Мои отслеживаемые товары"

2. **Price Drop Detection**
   - При каждом сканировании чека: сравнить цены товаров с watchlist всех пользователей
   - Если цена упала на 15%+ от средней за 30 дней — триггер
   - Уведомление: "Молоко Простоквашино 89 руб -> 59 руб (-34%)"

3. **Нормализация товаров (AI Matching)**
   - При сканировании чека: DeepSeek/AI определяет соответствие товара из чека существующему в каталоге
   - Fuzzy matching по названию + категории + объёму/весу
   - "Молоко Просток." = "Молоко Простоквашино 930мл"

4. **Price History улучшения**
   - Хранить магазин (из header чека) вместе с ценой
   - График истории цен в карточке товара
   - Средняя цена по городу/магазину

**Не требует отдельного сервера.** Всё в текущем монолите.

**Оценка:** ~1-2 недели разработки.

### Фаза 2 — Price Intelligence Service (отдельный сервис)

**Триггер:** 500+ активных пользователей, база цен достаточно большая.

**Цель:** Выделить тяжёлые вычисления в отдельный сервис.

**Что делать:**

1. **Отдельный API сервер**
   - Node.js или Python (для ML задач)
   - Свой порт, свой процесс
   - BudgetBot шлёт данные при сканировании (webhook/queue)
   - Price Service шлёт алерты обратно

2. **Продвинутый matching**
   - ML модель для нормализации товаров
   - Кластеризация по товарным группам
   - Определение одинаковых товаров разных брендов

3. **Аналитика цен**
   - Средние цены по магазинам/городам
   - Сезонные паттерны ("молоко дешевеет каждую пятницу")
   - Предиктивные алерты ("скоро будет акция на X")

4. **Категорийные подписки**
   - "Уведомляй обо всех скидках на молочку"
   - "Покажи самые дешёвые магазины для моей корзины"

**Зачем отдельный сервис:** тяжёлые вычисления (fuzzy matching, агрегация по городам, ML) не должны тормозить основной API.

### Фаза 3 — Cooperative Platform SaaS (отдельный продукт)

**Триггер:** Есть ценовая база + юридическая экспертиза по ПО.

**Цель:** SaaS для потребительских кооперативов с интеграцией в BudgetBot.

**Что делать:**

1. **Управление пайщиками**
   - Регистрация, паевые взносы, членские взносы
   - Цифровые книжки пайщиков
   - Голосования, собрания

2. **Документооборот**
   - Автоматическая генерация 7 документов на каждую сделку
   - Шаблоны для типовых операций ПО
   - Интеграция с 1С/бухгалтерией

3. **Каталог и заказы**
   - Каталог товаров кооператива
   - Групповые закупки (набор минимальной партии)
   - История заказов и доставка

4. **Интеграция с BudgetBot**
   - Пользователи видят цены кооператива vs розница
   - Вступление в кооператив из приложения
   - Оплата паевых взносов

**Отдельный сервер, отдельный репо, отдельная БД.**

---

## Риски и как их митигировать

| Риск | Митигация |
|------|-----------|
| Нормализация товаров из разных чеков | AI matching (DeepSeek уже подключён), ручная модерация на старте |
| Мало пользователей = мало данных о ценах | Фокус на одном городе, партнёрство с 2-3 магазинами |
| Юридическая сложность ПО | Юрист в команде обязателен до начала Фазы 3 |
| Конкуренция по ценам между продавцами | Кооператив = не перепродажа, а коллективная закупка напрямую у производителя |
| Масштабирование базы цен | Отдельный сервис (Фаза 2) до того как нагрузка станет проблемой |

---

## Источники данных о ценах

### Канал 1: QR-код чеков (приоритет!)

В России каждый чек регистрируется в ФНС через ОФД. QR-код на чеке содержит параметры `fn`, `fp`, `fd`, по которым можно получить полный itemized чек через API налоговой.

- **API:** `proverkacheka.nalog.ru/api/v1/check/get`
- **Что получаем:** точное название товара, цена, количество, магазин (ИНН + адрес), дата/время
- **Преимущества перед OCR:**
  - Точнее (нет ошибок распознавания)
  - Дешевле (не тратим кредиты Anthropic на OCR)
  - Магазин + адрес идут бонусом (не нужно парсить header)
  - Стандартизированные названия товаров из кассовой системы
- **Легальность:** данные принадлежат пользователю, он сам запрашивает свой чек
- **Реализация:** пользователь фоткает QR → парсим параметры → запрос к ФНС → полные данные

### Канал 2: Парсинг онлайн-каталогов ритейлеров

| Источник | Тип | Покрытие | Приоритет |
|----------|-----|----------|-----------|
| СберМаркет (sbermarket.ru) | Веб-каталог | Агрегатор: Ашан, Метро, Лента, ВкусВилл и др. | **Высокий** — один парсер = десятки сетей |
| Яндекс.Лавка | Полу-публичный API | Москва, СПб, крупные города | Высокий |
| Перекрёсток (perekrestok.ru) | Онлайн-магазин | Полные цены, не только акции | Средний |
| Пятёрочка (5ka.ru) | Каталог акций | Крупнейшая сеть РФ | Средний |
| Магнит (magnit.ru) | Каталог акций | Вторая по размеру | Средний |
| ВкусВилл | API приложения | Полные цены | Средний |
| Лента (lenta.com) | Онлайн-магазин | Полные цены | Низкий (есть через СберМаркет) |

**СберМаркет — самый эффективный источник:** агрегирует множество сетей, один парсер покрывает десятки ритейлеров.

### Канал 3: Crowdsourced от пользователей (уже есть)

Текущий механизм: OCR чеков через Anthropic Claude. Улучшается каналом 1 (QR вместо OCR).

### Хранение данных

Новые таблицы в Postgres (Фаза 1, в текущей БД):

```sql
-- Цены от всех источников (чеки, парсеры, QR)
retail_prices (
  id              serial PRIMARY KEY,
  product_catalog_id  integer REFERENCES product_catalog(id),
  retailer        text NOT NULL,          -- 'pyaterochka', 'magnit', 'sbermarket'...
  store_address   text,                   -- адрес конкретной точки (из QR/чека)
  store_inn       text,                   -- ИНН магазина (из QR)
  price           numeric(10,2) NOT NULL,
  old_price       numeric(10,2),          -- зачёркнутая цена (если акция)
  is_promo        boolean DEFAULT false,
  source          text NOT NULL,          -- 'receipt_qr' | 'receipt_ocr' | 'web_scraper'
  scraped_at      timestamp DEFAULT now()
)

-- Задачи парсинга
price_scrape_jobs (
  id              serial PRIMARY KEY,
  retailer        text NOT NULL,
  category        text,                   -- 'молочное', 'мясо'...
  status          text DEFAULT 'pending', -- pending | running | done | failed
  items_scraped   integer DEFAULT 0,
  error_message   text,
  started_at      timestamp,
  finished_at     timestamp,
  created_at      timestamp DEFAULT now()
)
```

### Порядок подключения источников

**Шаг 1 — QR чеков (Фаза 1, вместе с watchlist)**
- Минимальная доработка к текущему receipt flow
- Пользователь выбирает: сфоткать чек (OCR) или QR-код (ФНС API)
- Точные данные + магазин + адрес бесплатно

**Шаг 2 — Парсер СберМаркет (Фаза 1-2)**
- Один scraper = цены десятков сетей
- Cron job раз в сутки по ключевым категориям
- Отдельный worker process (не блокирует основной API)

**Шаг 3 — Парсеры отдельных сетей (Фаза 2)**
- Пятёрочка/Магнит для акционных каталогов
- Только после валидации что crowdsourced + СберМаркет недостаточно

### Юридические аспекты парсинга

| Источник | Легальность |
|----------|-------------|
| QR чеков (ФНС API) | Полностью легально — данные самого пользователя |
| Публичные цены на сайтах | Серая зона, но цены = публичная оферта, не коммерческая тайна |
| API приложений ритейлеров | Зависит от ToS, но для личного использования допустимо |

**Правила безопасного парсинга:**
- Rate limiting (не больше 1 запроса/сек к одному домену)
- Уважать robots.txt
- Не хранить персональные данные третьих лиц
- Кэшировать результаты, не дёргать повторно

---

## Приоритеты (что делать прямо сейчас)

1. **QR-код чеков** — добавить как альтернативу OCR (дешевле, точнее, даёт магазин)
2. **Watchlist + price alerts** в текущем BudgetBot (~1-2 недели)
3. **Таблица retail_prices** — единое хранилище цен из всех источников
4. **Накапливать данные** — QR + OCR + позже парсеры
5. **Парсер СберМаркет** — один scraper = десятки сетей
6. **Изучить документооборот ПО** — юридическая часть нужна до начала Фазы 3
7. **Admin Panel на отдельный домен** — подготовка инфраструктуры

---

*Создан: 2026-02-27*
*Обновлён: 2026-03-01*
*Статус: Vision / Planning*
