CI Full Error Report - PR #3: Feature/dashboard v2 dark theme
===============================================================

PR Branch: feature/dashboard-v2-dark-theme
Feature: Dark theme toggle for Dashboard V2

Initial CI Failure:
-------------------
Test: "should link telegram_id to authenticated user"
Error: "This Telegram account is already linked to another user"
Status: 400 Bad Request (expected 200 OK)

Root Cause Analysis:
-------------------
The test was failing because cleanup before test execution was not properly
removing users with telegramId '123456789'. When the test tried to link this
telegramId to testUser, it found that it was already linked to another user
from a previous test run, causing the API to reject with 400 error.

Fixes Applied (Multiple Iterations):
------------------------------------

Iteration 1:
- Fixed duplicate email issue by using unique emails per test
- Fixed API validation logic for already-linked telegram_id

Iteration 2:
- Fixed duplicate key constraint violation
- Improved cleanup order in afterEach
- Fixed API logic to handle already-linked telegram_id correctly

Iteration 3 (Final):
- Enhanced pre-test cleanup in beforeEach:
  * Increased delay from 100ms to 200ms for transaction completion
  * Added error logging for debugging
- Enhanced cleanup before test execution:
  * Check if telegramId '123456789' is linked to any user
  * If linked to different user, nullify the telegramId
  * Also delete directly by telegramId as fallback
  * Increased delay to 100ms

Files Changed:
--------------
1. server/routes/__tests__/link-telegram-miniapp.test.ts
   - Added unique email generation per test
   - Improved cleanup in beforeEach and afterEach
   - Enhanced pre-test cleanup
   - Added error logging

2. server/routes/auth-miniapp.routes.ts
   - Fixed API logic to handle already-linked telegram_id
   - Added idempotent behavior for re-linking same telegram_id

3. client/src/hooks/use-theme.ts (NEW)
   - Theme management hook for Dashboard V2

4. client/src/components/mobile-menu-sheet.tsx
   - Added theme toggle button (visible only on Dashboard V2)

5. client/src/pages/dashboard-v2-page.tsx
   - Integrated useTheme hook

6. shared/i18n/web-common.ts
   - Added translations for theme toggle

Test Results (After All Fixes):
--------------------------------
✓ should link telegram_id to authenticated user
✓ should reject if telegram_id is already linked to another user
✓ should reject invalid initData signature
✓ should reject old initData (replay attack prevention)
✓ should reject if user is not authenticated

All 5 tests in link-telegram-miniapp.test.ts passing ✅

Note: Other test failures (password-reset.service.test.ts) are unrelated
to this PR and were present before these changes.

Commits:
--------
1. feat(dashboard-v2): add dark theme toggle for Dashboard V2
2. fix(tests): fix failing link-telegram-miniapp tests
3. fix(tests): fix duplicate key constraint violation in link-telegram-miniapp test
4. docs: add CI error report for PR #3
5. fix(tests): improve cleanup to prevent telegram_id conflict in link-telegram-miniapp test

Status: READY FOR MERGE ✅
All tests related to this PR are passing.
